





<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบคลังวัสดุ กลุ่มงานระบาดวิทยา</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, remove, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCvlZN9Iec4TIEHx_q9Bhlsy4TRhASC9Mk",
            authDomain: "stock-957f9.firebaseapp.com",
            databaseURL: "https://stock-957f9-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "stock-957f9",
            storageBucket: "stock-957f9.firebasestorage.app",
            messagingSenderId: "390625608165",
            appId: "1:390625608165:web:3c896ef98cf70dca232f0c",
            measurementId: "G-GQJNDRZ0NS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions available globally
        window.firebase = {
            database,
            ref,
            set,
            get,
            push,
            remove,
            onValue,
            off
        };
        
        // Initialize app after Firebase is ready
        window.addEventListener('load', () => {
            if (window.initApp) {
                window.initApp();
            }
    
            // Download template functions
            function downloadImportTemplate() {
                try {
                    console.log('Starting Excel template download...');
                    
                    // ตรวจสอบว่า XLSX library ถูกโหลดหรือไม่
                    if (typeof XLSX === 'undefined') {
                        console.error('XLSX library not found');
                        if (confirm('ไม่สามารถดาวน์โหลดไฟล์ Excel ได้\nต้องการดาวน์โหลดไฟล์ CSV แทนหรือไม่?')) {
                            downloadImportTemplateCSV();
                        }
                        return;
                    }
    
                    // สร้างข้อมูลตัวอย่างสำหรับไฟล์เทมเพลต
                    const templateData = [
                        {
                            'รหัสบาร์โค้ด': '1234567890123',
                            'กลุ่ม': 'สำนักงาน',
                            'หมวดหมู่': 'เครื่องเขียน',
                            'ชื่อวัสดุ': 'ปากกาลูกลื่น สีน้ำเงิน',
                            'จำนวน': 100,
                            'หน่วย': 'ด้าม',
                            'วันหมดอายุ': '2025-12-31'
                        },
                        {
                            'รหัสบาร์โค้ด': '9876543210987',
                            'กลุ่ม': 'การแพทย์',
                            'หมวดหมู่': 'อุปกรณ์การแพทย์',
                            'ชื่อวัสดุ': 'หน้ากากอนามัย',
                            'จำนวน': 500,
                            'หน่วย': 'ชิ้น',
                            'วันหมดอายุ': ''
                        },
                        {
                            'รหัสบาร์โค้ด': '5555666677778',
                            'กลุ่ม': '',
                            'หมวดหมู่': 'เวชภัณฑ์',
                            'ชื่อวัสดุ': 'แอลกอฮอล์ 70%',
                            'จำนวน': 50,
                            'หน่วย': 'ขวด',
                            'วันหมดอายุ': '2026-06-30'
                        }
                    ];
    
                    // สร้าง workbook และ worksheet
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(templateData);
    
                    // ตั้งค่าความกว้างคอลัมน์
                    const colWidths = [
                        { wch: 15 }, // รหัสบาร์โค้ด
                        { wch: 15 }, // กลุ่ม
                        { wch: 20 }, // หมวดหมู่
                        { wch: 30 }, // ชื่อวัสดุ
                        { wch: 10 }, // จำนวน
                        { wch: 10 }, // หน่วย
                        { wch: 15 }  // วันหมดอายุ
                    ];
                    ws['!cols'] = colWidths;
    
                    // เพิ่ม worksheet เข้า workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'ตัวอย่างข้อมูลสต๊อก');
    
                    // กำหนดชื่อไฟล์
                    const filename = 'ตัวอย่างไฟล์นำเข้าสต๊อก.xlsx';
    
                    // ลองใช้ XLSX.writeFile ก่อน
                    try {
                        XLSX.writeFile(wb, filename);
                        alert('ดาวน์โหลดไฟล์ตัวอย่าง Excel สำเร็จ!');
                    } catch (writeError) {
                        console.warn('XLSX.writeFile failed, trying blob method:', writeError);
                        
                        // ใช้วิธีการสำรอง: สร้าง blob และดาวน์โหลด
                        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                        const blob = new Blob([wbout], { type: 'application/octet-stream' });
                        
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        link.style.display = 'none';
                        
                        document.body.appendChild(link);
                        link.click();
                        
                        setTimeout(() => {
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }, 100);
                        
                        alert('ดาวน์โหลดไฟล์ตัวอย่าง Excel สำเร็จ!');
                    }
                    
                } catch (error) {
                    console.error('Error downloading Excel template:', error);
                    alert('เกิดข้อผิดพลาด: ' + error.message + '\nลองใช้ปุ่ม "ไฟล์ตัวอย่าง CSV" แทน');
                }
            }
    
            function downloadImportTemplateCSV() {
                try {
                    console.log('Starting CSV template download...');
                    
                    // สร้างข้อมูล CSV
                    const csvContent = [
                        'รหัสบาร์โค้ด,กลุ่ม,หมวดหมู่,ชื่อวัสดุ,จำนวน,หน่วย,วันหมดอายุ',
                        '1234567890123,สำนักงาน,เครื่องเขียน,ปากกาลูกลื่น สีน้ำเงิน,100,ด้าม,2025-12-31',
                        '9876543210987,การแพทย์,อุปกรณ์การแพทย์,หน้ากากอนามัย,500,ชิ้น,',
                        '5555666677778,,เวชภัณฑ์,แอลกอฮอล์ 70%,50,ขวด,2026-06-30'
                    ].join('\n');
    
                    // สร้าง blob และดาวน์โหลด (เพิ่ม BOM สำหรับ UTF-8)
                    const blob = new Blob(['\ufeff' + csvContent], { 
                        type: 'text/csv;charset=utf-8;' 
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'ตัวอย่างไฟล์นำเข้าสต๊อก.csv';
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    alert('ดาวน์โหลดไฟล์ตัวอย่าง CSV สำเร็จ!\n\nคำแนะนำ: หากต้องการนำเข้าในรูปแบบ Excel ให้เปิดไฟล์ CSV ใน Excel และบันทึกเป็น .xlsx');
                    
                } catch (error) {
                    console.error('Error downloading CSV template:', error);
                    alert('เกิดข้อผิดพลาดในการดาวน์โหลดไฟล์ CSV: ' + error.message);
                }
            }
    
            // Make functions globally available
            window.downloadImportTemplate = downloadImportTemplate;
            window.downloadImportTemplateCSV = downloadImportTemplateCSV;
    
            // Test functions availability
            console.log('Download functions registered:', {
                downloadImportTemplate: typeof window.downloadImportTemplate,
                downloadImportTemplateCSV: typeof window.downloadImportTemplateCSV,
                XLSX: typeof XLSX
            });
    
            // Add test function for debugging
            window.testDownload = function() {
                console.log('Testing download functions...');
                console.log('Excel function:', typeof downloadImportTemplate);
                console.log('CSV function:', typeof downloadImportTemplateCSV);
                console.log('XLSX library:', typeof XLSX);
                
                if (typeof XLSX !== 'undefined') {
                    console.log('XLSX version:', XLSX.version);
                }
                
                alert('ทดสอบ functions สำเร็จ! ตรวจสอบ console สำหรับรายละเอียด');
            };
        });
    </script>
    <style>
        * {
            font-family: 'Prompt', sans-serif;
        }
        
        .bg-primary { 
            background: linear-gradient(135deg, #065f46 0%, #047857 100%); 
        }
        .bg-primary-light { 
            background: linear-gradient(135deg, #047857 0%, #059669 100%); 
        }
        .text-primary { color: #065f46; }
        .border-primary { border-color: #065f46; }
        .hover-primary:hover { 
            background: linear-gradient(135deg, #047857 0%, #059669 100%); 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 95, 70, 0.3);
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(6, 95, 70, 0.1);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: translateY(0) scale(1);
        }
        
        .card:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            transform: translateY(-4px) scale(1.02);
            border-color: rgba(6, 95, 70, 0.2);
        }
        
        .btn {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-weight: 500;
            border-radius: 12px;
            padding: 12px 24px;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #047857 0%, #059669 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(6, 95, 70, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.3);
        }
        
        .input-field {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            font-family: 'Prompt', sans-serif;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #065f46;
            box-shadow: 0 0 0 3px rgba(6, 95, 70, 0.1);
        }
        
        .nav-gradient {
            background: linear-gradient(135deg, #065f46 0%, #047857 50%, #059669 100%);
        }
        
        .material-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #f3f4f6;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: translateY(0);
        }
        
        .material-card:hover {
            border-color: #065f46;
            box-shadow: 0 6px 20px rgba(6, 95, 70, 0.15);
            transform: translateY(-2px);
            background: linear-gradient(135deg, #ffffff 0%, #f8fffe 100%);
        }
        
        .status-pending {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
        
        .status-approved {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 4px solid #10b981;
        }
        
        .status-rejected {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 4px solid #ef4444;
        }
        
        .receipt-content { 
            background: white; 
            padding: 24px; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .dashboard-card {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            font-family: 'Prompt', sans-serif;
            font-weight: 500;
        }
        
        .dashboard-card:hover {
            background: linear-gradient(135deg, #047857 0%, #059669 100%);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(6, 95, 70, 0.3);
        }
        
        .table-modern {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .table-modern th {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: white;
            font-weight: 600;
            padding: 16px;
        }
        
        .table-modern td {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .table-modern tr:hover {
            background-color: #f9fafb;
        }
        
        .receipt-modal {
            font-family: 'Sarabun', sans-serif;
        }
        
        .receipt-paper {
            width: 148mm;
            min-height: 210mm;
            background: white;
            margin: 0 auto;
            padding: 15mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            font-family: 'Sarabun', sans-serif;
            font-size: 14px;
            line-height: 1.4;
            color: #000;
        }
        
        .receipt-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .receipt-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .receipt-subtitle {
            font-size: 14px;
            font-weight: 400;
            margin-bottom: 3px;
        }
        
        .receipt-section {
            margin-bottom: 15px;
        }
        
        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        .receipt-table th,
        .receipt-table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
            font-size: 13px;
        }
        
        .receipt-table th {
            background-color: #f5f5f5;
            font-weight: 600;
            text-align: center;
        }
        
        .receipt-table td:nth-child(1) {
            text-align: center;
            width: 8%;
        }
        
        .receipt-table td:nth-child(3),
        .receipt-table td:nth-child(4) {
            text-align: center;
            width: 10%;
        }
        
        .receipt-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 3px 0;
        }
        
        .receipt-signature {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
        }
        
        .signature-box {
            text-align: center;
            width: 45%;
        }
        
        .signature-line {
            border-bottom: 1px solid #000;
            height: 40px;
            margin-bottom: 5px;
        }
        
        @media print {
            .no-print { display: none !important; }
            .receipt-content { box-shadow: none; }
            
            @page {
                size: A5;
                margin: 10mm;
            }
            
            .receipt-paper {
                width: 100%;
                min-height: auto;
                margin: 0;
                padding: 0;
                box-shadow: none;
                page-break-inside: avoid;
                font-family: 'Sarabun', sans-serif !important;
            }
            
            body {
                font-family: 'Sarabun', sans-serif;
            }
            
            /* Ensure proper A5 sizing for request receipts */
            #request-receipt-content .receipt-paper {
                width: 148mm !important;
                min-height: 210mm !important;
                padding: 15mm !important;
                font-size: 14px !important;
                line-height: 1.6 !important;
            }
        }
        
        .fade-in {
            animation: smoothSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .scale-in {
            animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Custom checkbox styles */
        .form-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #d1d5db;
            border-radius: 0.25rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .form-checkbox:checked {
            background: #065f46;
            border-color: #065f46;
        }
        
        .form-checkbox:checked::before {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
            font-weight: bold;
        }
        
        .form-checkbox:hover {
            border-color: #065f46;
            box-shadow: 0 0 0 3px rgba(6, 95, 70, 0.1);
        }
        
        .form-checkbox:focus {
            outline: none;
            border-color: #065f46;
            box-shadow: 0 0 0 3px rgba(6, 95, 70, 0.2);
        }
        
        @keyframes smoothSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes scaleIn {
            from { 
                opacity: 0; 
                transform: scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }
        
        /* Custom checkbox styles */
        .form-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #d1d5db;
            border-radius: 0.25rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .form-checkbox:checked {
            background: #065f46;
            border-color: #065f46;
        }
        
        .form-checkbox:checked::before {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
            font-weight: bold;
        }
        
        .form-checkbox:hover {
            border-color: #065f46;
            box-shadow: 0 0 0 3px rgba(6, 95, 70, 0.1);
        }
        
        .form-checkbox:focus {
            outline: none;
            border-color: #065f46;
            box-shadow: 0 0 0 3px rgba(6, 95, 70, 0.2);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="nav-gradient text-white p-6 shadow-2xl">
        <div class="container mx-auto flex items-center">
            <!-- Left side - Back button -->
            <div class="flex-shrink-0">
                <button id="back-btn" onclick="goBack()" class="btn bg-white bg-opacity-20 text-white px-6 py-2 hover:bg-opacity-30 transition-all duration-300 hidden flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                    </svg>
                    <span>กลับ</span>
                </button>
            </div>
            
            <!-- Center - Title -->
            <div class="flex-1 flex justify-center items-center">
                <div class="flex items-center space-x-4">
                    <div class="bg-white bg-opacity-20 p-3 rounded-full">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                            <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="text-center">
                        <h1 class="text-2xl font-bold">ระบบคลังวัสดุ</h1>
                        <p class="text-green-100 text-sm">กลุ่มงานระบาดวิทยา</p>
                    </div>
                </div>
            </div>
            
            <!-- Right side - User info and Logout button -->
            <div class="flex-shrink-0 flex items-center space-x-4">
                <!-- User Name Display -->
                <div id="user-info" class="hidden flex items-center space-x-2 bg-white bg-opacity-20 px-4 py-2 rounded-lg">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                    </svg>
                    <span id="current-user-name" class="text-white font-medium text-sm"></span>
                </div>
                
                <!-- Logout Button -->
                <button id="logout-btn" onclick="logout()" class="btn bg-red-500 bg-opacity-90 px-6 py-2 hover:bg-red-600 transition-all duration-300 hidden">ออกจากระบบ</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto p-6">
        <!-- Home Page -->
        <div id="home-page" class="text-center fade-in">
            <div class="card p-10 max-w-lg mx-auto">
                <div class="mb-8">
                    <div class="bg-gradient-to-br from-green-100 to-green-50 p-6 rounded-full w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                        <svg class="w-12 h-12 text-primary" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                            <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-primary mb-2">เลือกการใช้งาน</h2>
                    <p class="text-gray-600">กรุณาเลือกประเภทการใช้งานที่ต้องการ</p>
                </div>
                <div class="space-y-4">
                    <button onclick="showRequestForm()" class="btn btn-primary w-full py-4 text-lg font-medium flex items-center justify-center space-x-3">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span>สร้างใบคำร้องขอเบิก</span>
                    </button>
                    <button onclick="showLogin()" class="btn btn-secondary w-full py-4 text-lg font-medium flex items-center justify-center space-x-3">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
                        </svg>
                        <span>หน้าผู้จัดการระบบ</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="hidden fade-in">
            <div class="card p-8 max-w-md mx-auto">
                <div class="text-center mb-8">
                    <div class="bg-gradient-to-br from-green-100 to-green-50 p-4 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                        <svg class="w-8 h-8 text-primary" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-primary mb-2">เข้าสู่ระบบ</h2>
                    <p class="text-gray-600">สำหรับผู้จัดการระบบเท่านั้น</p>
                </div>
                <form onsubmit="login(event)" class="space-y-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">ชื่อผู้ใช้</label>
                        <input type="text" id="username" class="input-field w-full" placeholder="กรอกชื่อผู้ใช้" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">รหัสผ่าน</label>
                        <input type="password" id="password" class="input-field w-full" placeholder="กรอกรหัสผ่าน" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full py-3 text-lg font-medium">เข้าสู่ระบบ</button>
                </form>
            </div>
        </div>

        <!-- Request Form Page -->
        <div id="request-page" class="hidden fade-in">
            <!-- Shopping Cart Button -->
            <div class="fixed top-24 right-6 z-40">
                <button onclick="toggleCart()" class="bg-primary hover:bg-primary-light text-white p-4 rounded-full shadow-lg transition-all duration-300 hover:scale-110 relative">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
                    </svg>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center font-bold hidden">0</span>
                </button>
            </div>

            <div class="card p-8">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-primary mb-2">สร้างใบคำร้องขอเบิก</h2>
                    <p class="text-gray-600">กรอกข้อมูลและเลือกวัสดุที่ต้องการขอเบิก</p>
                </div>
                
                <!-- User Info Form -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-primary mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                        </svg>
                        ข้อมูลผู้ขอเบิก
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">ชื่อ-สกุล</label>
                            <input type="text" id="req-name" class="input-field w-full" placeholder="กรอกชื่อ-สกุล" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">ตำแหน่ง</label>
                            <input type="text" id="req-position" class="input-field w-full" placeholder="กรอกตำแหน่ง" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">หน่วยงาน</label>
                            <input type="text" id="req-department" class="input-field w-full" placeholder="กรอกหน่วยงาน" required>
                            <p class="text-xs text-gray-500 mt-1">
                                <span class="text-amber-600 font-medium">หมายเหตุ:</span> 
                                กรณีเป็น ศบส. กรุณาระบุว่า ศบส.x (เช่น ศบส.1, ศบส.2)
                            </p>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">เบอร์โทรศัพท์</label>
                            <input type="tel" id="req-phone" class="input-field w-full" placeholder="กรอกเบอร์โทรศัพท์" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 text-sm font-semibold mb-2">วัตถุประสงค์การใช้งาน</label>
                            <input type="text" id="req-purpose" class="input-field w-full" placeholder="กรอกวัตถุประสงค์" required>
                        </div>
                    </div>
                </div>

                <!-- Material Categories -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-primary mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                            <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        เลือกวัสดุ
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="material-categories">
                        <!-- Categories will be populated here -->
                    </div>
                </div>


            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="hidden fade-in">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-primary mb-2">แดชบอร์ดผู้จัดการ</h2>
                <p class="text-gray-600">ภาพรวมระบบคลังวัสดุและเมนูจัดการ</p>
            </div>

            <!-- เวลาปัจจุบันและสถานะระบบ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">สถานะระบบ</h3>
                        <p class="text-gray-600 text-sm">ระบบคลังวัสดุ กลุ่มงานระบาดวิทยา</p>
                    </div>
                    <div class="text-right">
                        <div class="flex items-center space-x-2 mb-1">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-sm text-green-600 font-medium">ออนไลน์</span>
                        </div>
                        <p id="current-time" class="text-sm text-gray-500 font-mono"></p>
                    </div>
                </div>
            </div>

            <!-- เมนูหลัก -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">เมนูจัดการ</h3>
            </div>
            <div class="dashboard-grid mb-12">
                <button onclick="showWithdraw()" class="dashboard-card">
                    <svg class="w-8 h-8 mx-auto mb-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    <h3 class="text-lg font-semibold mb-1">เบิกวัสดุ</h3>
                    <p class="text-sm opacity-90">จัดการการเบิกวัสดุ</p>
                </button>
                <button onclick="showReceive()" class="dashboard-card">
                    <svg class="w-8 h-8 mx-auto mb-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 11-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <h3 class="text-lg font-semibold mb-1">รับวัสดุ</h3>
                    <p class="text-sm opacity-90">จัดการการรับวัสดุ</p>
                </button>
                <button onclick="showRequests()" class="dashboard-card relative">
                    <div id="requests-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full min-w-6 h-6 flex items-center justify-center font-bold hidden">0</div>
                    <svg class="w-8 h-8 mx-auto mb-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                    </svg>
                    <h3 class="text-lg font-semibold mb-1">ใบคำร้อง</h3>
                    <p class="text-sm opacity-90">จัดการใบคำร้องขอเบิก</p>
                </button>
                <button onclick="showHistory()" class="dashboard-card">
                    <svg class="w-8 h-8 mx-auto mb-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                    </svg>
                    <h3 class="text-lg font-semibold mb-1">ประวัติ</h3>
                    <p class="text-sm opacity-90">ดูประวัติการทำรายการ</p>
                </button>
                <button onclick="showStock()" class="dashboard-card">
                    <svg class="w-8 h-8 mx-auto mb-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                        <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <h3 class="text-lg font-semibold mb-1">สต๊อก</h3>
                    <p class="text-sm opacity-90">จัดการคลังสินค้า</p>
                </button>
                <button onclick="showStaff()" class="dashboard-card">
                    <svg class="w-8 h-8 mx-auto mb-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                    </svg>
                    <h3 class="text-lg font-semibold mb-1">เจ้าหน้าที่</h3>
                    <p class="text-sm opacity-90">จัดการข้อมูลเจ้าหน้าที่</p>
                </button>
                <button onclick="showUsers()" class="dashboard-card">
                    <svg class="w-8 h-8 mx-auto mb-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
                    </svg>
                    <h3 class="text-lg font-semibold mb-1">บัญชีผู้ใช้</h3>
                    <p class="text-sm opacity-90">จัดการบัญชีผู้ใช้งาน</p>
                </button>
            </div>

            <!-- Divider และ Header สำหรับส่วนสถิติ -->
            <div class="relative my-8">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-6 bg-gray-100 text-gray-600 font-medium">สถิติและข้อมูลภาพรวม</span>
                </div>
            </div>

            <!-- สถิติสรุปด่วน -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    สถิติด่วน
                </h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">ใบคำร้องที่รอพิจารณา</p>
                            <p id="pending-requests-count" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-blue-400 bg-opacity-30 rounded-lg p-3">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm font-medium">รายการในสต๊อก</p>
                            <p id="total-items-count" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-green-400 bg-opacity-30 rounded-lg p-3">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                                <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-100 text-sm font-medium">สินค้าใกล้หมด</p>
                            <p id="low-stock-count" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-orange-400 bg-opacity-30 rounded-lg p-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-100 text-sm font-medium">สินค้าหมด</p>
                            <p id="out-of-stock-count" class="text-3xl font-bold">0</p>
                            <p class="text-gray-200 text-xs mt-1">ต้องเติมสต๊อก</p>
                        </div>
                        <div class="bg-gray-400 bg-opacity-30 rounded-lg p-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm font-medium">ผู้ใช้งานทั้งหมด</p>
                            <p id="total-users-count" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-purple-400 bg-opacity-30 rounded-lg p-3">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-yellow-100 text-sm font-medium">วัสดุใกล้หมดอายุ</p>
                            <p id="expiring-soon-count" class="text-3xl font-bold">0</p>
                            <p class="text-yellow-200 text-xs mt-1">ใน 30 วันข้างหน้า</p>
                        </div>
                        <div class="bg-yellow-400 bg-opacity-30 rounded-lg p-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-red-100 text-sm font-medium">วัสดุหมดอายุแล้ว</p>
                            <p id="expired-items-count" class="text-3xl font-bold">0</p>
                            <p class="text-red-200 text-xs mt-1">ต้องการจัดการ</p>
                        </div>
                        <div class="bg-red-400 bg-opacity-30 rounded-lg p-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Divider และ Header สำหรับส่วนข้อมูลรายละเอียด -->
            <div class="relative my-8">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-6 bg-gray-100 text-gray-600 font-medium">ข้อมูลรายละเอียด</span>
                </div>
            </div>

            <!-- ใบคำร้องล่าสุด -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    รายการล่าสุด
                </h3>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold text-gray-700">ใบคำร้องล่าสุด</h4>
                    <button onclick="showRequests()" class="text-primary hover:text-primary-dark text-sm font-medium flex items-center">
                        ดูทั้งหมด
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
                <div id="recent-requests" class="space-y-3">
                    <p class="text-gray-500 text-center py-4">ไม่มีใบคำร้องล่าสุด</p>
                </div>
            </div>

            <!-- Divider และ Header สำหรับส่วนการจัดการวัสดุ -->
            <div class="relative my-8">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-6 bg-gray-100 text-gray-600 font-medium">การจัดการวัสดุ</span>
                </div>
            </div>

            <!-- รายการวัสดุใกล้หมดอายุและหมดอายุแล้ว -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    การติดตามวัสดุ
                </h3>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- วัสดุใกล้หมดอายุ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700">วัสดุใกล้หมดอายุ</h4>
                            <p class="text-sm text-gray-500">วัสดุที่จะหมดอายุใน 30 วันข้างหน้า</p>
                        </div>
                        <div class="bg-yellow-100 p-2 rounded-lg">
                            <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div id="expiring-soon-items" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- ข้อมูลจะถูกโหลดโดย JavaScript -->
                    </div>
                </div>

                <!-- วัสดุหมดอายุแล้ว -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700">วัสดุหมดอายุแล้ว</h4>
                            <p class="text-sm text-gray-500">วัสดุที่หมดอายุแล้วและต้องการจัดการ</p>
                        </div>
                        <div class="bg-red-100 p-2 rounded-lg">
                            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                    </div>
                    <div id="expired-items" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- ข้อมูลจะถูกโหลดโดย JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Divider และ Header สำหรับส่วนสถิติเชิงลึก -->
            <div class="relative my-8">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-6 bg-gray-100 text-gray-600 font-medium">รายงานและวิเคราะห์</span>
                </div>
            </div>

            <!-- สถิติการใช้งานรายสัปดาห์ -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    สถิติการใช้งาน
                </h3>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- สถิติรายสัปดาห์ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700">สถิติ 7 วันล่าสุด</h4>
                            <p id="weekly-stats-period" class="text-sm text-gray-500"></p>
                        </div>
                        <div class="bg-blue-100 p-2 rounded-lg">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">การเบิกวัสดุ</span>
                                <span id="withdraw-count" class="text-sm font-bold text-blue-600">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="withdraw-progress" class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">การรับวัสดุ</span>
                                <span id="receive-count" class="text-sm font-bold text-green-600">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="receive-progress" class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">ใบคำร้องใหม่</span>
                                <span id="requests-week-count" class="text-sm font-bold text-purple-600">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="requests-progress" class="bg-purple-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- วัสดุยอดนิยม -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700">วัสดุยอดนิยม</h4>
                            <p id="popular-materials-period" class="text-sm text-gray-500 mt-1">กำลังโหลด...</p>
                        </div>
                        <div class="bg-orange-100 p-2 rounded-lg">
                            <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>
                    <div id="popular-items" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">ไม่มีข้อมูล</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Withdraw Page -->
        <div id="withdraw-page" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-primary mb-6">เบิกวัสดุ</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">รหัสเจ้าหน้าที่ (สแกนบาร์โค้ด)</label>
                        <input type="text" id="staff-barcode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary" onchange="loadStaffInfo(this.value)">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">ชื่อ-สกุล</label>
                        <input type="text" id="withdraw-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">ตำแหน่ง</label>
                        <input type="text" id="withdraw-position" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">หน่วยงาน</label>
                        <input type="text" id="withdraw-department" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 text-sm font-bold mb-2">วัตถุประสงค์การใช้</label>
                        <input type="text" id="withdraw-purpose" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">สแกนบาร์โค้ดวัสดุ</label>
                    <div class="flex gap-2">
                        <input type="text" id="material-barcode" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary" 
                               placeholder="สแกนบาร์โค้ดหรือพิมพ์รหัสวัสดุ แล้วกด Enter" 
                               onkeypress="handleBarcodeInput(event)" 
                               oninput="handleBarcodeChange(this.value)">
                        <input type="number" id="withdraw-quantity" placeholder="จำนวน" value="1" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary" min="1">
                        <button onclick="addToWithdrawList()" class="bg-primary text-white px-4 py-2 rounded-lg hover-primary flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span>เพิ่ม</span>
                        </button>
                    </div>
                    <div id="barcode-info" class="mt-2 text-sm"></div>
                    <div class="mt-2 text-xs text-gray-500">
                        💡 <strong>วิธีใช้:</strong> พิมพ์รหัสบาร์โค้ดแล้วกด Enter หรือคลิกปุ่ม "เพิ่ม" เพื่อเพิ่มวัสดุลงในรายการเบิก
                    </div>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-primary">รายการเบิก</h3>
                        <div id="withdraw-total" class="text-sm font-medium text-gray-600">รวม: 0 รายการ</div>
                    </div>
                    <div id="withdraw-items" class="bg-gray-50 p-4 rounded-lg min-h-20">
                        <p class="text-gray-500 text-center py-4">ยังไม่มีรายการเบิก</p>
                    </div>
                </div>

                <button onclick="processWithdraw()" class="bg-primary text-white py-2 px-6 rounded-lg hover-primary">เบิกวัสดุ</button>
            </div>
        </div>

        <!-- Receive Page -->
        <div id="receive-page" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-primary mb-6">รับวัสดุ</h2>
                
                <div class="grid grid-cols-1 gap-4 mb-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">แหล่งที่มา</label>
                        <input type="text" id="receive-source" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">สแกนบาร์โค้ดวัสดุ</label>
                    <div class="flex gap-2">
                        <input type="text" id="receive-barcode" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary" 
                               placeholder="สแกนบาร์โค้ดหรือพิมพ์รหัสวัสดุ แล้วกด Enter" 
                               onkeypress="handleReceiveBarcodeInput(event)" 
                               oninput="handleReceiveBarcodeChange(this.value)">
                        <input type="number" id="receive-quantity" placeholder="จำนวน" value="1" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary" min="1">

                    </div>
                    <div id="receive-barcode-info" class="mt-2 text-sm"></div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-bold text-primary mb-4">รายการรับ</h3>
                    <div id="receive-items" class="bg-gray-50 p-4 rounded-lg min-h-20">
                        <p class="text-gray-500">ยังไม่มีรายการรับ</p>
                    </div>
                </div>

                <button onclick="processReceive()" class="bg-primary text-white py-2 px-6 rounded-lg hover-primary">รับวัสดุ</button>
            </div>
        </div>

        <!-- Requests Management -->
        <div id="requests-page" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-primary">จัดการใบคำร้อง</h2>
                    <button onclick="exportRequestsToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        <span>ส่งออก Excel</span>
                    </button>
                </div>

                <!-- Search and Filter Box -->
                <div class="mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <div class="relative">
                                <input type="text" id="requests-search" placeholder="ค้นหา เลขที่ใบคำร้อง, ชื่อผู้ขอ, หน่วยงาน, หรือวัตถุประสงค์..." 
                                       class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary"
                                       oninput="filterRequests()">
                                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <select id="requests-status-filter" onchange="filterRequests()" 
                                    class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                                <option value="">ทุกสถานะ</option>
                                <option value="pending">รออนุมัติ</option>
                                <option value="approved">อนุมัติ</option>
                                <option value="rejected">ไม่อนุมัติ</option>
                            </select>
                            <button onclick="clearRequestsSearch()" class="px-4 py-3 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="requests-results-count" class="mt-2 text-sm text-gray-600"></div>
                </div>

                <div id="requests-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Requests will be populated here -->
                </div>
            </div>
        </div>

        <!-- History Page -->
        <div id="history-page" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-primary">ประวัติการทำรายการ</h2>
                    <button onclick="exportHistoryToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        <span>ส่งออก Excel</span>
                    </button>
                </div>

                <!-- Search Box -->
                <div class="mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <div class="relative">
                                <input type="text" id="history-search" placeholder="ค้นหา รหัสรายการ, ชื่อผู้เบิก, ตำแหน่ง, หน่วยงาน, วัตถุประสงค์, หรือชื่อวัสดุ..." 
                                       class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary"
                                       oninput="filterHistory(this.value)">
                                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <select id="history-type-filter" onchange="filterHistory(document.getElementById('history-search').value)" 
                                    class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                                <option value="">ทุกประเภท</option>
                                <option value="withdraw">เบิกวัสดุ</option>
                                <option value="receive">รับวัสดุ</option>
                            </select>
                            <button onclick="clearHistorySearch()" class="px-4 py-3 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="search-results-count" class="mt-2 text-sm text-gray-600"></div>
                </div>

                <div id="history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- History will be populated here -->
                </div>
            </div>
        </div>

        <!-- Stock Page -->
        <div id="stock-page" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-primary mb-4">จัดการสต๊อก</h2>
                
                <!-- Layout แบบ 2 คอลัมน์ -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                    <!-- คอลัมน์ซ้าย: ปุ่มหลัก -->
                    <div class="lg:col-span-3">
                        <div class="flex flex-wrap gap-2">
                            <button onclick="showAddStockModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span>เพิ่มรายการใหม่</span>
                            </button>
                            <button onclick="exportStockToExcel()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                                <span>ส่งออก Excel (ตามตัวกรอง)</span>
                            </button>
                            <button onclick="exportAllStockToExcel()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                                <span>ส่งออกทั้งหมด</span>
                            </button>
                            <button onclick="showImportStockModal()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 flex items-center space-x-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                <span>นำเข้า Excel</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- คอลัมน์ขวา: บล็อกจัดการการแสดงในคำร้อง -->
                    <div class="lg:col-span-1">
                        <div class="bg-gradient-to-br from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-purple-800 mb-3 text-center">ส่วนการจัดการการแสดงในคำร้อง</h3>
                            <div class="space-y-2">
                                <button onclick="toggleAllShowInRequest(true)" class="w-full bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 flex items-center justify-center space-x-2 text-sm">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>แสดงทั้งหมด</span>
                                </button>
                                <button onclick="toggleAllShowInRequest(false)" class="w-full bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 flex items-center justify-center space-x-2 text-sm">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ซ่อนทั้งหมด</span>
                                </button>
                            </div>
                            <p class="text-xs text-purple-600 mt-3 text-center">จัดการการแสดงวัสดุในหน้าคำร้องขอเบิก</p>
                        </div>
                    </div>
                </div>

                <!-- ช่องค้นหาและตัวกรอง -->
                <div class="mb-6 space-y-4">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <!-- ช่องค้นหา -->
                        <div class="flex-1">
                            <div class="relative">
                                <input type="text" id="stock-search" placeholder="ค้นหาด้วยรหัสบาร์โค้ด, ชื่อวัสดุ, หรือหมวดหมู่..." 
                                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       oninput="filterStock()">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- ตัวกรองตามกลุ่ม -->
                        <div class="sm:w-48">
                            <select id="stock-group-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterStock()">
                                <option value="">ทุกกลุ่ม</option>
                                <!-- จะถูกเติมโดย JavaScript -->
                            </select>
                        </div>

                        <!-- ตัวกรองตามหมวดหมู่ -->
                        <div class="sm:w-64">
                            <select id="stock-category-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterStock()">
                                <option value="">ทุกหมวดหมู่</option>
                                <!-- จะถูกเติมโดย JavaScript -->
                            </select>
                        </div>

                        <!-- ตัวกรองตามสถานะ -->
                        <div class="sm:w-48">
                            <select id="stock-status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterStock()">
                                <option value="">ทุกสถานะ</option>
                                <option value="normal">ปกติ</option>
                                <option value="low">ใกล้หมด</option>
                                <option value="out-of-stock">สินค้าหมด</option>
                                <option value="expiring">ใกล้หมดอายุ</option>
                                <option value="expired">หมดอายุแล้ว</option>
                            </select>
                        </div>

                        <!-- ปุ่มล้างการค้นหา -->
                        <button onclick="clearStockSearch()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <span>ล้าง</span>
                        </button>
                    </div>

                    <!-- แสดงผลการค้นหา -->
                    <div id="stock-search-results" class="text-sm text-gray-600"></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full table-modern">
                        <thead>
                            <tr>
                                <th>รหัสบาร์โค้ด</th>
                                <th>กลุ่ม</th>
                                <th>หมวดหมู่</th>
                                <th>รายการวัสดุ</th>
                                <th>จำนวนคงเหลือ</th>
                                <th>หน่วย</th>
                                <th>วันหมดอายุ</th>
                                <th>แสดงในคำร้อง</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table">
                            <!-- Stock items will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Staff Page -->
        <div id="staff-page" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-primary">จัดการเจ้าหน้าที่</h2>
                    <div class="flex gap-2">
                        <button onclick="showAddStaff()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span>เพิ่มเจ้าหน้าที่</span>
                        </button>
                        <button onclick="exportStaffToExcel()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                            <span>ส่งออก Excel</span>
                        </button>
                    </div>
                </div>
                <div id="staff-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Staff cards will be populated here -->
                </div>
            </div>
        </div>

        <!-- Users Page -->
        <div id="users-page" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-primary">จัดการบัญชีผู้ใช้</h2>
                    <button onclick="showAddUser()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span>เพิ่มผู้ใช้</span>
                    </button>
                </div>
                <div id="users-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- User cards will be populated here -->
                </div>
            </div>
        </div>

        <!-- Request Receipt Modal -->
        <div id="request-receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
                <div id="request-receipt-content">
                    <!-- Receipt content will be populated here -->
                </div>
                <div class="p-4 flex gap-2 no-print bg-gray-100 rounded-b-lg">
                    <button onclick="downloadRequestReceipt()" class="bg-primary text-white px-6 py-2 rounded-lg hover-primary flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        <span>บันทึกเป็น PDF</span>
                    </button>
                    <button onclick="closeRequestReceipt()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">ปิด</button>
                </div>
            </div>
        </div>

        <!-- Withdraw Receipt Modal -->
        <div id="withdraw-receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 receipt-modal">
            <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
                <div id="withdraw-receipt-content" class="receipt-paper">
                    <!-- Withdraw receipt content will be populated here -->
                </div>
                <div class="p-4 flex gap-2 no-print bg-gray-100 rounded-b-lg">
                    <button onclick="saveWithdrawReceiptAsPDF()" class="bg-primary text-white px-6 py-2 rounded-lg hover-primary flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        <span>บันทึกเป็น PDF</span>
                    </button>
                    <button onclick="closeWithdrawReceipt()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">ปิด</button>
                </div>
            </div>
        </div>

        <!-- Receive Receipt Modal -->
        <div id="receive-receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 receipt-modal">
            <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
                <div id="receive-receipt-content" class="receipt-paper">
                    <!-- Receive receipt content will be populated here -->
                </div>
                <div class="p-4 flex gap-2 no-print bg-gray-100 rounded-b-lg">
                    <button onclick="saveReceiveReceiptAsPDF()" class="bg-primary text-white px-6 py-2 rounded-lg hover-primary flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        <span>บันทึกเป็น PDF</span>
                    </button>
                    <button onclick="closeReceiveReceipt()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">ปิด</button>
                </div>
            </div>
        </div>

        <!-- Request Detail Modal -->
        <div id="request-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 receipt-modal">
            <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
                <div id="request-detail-content" class="receipt-paper">
                    <!-- Request detail content will be populated here -->
                </div>
                <div class="p-4 flex gap-2 no-print bg-gray-100 rounded-b-lg">
                    <button onclick="saveRequestDetailAsPDF()" class="bg-primary text-white px-6 py-2 rounded-lg hover-primary flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        <span>บันทึกเป็น PDF</span>
                    </button>
                    <button onclick="closeRequestDetail()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">ปิด</button>
                </div>
            </div>
        </div>

        <!-- Quantity Selection Modal -->
        <div id="quantity-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl max-w-md w-full mx-4 shadow-2xl transform transition-all">
                <div class="p-6">
                    <div class="text-center mb-6">
                        <div class="bg-gradient-to-br from-green-100 to-green-50 p-4 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                                <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-primary mb-2">ระบุจำนวน</h3>
                        <p id="quantity-item-name" class="text-gray-600 font-medium"></p>
                        <p id="quantity-available" class="text-sm text-green-600 mt-1"></p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-semibold mb-3 text-center">จำนวนที่ต้องการ</label>
                        <div class="flex items-center justify-center space-x-4">
                            <button onclick="decreaseQuantity()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-105">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <div class="text-center">
                                <input type="number" id="quantity-input" min="1" value="1" class="w-20 h-12 text-center text-2xl font-bold border-2 border-primary rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                                <p id="quantity-unit" class="text-sm text-gray-500 mt-1"></p>
                            </div>
                            <button onclick="increaseQuantity()" class="bg-primary hover:bg-primary-light text-white w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-105">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="cancelQuantitySelection()" class="btn btn-secondary flex-1 py-3 text-lg font-medium">ยกเลิก</button>
                        <button onclick="confirmQuantitySelection()" class="btn btn-primary flex-1 py-3 text-lg font-medium">ยืนยัน</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shopping Cart Modal -->
        <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-primary flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
                            </svg>
                            ตะกร้าสินค้า
                        </h3>
                        <button onclick="toggleCart()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- User Info Form in Cart -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-primary mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                            </svg>
                            ข้อมูลผู้ขอเบิก
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">ชื่อ-สกุล</label>
                                <input type="text" id="cart-req-name" class="input-field w-full" placeholder="กรอกชื่อ-สกุล" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">ตำแหน่ง</label>
                                <input type="text" id="cart-req-position" class="input-field w-full" placeholder="กรอกตำแหน่ง" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">หน่วยงาน</label>
                                <input type="text" id="cart-req-department" class="input-field w-full" placeholder="กรอกหน่วยงาน" required>
                                <p class="text-xs text-gray-500 mt-1">
                                    <span class="text-amber-600 font-medium">หมายเหตุ:</span> 
                                    กรณีเป็น ศบส. กรุณาระบุว่า ศบส.x (เช่น ศบส.1, ศบส.2)
                                </p>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">เบอร์โทรศัพท์</label>
                                <input type="tel" id="cart-req-phone" class="input-field w-full" placeholder="กรอกเบอร์โทรศัพท์" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">วัตถุประสงค์การใช้งาน</label>
                                <input type="text" id="cart-req-purpose" class="input-field w-full" placeholder="กรอกวัตถุประสงค์" required>
                            </div>
                        </div>
                    </div>

                    <!-- Cart Items -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-primary mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            รายการที่เลือก (<span id="cart-items-count">0</span> รายการ)
                        </h4>
                        <div id="cart-items" class="space-y-3 max-h-60 overflow-y-auto">
                            <p class="text-gray-500 text-center py-8">ยังไม่มีรายการที่เลือก</p>
                        </div>
                    </div>

                    <!-- Cart Actions -->
                    <div class="flex gap-3">
                        <button onclick="clearCart()" class="btn btn-secondary flex-1 py-3 text-lg font-medium flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span>ล้างตะกร้า</span>
                        </button>
                        <button onclick="submitRequestFromCart()" class="btn btn-primary flex-1 py-3 text-lg font-medium flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path>
                            </svg>
                            <span>ส่งใบคำร้อง</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // เวลาปัจจุบันบนแดชบอร์ด
        function updateCurrentTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Bangkok'
            };
            const timeString = now.toLocaleDateString('th-TH', options);
            
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        // เริ่มอัปเดตเวลาทุกวินาที
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime(); // แสดงเวลาทันทีเมื่อโหลดหน้า

        // Global variables
        let currentUser = null;
        let selectedRequestItems = [];
        let withdrawItems = [];
        let receiveItems = [];
        let navigationHistory = [];
        
        // Firebase data cache
        let firebaseData = {
            users: [],
            staff: [],
            stock: [],
            requests: [],
            history: []
        };

        // Firebase helper functions
        async function initializeFirebaseData() {
            try {
                console.log('Loading data from Firebase...');
                
                // เช็คว่ามีผู้ใช้ admin หรือไม่ หากไม่มีให้สร้าง
                const usersSnapshot = await firebase.get(firebase.ref(firebase.database, 'users'));
                if (!usersSnapshot.exists()) {
                    console.log('No users found, creating admin user...');
                    const adminUser = {
                        'user1': { id: 1, name: 'ผู้ดูแลระบบ', username: 'admin', password: 'admin123' }
                    };
                    await firebase.set(firebase.ref(firebase.database, 'users'), adminUser);
                    console.log('Admin user created successfully');
                }
                
                // โหลดข้อมูลทั้งหมดจาก Firebase
                await loadAllFirebaseData();
                
                console.log('=== Firebase Data Summary ===');
                console.log('Users:', firebaseData.users.length);
                console.log('Staff:', firebaseData.staff.length);
                console.log('Stock:', firebaseData.stock.length);
                console.log('Requests:', firebaseData.requests.length);
                console.log('History:', firebaseData.history.length);
                console.log('================================');
                
                console.log('Firebase data initialization completed');
                
            } catch (error) {
                console.error('Error initializing Firebase data:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล');
            }
        }

        async function loadAllFirebaseData() {
            try {
                // Load users
                const usersSnapshot = await firebase.get(firebase.ref(firebase.database, 'users'));
                firebaseData.users = usersSnapshot.exists() ? Object.values(usersSnapshot.val()) : [];
                
                // Load staff
                const staffSnapshot = await firebase.get(firebase.ref(firebase.database, 'staff'));
                firebaseData.staff = staffSnapshot.exists() ? Object.values(staffSnapshot.val()) : [];
                
                // Load stock
                const stockSnapshot = await firebase.get(firebase.ref(firebase.database, 'stock'));
                firebaseData.stock = stockSnapshot.exists() ? Object.values(stockSnapshot.val()) : [];
                
                // ตั้งค่าเริ่มต้นสำหรับ showInRequest หากยังไม่มี
                firebaseData.stock.forEach(item => {
                    if (item.showInRequest === undefined) {
                        item.showInRequest = true; // ค่าเริ่มต้นให้แสดงในคำร้อง
                    }
                });
                
                console.log('=== Firebase Stock Data Loaded ===');
                console.log('Stock items count:', firebaseData.stock.length);
                console.log('Stock data:', firebaseData.stock);
                
                // Check for items with expiry dates
                const itemsWithExpiry = firebaseData.stock.filter(item => item.expiry);
                console.log('Items with expiry dates:', itemsWithExpiry.length);
                console.log('Items with expiry details:', itemsWithExpiry);
                
                // Load requests
                const requestsSnapshot = await firebase.get(firebase.ref(firebase.database, 'requests'));
                firebaseData.requests = requestsSnapshot.exists() ? Object.values(requestsSnapshot.val()) : [];
                
                // Load history
                const historySnapshot = await firebase.get(firebase.ref(firebase.database, 'history'));
                firebaseData.history = historySnapshot.exists() ? Object.values(historySnapshot.val()) : [];
                
                console.log('Firebase data loaded successfully');
                
            } catch (error) {
                console.error('Error loading Firebase data:', error);
            }
        }

        async function saveToFirebase(collection, key, data) {
            try {
                await firebase.set(firebase.ref(firebase.database, `${collection}/${key}`), data);
                await loadAllFirebaseData(); // Refresh local cache
            } catch (error) {
                console.error(`Error saving to ${collection}:`, error);
                throw error;
            }
        }

        async function deleteFromFirebase(collection, key) {
            try {
                await firebase.remove(firebase.ref(firebase.database, `${collection}/${key}`));
                await loadAllFirebaseData(); // Refresh local cache
            } catch (error) {
                console.error(`Error deleting from ${collection}:`, error);
                throw error;
            }
        }

        // Replace sampleData references with firebaseData
        const sampleData = firebaseData;

        // Debug functions - เพิ่มใน Console เพื่อทดสอบ
        window.debugAddItem = function(barcode = 'B001') {
            console.log('=== Debug Add Item ===');
            console.log('Barcode:', barcode);
            console.log('sampleData.stock:', sampleData.stock);
            console.log('withdrawItems before:', [...withdrawItems]);
            
            const item = sampleData.stock.find(s => s.barcode === barcode);
            console.log('Found item:', item);
            
            if (item) {
                addDirectToWithdrawList(barcode);
                console.log('withdrawItems after:', [...withdrawItems]);
            } else {
                console.log('Item not found');
            }
        };
        
        window.debugEnterKey = function() {
            console.log('=== Debug Enter Key ===');
            const barcodeInput = document.getElementById('material-barcode');
            if (barcodeInput) {
                barcodeInput.value = 'B001';
                const event = new KeyboardEvent('keypress', { key: 'Enter', bubbles: true });
                handleBarcodeInput(event);
            } else {
                console.log('Barcode input not found');
            }
        };

        window.debugSampleData = function() {
            console.log('=== Debug Sample Data ===');
            console.log('sampleData:', sampleData);
            console.log('sampleData.stock.length:', sampleData.stock?.length);
            console.log('First 5 stock items:', sampleData.stock?.slice(0, 5));
            console.log('withdrawItems:', withdrawItems);
        };

        // Debug function for withdraw process
        window.debugWithdraw = function() {
            console.log('=== Debug Withdraw Process ===');
            console.log('Current withdrawItems:', withdrawItems);
            console.log('Form values:');
            console.log('- Name:', document.getElementById('withdraw-name')?.value);
            console.log('- Position:', document.getElementById('withdraw-position')?.value);
            console.log('- Department:', document.getElementById('withdraw-department')?.value);
            console.log('- Purpose:', document.getElementById('withdraw-purpose')?.value);
            
            if (withdrawItems.length === 0) {
                console.log('⚠️ No items in withdraw list');
                return;
            }
            
            console.log('Testing processWithdraw...');
            processWithdraw().catch(error => {
                console.error('Error in processWithdraw:', error);
            });
        };

        window.testWithdrawFlow = function() {
            console.log('=== Test Complete Withdraw Flow ===');
            
            // 1. Clear existing items
            withdrawItems.length = 0;
            
            // 2. Add test item
            debugAddItem('B001');
            
            // 3. Fill form
            document.getElementById('withdraw-name').value = 'ทดสอบ';
            document.getElementById('withdraw-purpose').value = 'ทดสอบระบบ';
            
            // 4. Process withdraw
            setTimeout(() => {
                console.log('Processing withdraw...');
                debugWithdraw();
            }, 1000);
        };

        // Initialize app
        async function initApp() {
            try {
                // Show loading state
                console.log('Initializing Firebase...');
                
                // Initialize Firebase data
                await initializeFirebaseData();
                
                // Initialize UI
                showHome();
                loadMaterialCategories();
                loadStock();
                loadStaff();
                loadUsers();
                loadRequests();
                loadHistory();
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Error initializing app:', error);
                alert('เกิดข้อผิดพลาดในการเริ่มต้นระบบ กรุณาลองใหม่อีกครั้ง');
            }
        }

        // Navigation functions
        function addToHistory(pageName) {
            if (navigationHistory.length === 0 || navigationHistory[navigationHistory.length - 1] !== pageName) {
                navigationHistory.push(pageName);
                updateBackButton();
            }
        }

        function updateBackButton() {
            const backBtn = document.getElementById('back-btn');
            if (navigationHistory.length > 1) {
                backBtn.classList.remove('hidden');
            } else {
                backBtn.classList.add('hidden');
            }
        }

        function goBack() {
            if (navigationHistory.length > 1) {
                navigationHistory.pop(); // Remove current page
                const previousPage = navigationHistory[navigationHistory.length - 1];
                
                // Navigate to previous page without adding to history
                switch(previousPage) {
                    case 'home':
                        showHomeInternal();
                        break;
                    case 'login':
                        showLoginInternal();
                        break;
                    case 'request':
                        showRequestFormInternal();
                        break;
                    case 'admin-dashboard':
                        showAdminDashboardInternal();
                        break;
                    case 'withdraw':
                        showWithdrawInternal();
                        break;
                    case 'receive':
                        showReceiveInternal();
                        break;
                    case 'requests':
                        showRequestsInternal();
                        break;
                    case 'history':
                        showHistoryInternal();
                        break;
                    case 'stock':
                        showStockInternal();
                        break;
                    case 'staff':
                        showStaffInternal();
                        break;
                    case 'users':
                        showUsersInternal();
                        break;
                }
                updateBackButton();
            }
        }

        function showHome() {
            addToHistory('home');
            showHomeInternal();
        }

        function showHomeInternal() {
            hideAllPages();
            document.getElementById('home-page').classList.remove('hidden');
            document.getElementById('logout-btn').classList.add('hidden');
            hideUserInfo(); // ซ่อนข้อมูลผู้ใช้เมื่อกลับหน้าหลัก
        }

        function showLogin() {
            addToHistory('login');
            showLoginInternal();
        }

        function showLoginInternal() {
            hideAllPages();
            document.getElementById('login-page').classList.remove('hidden');
        }

        function showRequestForm() {
            addToHistory('request');
            showRequestFormInternal();
        }

        function showRequestFormInternal() {
            hideAllPages();
            document.getElementById('request-page').classList.remove('hidden');
            
            // รีเฟรชข้อมูลทุกครั้งที่เข้าหน้า
            console.log('Entering request form, reloading material categories...');
            loadMaterialCategories();
        }

        function showAdminDashboard() {
            addToHistory('admin-dashboard');
            showAdminDashboardInternal();
        }

        function showAdminDashboardInternal() {
            hideAllPages();
            document.getElementById('admin-dashboard').classList.remove('hidden');
            showAdminNavigation();
            
            // โหลดข้อมูลสถิติและใบคำร้องล่าสุด
            loadDashboardData();
            
            // เริ่มระบบ real-time monitoring สำหรับแดชบอร์ด
            startDashboardMonitoring();
        }

        function showWithdraw() {
            addToHistory('withdraw');
            showWithdrawInternal();
            // อัปเดตการแสดงรายการเบิก
            updateWithdrawItems();
        }

        function showWithdrawInternal() {
            hideAllPages();
            document.getElementById('withdraw-page').classList.remove('hidden');
            showAdminNavigation();
            // Auto-focus on barcode input for immediate scanning
            setTimeout(() => {
                document.getElementById('material-barcode').focus();
            }, 100);
        }

        function showReceive() {
            addToHistory('receive');
            showReceiveInternal();
        }

        function showReceiveInternal() {
            hideAllPages();
            document.getElementById('receive-page').classList.remove('hidden');
            showAdminNavigation();
            // Auto-focus on barcode input for immediate scanning
            setTimeout(() => {
                document.getElementById('receive-barcode').focus();
            }, 100);
        }

        function showRequests() {
            addToHistory('requests');
            showRequestsInternal();
        }

        function showRequestsInternal() {
            hideAllPages();
            document.getElementById('requests-page').classList.remove('hidden');
            showAdminNavigation();
            
            // Clear search filters and load all requests
            document.getElementById('requests-search').value = '';
            document.getElementById('requests-status-filter').value = '';
            filterRequests();
            
            // รีเซ็ต timestamp สำหรับ monitoring
            requestsLastCheckTime = Date.now();
            
            // เริ่มระบบ real-time monitoring เมื่อเข้าหน้าจัดการใบคำร้อง
            startRequestsMonitoring();
        }

        function showHistory() {
            addToHistory('history');
            showHistoryInternal();
        }

        function showHistoryInternal() {
            hideAllPages();
            document.getElementById('history-page').classList.remove('hidden');
            showAdminNavigation();
            loadHistory();
        }

        function showStock() {
            addToHistory('stock');
            showStockInternal();
        }

        function showStockInternal() {
            hideAllPages();
            document.getElementById('stock-page').classList.remove('hidden');
            showAdminNavigation();
            loadStock();
        }

        function showStaff() {
            addToHistory('staff');
            showStaffInternal();
        }

        function showStaffInternal() {
            hideAllPages();
            document.getElementById('staff-page').classList.remove('hidden');
            showAdminNavigation();
            loadStaff();
        }

        function showUsers() {
            addToHistory('users');
            showUsersInternal();
        }

        function showUsersInternal() {
            hideAllPages();
            document.getElementById('users-page').classList.remove('hidden');
            showAdminNavigation();
            loadUsers();
        }

        function hideAllPages() {
            const pages = ['home-page', 'login-page', 'request-page', 'admin-dashboard', 'withdraw-page', 'receive-page', 'requests-page', 'history-page', 'stock-page', 'staff-page', 'users-page'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
            
            // หยุดระบบ monitoring ต่างๆ เมื่อออกจากหน้า
            stopRequestsMonitoring();
            stopDashboardMonitoring();
        }

        // Authentication
        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = sampleData.users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                updateUserInfo(); // อัปเดตข้อมูลผู้ใช้ในแถบนำทาง
                showAdminDashboard();
                alert('เข้าสู่ระบบสำเร็จ');
            } else {
                alert('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง');
            }
        }

        function logout() {
            currentUser = null;
            hideUserInfo(); // ซ่อนข้อมูลผู้ใช้
            navigationHistory = []; // Clear navigation history
            showHome();
        }

        // ฟังก์ชันสำหรับอัปเดตข้อมูลผู้ใช้ในแถบนำทาง
        function updateUserInfo() {
            const userInfoElement = document.getElementById('user-info');
            const userNameElement = document.getElementById('current-user-name');
            
            if (currentUser && userInfoElement && userNameElement) {
                userNameElement.textContent = currentUser.name;
                userInfoElement.classList.remove('hidden');
            }
        }

        // ฟังก์ชันสำหรับซ่อนข้อมูลผู้ใช้
        function hideUserInfo() {
            const userInfoElement = document.getElementById('user-info');
            if (userInfoElement) {
                userInfoElement.classList.add('hidden');
            }
        }

        // ฟังก์ชันสำหรับแสดงแถบนำทางสำหรับ admin
        function showAdminNavigation() {
            document.getElementById('logout-btn').classList.remove('hidden');
            updateUserInfo();
        }

        // Material categories loading
        function loadMaterialCategories() {
            // Debug: ตรวจสอบข้อมูลก่อนกรอง
            console.log('=== loadMaterialCategories START ===');
            console.log('sampleData.stock:', sampleData.stock);
            console.log('sampleData.stock.length:', sampleData.stock.length);
            
            // กรองเฉพาะวัสดุที่อนุญาตให้แสดงในคำร้อง (showInRequest === true)
            const availableStock = sampleData.stock.filter(item => {
                const result = item.showInRequest === true;
                console.log(`Item: ${item.name}, showInRequest: ${item.showInRequest}, included: ${result}`);
                return result;
            });
            
            const categories = [...new Set(availableStock.map(item => item.category))];
            const container = document.getElementById('material-categories');
            
            // Debug log
            console.log('=== loadMaterialCategories Debug ===');
            console.log('Total stock items:', sampleData.stock.length);
            console.log('Available stock items (showInRequest === true):', availableStock.length);
            console.log('Categories found:', categories);
            console.log('Stock items with showInRequest:', sampleData.stock.map(item => ({
                name: item.name,
                barcode: item.barcode,
                showInRequest: item.showInRequest
            })));
            console.log('====================================');
            
            if (!container) {
                console.error('Container element "material-categories" not found!');
                return;
            }
            
            if (categories.length === 0) {
                console.log('No categories available, showing empty message');
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="bg-gray-100 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2M4 13h2m0 0V9a1 1 0 011-1h1m1 0h3m-6 0v4a1 1 0 001 1h1M4 13v-2m16 0v2"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-lg">ไม่มีวัสดุที่อนุญาตให้ขอเบิก</p>
                        <p class="text-gray-400 text-sm mt-2">กรุณาติดต่อผู้จัดการระบบเพื่อเปิดใช้งานรายการวัสดุ</p>
                    </div>
                `;
                return;
            }
            
            console.log(`Generating HTML for ${categories.length} categories`);
            const html = categories.map(category => {
                const items = availableStock.filter(item => item.category === category);
                console.log(`Category: ${category}, items: ${items.length}`);
                return `
                    <div class="card p-6 slide-up" style="animation-delay: ${categories.indexOf(category) * 0.1}s;">
                        <h4 class="text-lg font-bold text-primary mb-4 flex items-center">
                            <div class="w-3 h-3 bg-primary rounded-full mr-2"></div>
                            ${category}
                        </h4>
                        <div class="space-y-3">
                            ${items.map((item, index) => `
                                <div class="material-card scale-in" style="animation-delay: ${(categories.indexOf(category) * 0.1) + (index * 0.05)}s;">
                                    <div class="flex justify-between items-center">
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-800">${item.name}</div>
                                            <div class="text-sm text-gray-500 mt-1">รหัส: ${item.barcode}</div>
                                            <div class="text-sm font-medium text-green-600 mt-1">คงเหลือ: ${item.quantity} ${item.unit}</div>
                                        </div>
                                        <button onclick="addToRequest('${item.barcode}')" class="btn btn-primary px-4 py-2 text-sm">
                                            <svg class="w-4 h-4 mr-1 inline" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                                            </svg>
                                            เลือก
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            console.log('HTML updated successfully');
            console.log('=== loadMaterialCategories END ===');
        }

        // Shopping Cart Management
        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                updateCartDisplay();
                syncFormData();
            } else {
                modal.classList.add('hidden');
            }
        }

        function updateCartCount() {
            const cartCount = document.getElementById('cart-count');
            const cartItemsCount = document.getElementById('cart-items-count');
            
            if (selectedRequestItems.length > 0) {
                cartCount.textContent = selectedRequestItems.length;
                cartCount.classList.remove('hidden');
            } else {
                cartCount.classList.add('hidden');
            }
            
            if (cartItemsCount) {
                cartItemsCount.textContent = selectedRequestItems.length;
            }
        }

        function updateCartDisplay() {
            const container = document.getElementById('cart-items');
            if (selectedRequestItems.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">ยังไม่มีรายการที่เลือก</p>';
            } else {
                container.innerHTML = selectedRequestItems.map((item, index) => `
                    <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg border hover:border-primary transition-all duration-200">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">${item.name}</div>
                            <div class="text-sm text-gray-500 mt-1">รหัส: ${item.barcode}</div>
                            <div class="text-sm text-green-600 font-medium mt-1">จำนวน: ${item.quantity} ${item.unit}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="editCartItem(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-all">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                </svg>
                            </button>
                            <button onclick="removeFromCart(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-all">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            updateCartCount();
        }

        function syncFormData() {
            // Sync data from main form to cart form
            document.getElementById('cart-req-name').value = document.getElementById('req-name').value;
            document.getElementById('cart-req-position').value = document.getElementById('req-position').value;
            document.getElementById('cart-req-department').value = document.getElementById('req-department').value;
            document.getElementById('cart-req-phone').value = document.getElementById('req-phone').value;
            document.getElementById('cart-req-purpose').value = document.getElementById('req-purpose').value;
        }

        function syncFormDataBack() {
            // Sync data from cart form back to main form
            document.getElementById('req-name').value = document.getElementById('cart-req-name').value;
            document.getElementById('req-position').value = document.getElementById('cart-req-position').value;
            document.getElementById('req-department').value = document.getElementById('cart-req-department').value;
            document.getElementById('req-phone').value = document.getElementById('cart-req-phone').value;
            document.getElementById('req-purpose').value = document.getElementById('cart-req-purpose').value;
        }

        // Global variables for quantity modal
        let currentQuantityItem = null;
        let maxQuantityAvailable = 0;

        // Quantity modal functions
        function showQuantityModal(barcode) {
            const item = sampleData.stock.find(s => s.barcode === barcode);
            if (item) {
                currentQuantityItem = item;
                maxQuantityAvailable = item.quantity;
                
                // Update modal content
                document.getElementById('quantity-item-name').textContent = item.name;
                document.getElementById('quantity-available').textContent = `คงเหลือ: ${item.quantity} ${item.unit}`;
                document.getElementById('quantity-unit').textContent = item.unit;
                document.getElementById('quantity-input').value = '1';
                document.getElementById('quantity-input').max = item.quantity;
                
                // Show modal
                document.getElementById('quantity-modal').classList.remove('hidden');
                
                // Focus on input
                setTimeout(() => {
                    document.getElementById('quantity-input').focus();
                    document.getElementById('quantity-input').select();
                }, 100);
            }
        }

        function decreaseQuantity() {
            const input = document.getElementById('quantity-input');
            const currentValue = parseInt(input.value) || 1;
            if (currentValue > 1) {
                input.value = currentValue - 1;
            }
        }

        function increaseQuantity() {
            const input = document.getElementById('quantity-input');
            const currentValue = parseInt(input.value) || 1;
            if (currentValue < maxQuantityAvailable) {
                input.value = currentValue + 1;
            }
        }

        function confirmQuantitySelection() {
            const quantity = parseInt(document.getElementById('quantity-input').value);
            
            if (!quantity || quantity <= 0) {
                alert('กรุณาระบุจำนวนที่ถูกต้อง');
                return;
            }
            
            if (quantity > maxQuantityAvailable) {
                alert(`จำนวนเกินสต๊อกที่มี (คงเหลือ: ${maxQuantityAvailable} ${currentQuantityItem.unit})`);
                return;
            }
            
            // Add to cart
            const existingIndex = selectedRequestItems.findIndex(i => i.barcode === currentQuantityItem.barcode);
            if (existingIndex >= 0) {
                selectedRequestItems[existingIndex].quantity = quantity;
            } else {
                selectedRequestItems.push({
                    barcode: currentQuantityItem.barcode,
                    name: currentQuantityItem.name,
                    quantity: quantity,
                    unit: currentQuantityItem.unit
                });
            }
            
            updateCartCount();
            if (!document.getElementById('cart-modal').classList.contains('hidden')) {
                updateCartDisplay();
            }
            
            // Close modal
            cancelQuantitySelection();
            
            // Show success message
            const toast = document.createElement('div');
            toast.className = 'fixed top-32 right-6 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300';
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span>เพิ่ม ${currentQuantityItem.name} แล้ว</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }

        function cancelQuantitySelection() {
            document.getElementById('quantity-modal').classList.add('hidden');
            currentQuantityItem = null;
            maxQuantityAvailable = 0;
        }

        // Add keyboard support for quantity modal
        document.addEventListener('keydown', function(event) {
            const quantityModal = document.getElementById('quantity-modal');
            if (!quantityModal.classList.contains('hidden')) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    confirmQuantitySelection();
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    cancelQuantitySelection();
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    increaseQuantity();
                } else if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    decreaseQuantity();
                }
            }
        });

        // Request management
        function addToRequest(barcode) {
            showQuantityModal(barcode);
        }

        function editCartItem(index) {
            const item = selectedRequestItems[index];
            const stockItem = sampleData.stock.find(s => s.barcode === item.barcode);
            const newQuantity = prompt(`แก้ไขจำนวน (คงเหลือ: ${stockItem.quantity} ${item.unit})`, item.quantity);
            
            if (newQuantity && parseInt(newQuantity) > 0 && parseInt(newQuantity) <= stockItem.quantity) {
                selectedRequestItems[index].quantity = parseInt(newQuantity);
                updateCartDisplay();
            } else if (newQuantity) {
                alert('จำนวนไม่ถูกต้อง');
            }
        }

        function removeFromCart(index) {
            selectedRequestItems.splice(index, 1);
            updateCartDisplay();
        }

        function clearCart() {
            if (confirm('ต้องการล้างรายการทั้งหมดในตะกร้าหรือไม่?')) {
                selectedRequestItems = [];
                updateCartDisplay();
            }
        }

        function submitRequestFromCart() {
            const name = document.getElementById('cart-req-name').value;
            const position = document.getElementById('cart-req-position').value;
            const department = document.getElementById('cart-req-department').value;
            const phone = document.getElementById('cart-req-phone').value;
            const purpose = document.getElementById('cart-req-purpose').value;

            if (!name || !position || !department || !phone || !purpose || selectedRequestItems.length === 0) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            // Sync data back to main form
            syncFormDataBack();
            
            // Submit the request
            submitRequest();
        }

        async function submitRequest() {
            const name = document.getElementById('req-name').value;
            const position = document.getElementById('req-position').value;
            const department = document.getElementById('req-department').value;
            const phone = document.getElementById('req-phone').value;
            const purpose = document.getElementById('req-purpose').value;

            if (!name || !position || !department || !phone || !purpose || selectedRequestItems.length === 0) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            try {
                const requestId = 'REQ' + Date.now();
                const currentDate = new Date();
                const request = {
                    id: requestId,
                    requesterName: name, // เพิ่ม field นี้สำหรับแดชบอร์ด
                    name: name,
                    position: position,
                    department: department,
                    phone: phone,
                    purpose: purpose,
                    items: [...selectedRequestItems],
                    status: 'รออนุมัติ', // ใช้ภาษาไทยให้ตรงกับระบบ
                    date: currentDate.toLocaleDateString('th-TH'),
                    timestamp: currentDate.getTime() // เพิ่ม timestamp สำหรับการเรียงลำดับ
                };

                // Save to Firebase
                await saveToFirebase('requests', requestId, request);
                
                // อัปเดตหน้าจัดการใบคำร้องทันทีถ้าผู้ใช้อยู่ในหน้านั้น
                if (typeof loadRequests === 'function') {
                    // เพิ่มรายการใหม่เข้าไปใน sampleData ทันที
                    sampleData.requests.unshift(request); // เพิ่มที่ตำแหน่งแรก
                    
                    // อัปเดตหน้าจัดการใบคำร้องถ้าเปิดอยู่
                    const requestsPage = document.getElementById('requests-page');
                    if (requestsPage && !requestsPage.classList.contains('hidden')) {
                        loadRequests();
                    }
                    
                    // อัปเดตแดชบอร์ดถ้าเปิดอยู่
                    const dashboardPage = document.getElementById('admin-dashboard');
                    if (dashboardPage && !dashboardPage.classList.contains('hidden')) {
                        updateDashboardStats();
                        loadRecentRequests();
                    }
                }
                
                // Close cart modal if open
                document.getElementById('cart-modal').classList.add('hidden');
                
                showRequestReceipt(request);
                
                // Reset form
                document.getElementById('req-name').value = '';
                document.getElementById('req-position').value = '';
                document.getElementById('req-department').value = '';
                document.getElementById('req-phone').value = '';
                document.getElementById('req-purpose').value = '';
                document.getElementById('cart-req-name').value = '';
                document.getElementById('cart-req-position').value = '';
                document.getElementById('cart-req-department').value = '';
                document.getElementById('cart-req-phone').value = '';
                document.getElementById('cart-req-purpose').value = '';
                selectedRequestItems = [];
                updateCartCount();
                
            } catch (error) {
                console.error('Error submitting request:', error);
                alert('เกิดข้อผิดพลาดในการส่งใบคำร้อง กรุณาลองใหม่อีกครั้ง');
            }
        }

        function showRequestReceipt(request) {
            const modal = document.getElementById('request-receipt-modal');
            const content = document.getElementById('request-receipt-content');
            
            const currentDate = new Date();
            const thaiDate = currentDate.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Calculate items per page based on A5 paper size and content
            // A5 paper: 148mm x 210mm, with 12mm padding = 124mm x 186mm usable area
            // First page: ~70mm for header + requester info, ~20mm for footer = ~96mm for items
            // Other pages: ~30mm for header, ~20mm for footer = ~136mm for items
            // Each table row = ~8mm (including borders and padding)
            const itemsPerPageFirst = 5;   // First page has less space due to requester info
            const itemsPerPageOther = 10;  // Other pages have more space
            
            // Calculate total pages needed
            let totalPages = 1;
            let remainingItems = request.items.length;
            
            if (remainingItems > itemsPerPageFirst) {
                remainingItems -= itemsPerPageFirst;
                totalPages += Math.ceil(remainingItems / itemsPerPageOther);
            }
            
            let pagesHTML = '';
            let currentItemIndex = 0;
            
            for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                const isFirstPage = pageNum === 1;
                const isLastPage = pageNum === totalPages;
                const currentPageItemsLimit = isFirstPage ? itemsPerPageFirst : itemsPerPageOther;
                
                const startIndex = currentItemIndex;
                const endIndex = Math.min(currentItemIndex + currentPageItemsLimit, request.items.length);
                const pageItems = request.items.slice(startIndex, endIndex);
                currentItemIndex = endIndex;
                
                pagesHTML += `
                    <div class="receipt-paper" style="font-family: 'Sarabun', sans-serif; width: 148mm; min-height: 210mm; max-height: 210mm; background: white; margin: 0 auto; padding: 12mm; font-size: 12px; line-height: 1.4; color: #000; ${pageNum > 1 ? 'page-break-before: always; margin-top: 20px;' : ''}">
                        <!-- Header -->
                        <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 6mm; margin-bottom: 6mm;">
                            <div style="font-size: 16px; font-weight: 700; margin-bottom: 2mm;">ใบคำร้องขอเบิกวัสดุ</div>
                            <div style="font-size: 12px; margin-bottom: 1mm;">กลุ่มงานระบาดวิทยา</div>
                            <div style="font-size: 12px;">สำนักงานโรคติดต่อทางสาธารณสุข สำนักอนามัย</div>
                            ${totalPages > 1 ? `<div style="font-size: 10px; margin-top: 2mm; color: #666;">หน้าที่ ${pageNum} จาก ${totalPages}</div>` : ''}
                        </div>
                        
                        ${isFirstPage ? `
                        <!-- Document Info -->
                        <div style="margin-bottom: 5mm;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2mm;">
                                <span><strong>เลขที่:</strong> ${request.id}</span>
                                <span><strong>วันที่:</strong> ${thaiDate}</span>
                            </div>
                        </div>
                        
                        <!-- Requester Info -->
                        <div style="margin-bottom: 8mm;">
                            <div style="font-weight: 600; margin-bottom: 4mm; border-bottom: 1px solid #000; padding-bottom: 2mm;">ข้อมูลผู้ขอเบิก</div>
                            <div style="margin-bottom: 3mm;"><strong>ชื่อ-สกุล:</strong> ${request.name}</div>
                            <div style="margin-bottom: 3mm;"><strong>ตำแหน่ง:</strong> ${request.position}</div>
                            <div style="margin-bottom: 3mm;"><strong>หน่วยงาน:</strong> ${request.department}</div>
                            <div style="margin-bottom: 3mm;"><strong>เบอร์โทรศัพท์:</strong> ${request.phone}</div>
                            <div style="margin-bottom: 3mm;"><strong>วัตถุประสงค์การใช้งาน:</strong> ${request.purpose}</div>
                        </div>
                        ` : `
                        <!-- Continuation Info -->
                        <div style="margin-bottom: 8mm;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3mm;">
                                <span><strong>เลขที่:</strong> ${request.id}</span>
                                <span><strong>ผู้ขอเบิก:</strong> ${request.name}</span>
                            </div>
                        </div>
                        `}
                        
                        <!-- Items Table -->
                        <div style="margin-bottom: 8mm;">
                            <div style="font-weight: 600; margin-bottom: 4mm; border-bottom: 1px solid #000; padding-bottom: 2mm;">รายการที่ขอเบิก ${!isFirstPage ? `(ต่อ)` : ''}</div>
                            <table style="width: 100%; border-collapse: collapse; margin: 4mm 0;">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: 600; width: 10%;">ลำดับ</th>
                                        <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: 600; width: 70%;">รายการวัสดุ</th>
                                        <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: 600; width: 10%;">จำนวน</th>
                                        <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: 600; width: 10%;">หน่วย</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pageItems.map((item, index) => `
                                        <tr>
                                            <td style="border: 1px solid #000; padding: 3mm; text-align: center;">${startIndex + index + 1}</td>
                                            <td style="border: 1px solid #000; padding: 3mm;">${item.name}</td>
                                            <td style="border: 1px solid #000; padding: 3mm; text-align: center;">${item.quantity}</td>
                                            <td style="border: 1px solid #000; padding: 3mm; text-align: center;">${item.unit}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${isLastPage ? `
                            <div style="margin-top: 3mm; font-weight: 600;">
                                <strong>รวมรายการทั้งหมด:</strong> ${request.items.length} รายการ
                            </div>
                            ` : `
                            <div style="margin-top: 3mm; font-weight: 600; text-align: right;">
                                <strong>รายการในหน้านี้:</strong> ${pageItems.length} รายการ (ต่อหน้าถัดไป)
                            </div>
                            `}
                        </div>
                        
                        ${isLastPage ? `
                        <!-- Footer Note -->
                        <div style="margin-top: 5mm; text-align: center; font-size: 10px; border-top: 1px solid #000; padding-top: 2mm;">
                            <strong>หมายเหตุ:</strong> กรุณาเก็บใบคำร้องนี้ไว้เป็นหลักฐาน<br>
                            เลขที่อ้างอิง: ${request.id}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            content.innerHTML = pagesHTML;
            modal.classList.remove('hidden');
        }

        function downloadRequestReceipt() {
            const element = document.getElementById('request-receipt-content');
            
            // Get all pages (elements with receipt-paper class)
            const pages = element.querySelectorAll('.receipt-paper');
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a5');
            const pdfWidth = 148; // A5 width in mm
            const pdfHeight = 210; // A5 height in mm
            
            let isFirstPage = true;
            
            // Process each page
            const processPage = (pageIndex) => {
                if (pageIndex >= pages.length) {
                    // All pages processed, save the PDF
                    const filename = `ใบคำร้องขอเบิกวัสดุ_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.pdf`;
                    pdf.save(filename);
                    alert('บันทึกใบคำร้องเป็น PDF สำเร็จ!');
                    return;
                }
                
                const currentPage = pages[pageIndex];
                
                // Configure html2canvas options for current page
                const options = {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: currentPage.scrollWidth,
                    height: currentPage.scrollHeight
                };
                
                html2canvas(currentPage, options).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Add new page if not first page
                    if (!isFirstPage) {
                        pdf.addPage();
                    }
                    isFirstPage = false;
                    
                    // Calculate dimensions to fit A5 page
                    const imgWidth = pdfWidth - 8; // Leave 4mm margin on each side
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // Calculate position (center horizontally, top vertically)
                    const xPosition = (pdfWidth - imgWidth) / 2; // Center horizontally
                    const yPosition = 5; // Reduced top margin to 5mm
                    
                    // Add image to current PDF page
                    pdf.addImage(imgData, 'PNG', xPosition, yPosition, imgWidth, imgHeight);
                    
                    // Process next page
                    processPage(pageIndex + 1);
                }).catch(error => {
                    console.error('Error saving receipt as PDF:', error);
                    alert('เกิดข้อผิดพลาดในการบันทึก PDF');
                });
            };
            
            // Start processing from first page
            processPage(0);
        }

        function closeRequestReceipt() {
            document.getElementById('request-receipt-modal').classList.add('hidden');
        }

        function showWithdrawReceipt(transaction) {
            const modal = document.getElementById('withdraw-receipt-modal');
            const content = document.getElementById('withdraw-receipt-content');
            
            const currentDate = new Date();
            const thaiDate = currentDate.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const thaiTime = currentDate.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Calculate items per page (6 items for first page, 10 items for subsequent pages)
            const firstPageItems = 6;
            const subsequentPageItems = 10;
            
            // Calculate total pages needed
            let totalPages = 1; // At least one page
            let remainingItems = transaction.items.length - firstPageItems;
            if (remainingItems > 0) {
                totalPages += Math.ceil(remainingItems / subsequentPageItems);
            }
            
            let pagesHTML = '';
            
            for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                let startIndex, endIndex, pageItems;
                
                if (pageNum === 1) {
                    // First page: show up to 6 items
                    startIndex = 0;
                    endIndex = Math.min(firstPageItems, transaction.items.length);
                } else {
                    // Subsequent pages: show up to 10 items each
                    startIndex = firstPageItems + (pageNum - 2) * subsequentPageItems;
                    endIndex = Math.min(startIndex + subsequentPageItems, transaction.items.length);
                }
                
                pageItems = transaction.items.slice(startIndex, endIndex);
                const isFirstPage = pageNum === 1;
                const isLastPage = pageNum === totalPages;
                
                pagesHTML += `
                    <div class="receipt-paper" style="${pageNum > 1 ? 'page-break-before: always; margin-top: 20px;' : ''}">
                        <!-- Header -->
                        <div class="receipt-header">
                            <div class="receipt-title">${transaction.groupName ? `ใบเบิกวัสดุ${transaction.groupName}` : 'ใบเบิกวัสดุ'}</div>
                            <div class="receipt-subtitle">กลุ่มงานระบาดวิทยา</div>
                            <div class="receipt-subtitle">สำนักงานโรคติดต่อทางสาธารณสุข สำนักอนามัย</div>
                            ${totalPages > 1 ? `<div style="font-size: 12px; margin-top: 5px; color: #666;">หน้าที่ ${pageNum} จาก ${totalPages}</div>` : ''}
                        </div>
                        
                        ${isFirstPage ? `
                        <!-- Document Info -->
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>เลขที่:</strong> ${transaction.id}</span>
                                <span><strong>วันที่:</strong> ${thaiDate}</span>
                            </div>
                            <div class="receipt-info-row">
                                <span><strong>เวลา:</strong> ${thaiTime} น.</span>
                                <span></span>
                            </div>
                        </div>
                        
                        <!-- Transaction Info -->
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>ผู้เบิก:</strong> ${transaction.name}</span>
                                <span><strong>ตำแหน่ง:</strong> ${transaction.position || 'ไม่ระบุ'}</span>
                            </div>
                            <div class="receipt-info-row">
                                <span><strong>หน่วยงาน:</strong> ${transaction.department || 'ไม่ระบุ'}</span>
                                <span></span>
                            </div>
                            <div class="receipt-info-row">
                                <span><strong>วัตถุประสงค์:</strong> ${transaction.purpose}</span>
                                <span></span>
                            </div>
                        </div>
                        ` : `
                        <!-- Continuation Info -->
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>เลขที่:</strong> ${transaction.id}</span>
                                <span><strong>ผู้เบิก:</strong> ${transaction.name}</span>
                            </div>
                        </div>
                        `}
                        
                        <!-- Items Table -->
                        <div class="receipt-section">
                            <table class="receipt-table">
                                <thead>
                                    <tr>
                                        <th>ลำดับ</th>
                                        <th>รายการวัสดุ</th>
                                        <th>จำนวน</th>
                                        <th>หน่วย</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pageItems.map((item, index) => `
                                        <tr>
                                            <td>${startIndex + index + 1}</td>
                                            <td>${item.name}</td>
                                            <td>${item.quantity}</td>
                                            <td>${item.unit}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        ${isLastPage ? `
                        <!-- Summary -->
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>รวมรายการทั้งหมด:</strong> ${transaction.items.length} รายการ</span>
                                <span></span>
                            </div>
                        </div>
                        ` : `
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>รายการในหน้านี้:</strong> ${pageItems.length} รายการ</span>
                                <span style="font-weight: 600;">(ต่อหน้าถัดไป)</span>
                            </div>
                        </div>
                        `}
                        
                        <!-- Signatures on every page -->
                        <div class="receipt-signature">
                            <div class="signature-box">
                                <div class="signature-line"></div>
                                <div>ผู้เบิก</div>
                                <div style="margin-top: 5px; font-size: 12px;">(${transaction.name})</div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-line"></div>
                                <div>ผู้จ่าย</div>
                                <div style="margin-top: 5px; font-size: 12px;">(${currentUser ? currentUser.name : '.............................'})</div>
                            </div>
                        </div>
                        
                        ${isLastPage ? `
                        <div style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">
                            *** กรุณาเก็บใบเสร็จนี้ไว้เป็นหลักฐาน ***<br>
                            เลขที่อ้างอิง: ${transaction.id}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            content.innerHTML = pagesHTML;
            modal.classList.remove('hidden');
        }

        function showWithdrawReceiptByGroups(transaction) {
            console.log('showWithdrawReceiptByGroups called with transaction:', transaction);
            
            // จัดกลุ่มวัสดุตาม group
            const groupedItems = {};
            
            transaction.items.forEach(item => {
                const stockItem = sampleData.stock.find(s => s.barcode === item.barcode);
                const group = stockItem ? (stockItem.group || 'ไม่ระบุกลุ่ม') : 'ไม่ระบุกลุ่ม';
                
                if (!groupedItems[group]) {
                    groupedItems[group] = [];
                }
                groupedItems[group].push(item);
            });
            
            const groups = Object.keys(groupedItems);
            console.log('Groups found:', groups);
            console.log('Grouped items:', groupedItems);
            
            // สร้างใบเบิกรวมทุกกลุ่มในเอกสารเดียว แต่แยกหน้า (ทั้งกรณี 1 กลุ่มและหลายกลุ่ม)
            let allPagesHTML = '';
            
            groups.forEach((group, groupIndex) => {
                const groupItems = groupedItems[group];
                const groupTransaction = {
                    ...transaction,
                    id: groups.length > 1 ? `${transaction.id}-${String(groupIndex + 1).padStart(2, '0')}` : transaction.id, // เพิ่ม suffix เฉพาะกรณีหลายกลุ่ม
                    items: groupItems,
                    group: group
                };
                
                const pagesHtml = generateReceiptPagesForGroup(groupTransaction, group);
                allPagesHTML += pagesHtml;
            });
            
            // แสดงใบเบิกรวมทั้งหมดในเอกสารเดียว
            const modal = document.getElementById('withdraw-receipt-modal');
            const content = document.getElementById('withdraw-receipt-content');
            
            content.innerHTML = allPagesHTML;
            modal.classList.remove('hidden');
            
            if (groups.length === 1) {
                console.log(`Created single group receipt for group: ${groups[0]}`);
            } else {
                console.log(`Created combined receipt with ${groups.length} groups:`, groups);
            }
        }

        function generateReceiptPagesForGroup(transaction, group) {
            const currentDate = new Date();
            const thaiDate = currentDate.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const thaiTime = currentDate.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Calculate items per page (6 items for first page, 10 items for subsequent pages)
            const firstPageItems = 6;
            const subsequentPageItems = 10;
            
            // Calculate total pages needed
            let totalPages = 1;
            if (transaction.items.length > firstPageItems) {
                const remainingItems = transaction.items.length - firstPageItems;
                totalPages += Math.ceil(remainingItems / subsequentPageItems);
            }
            
            let pagesHTML = '';
            
            for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                let startIndex, endIndex, pageItems;
                
                if (pageNum === 1) {
                    // First page: show up to 6 items
                    startIndex = 0;
                    endIndex = Math.min(firstPageItems, transaction.items.length);
                } else {
                    // Subsequent pages: show up to 10 items each
                    startIndex = firstPageItems + (pageNum - 2) * subsequentPageItems;
                    endIndex = Math.min(startIndex + subsequentPageItems, transaction.items.length);
                }
                
                pageItems = transaction.items.slice(startIndex, endIndex);
                const isFirstPage = pageNum === 1;
                const isLastPage = pageNum === totalPages;
                
                // หัวกระดาษที่แตกต่างกันตามกลุ่ม
                let headerTitle = 'ใบเบิกวัสดุ';
                if (group && group !== 'ไม่ระบุกลุ่ม') {
                    headerTitle = `ใบเบิกวัสดุ - ${group}`;
                }
                
                pagesHTML += `
                    <div class="receipt-paper" style="${pageNum > 1 ? 'page-break-before: always; margin-top: 20px;' : ''}">
                        <!-- Header -->
                        <div class="receipt-header">
                            <div class="receipt-title">${headerTitle}</div>
                            <div class="receipt-subtitle">กลุ่มงานระบาดวิทยา</div>
                            <div class="receipt-subtitle">สำนักงานโรคติดต่อทางสาธารณสุข สำนักอนามัย</div>
                            ${totalPages > 1 ? `<div style="font-size: 12px; margin-top: 5px; color: #666;">หน้าที่ ${pageNum} จาก ${totalPages}</div>` : ''}
                        </div>
                        
                        ${isFirstPage ? `
                        <!-- Document Info -->
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>เลขที่:</strong> ${transaction.id}</span>
                                <span><strong>วันที่:</strong> ${thaiDate}</span>
                            </div>
                            <div class="receipt-info-row">
                                <span><strong>เวลา:</strong> ${thaiTime} น.</span>
                                <span></span>
                            </div>
                        </div>
                        
                        <!-- Transaction Info -->
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>ผู้เบิก:</strong> ${transaction.name}</span>
                                <span><strong>ตำแหน่ง:</strong> ${transaction.position || 'ไม่ระบุ'}</span>
                            </div>
                            <div class="receipt-info-row">
                                <span><strong>หน่วยงาน:</strong> ${transaction.department || 'ไม่ระบุ'}</span>
                                <span></span>
                            </div>
                            <div class="receipt-info-row">
                                <span><strong>วัตถุประสงค์:</strong> ${transaction.purpose}</span>
                                <span></span>
                            </div>
                        </div>
                        ` : `
                        <!-- Continuation Info -->
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>เลขที่:</strong> ${transaction.id}</span>
                                <span><strong>ผู้เบิก:</strong> ${transaction.name}</span>
                            </div>
                        </div>
                        `}
                        
                        <!-- Items Table -->
                        <div class="receipt-section">
                            <table class="receipt-table">
                                <thead>
                                    <tr>
                                        <th>ลำดับ</th>
                                        <th>รายการวัสดุ</th>
                                        <th>จำนวน</th>
                                        <th>หน่วย</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pageItems.map((item, index) => {
                                        const globalIndex = startIndex + index + 1;
                                        return `
                                        <tr>
                                            <td>${globalIndex}</td>
                                            <td>${item.name}</td>
                                            <td>${item.quantity}</td>
                                            <td>${item.unit}</td>
                                        </tr>
                                        `;
                                    }).join('')}
                                    
                                    ${Array.from({ length: Math.max(0, (isFirstPage ? firstPageItems : subsequentPageItems) - pageItems.length) }, (_, i) => `
                                    <tr>
                                        <td>&nbsp;</td>
                                        <td>&nbsp;</td>
                                        <td>&nbsp;</td>
                                        <td>&nbsp;</td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        ${isLastPage ? `
                        <!-- Footer with signatures -->
                        <div class="receipt-signature">
                            <div class="signature-box">
                                <div class="signature-line"></div>
                                <div>ผู้เบิก</div>
                                <div style="margin-top: 5px; font-size: 12px;">(${transaction.name})</div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-line"></div>
                                <div>ผู้จ่าย</div>
                                <div style="margin-top: 5px; font-size: 12px;">(${currentUser ? currentUser.name : '.............................'})</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">
                            *** กรุณาเก็บใบเสร็จนี้ไว้เป็นหลักฐาน ***<br>
                            เลขที่อ้างอิง: ${transaction.id}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            return pagesHTML;
        }

        function saveWithdrawReceiptAsPDF() {
            const element = document.getElementById('withdraw-receipt-content');
            
            // Get all pages (elements with receipt-paper class)
            const pages = element.querySelectorAll('.receipt-paper');
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a5');
            const pdfWidth = 148; // A5 width in mm
            const pdfHeight = 210; // A5 height in mm
            
            let isFirstPage = true;
            
            // Process each page
            const processPage = (pageIndex) => {
                if (pageIndex >= pages.length) {
                    // All pages processed, save the PDF
                    // ตรวจสอบว่ามีหลายกลุ่มหรือไม่จากการตรวจสอบหัวกระดาษ
                    const firstPageTitle = pages[0].querySelector('.receipt-title');
                    const hasMultipleGroups = pages.length > 1 && Array.from(pages).some(page => {
                        const title = page.querySelector('.receipt-title');
                        return title && title.textContent !== firstPageTitle.textContent;
                    });
                    
                    const dateStr = new Date().toLocaleDateString('th-TH').replace(/\//g, '-');
                    const filename = hasMultipleGroups 
                        ? `ใบเสร็จเบิกวัสดุ_หลายกลุ่ม_${dateStr}.pdf`
                        : `ใบเสร็จเบิกวัสดุ_${dateStr}.pdf`;
                    
                    pdf.save(filename);
                    
                    const message = hasMultipleGroups 
                        ? `บันทึกใบเสร็จเป็น PDF สำเร็จ!\n(รวม ${pages.length} หน้า, แยกตามกลุ่มวัสดุ)`
                        : 'บันทึกใบเสร็จเป็น PDF สำเร็จ!';
                    alert(message);
                    return;
                }
                
                const currentPage = pages[pageIndex];
                
                // Configure html2canvas options for current page
                const options = {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: currentPage.scrollWidth,
                    height: currentPage.scrollHeight
                };
                
                html2canvas(currentPage, options).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Add new page if not first page
                    if (!isFirstPage) {
                        pdf.addPage();
                    }
                    isFirstPage = false;
                    
                    // Calculate dimensions to fit A5 page
                    const imgWidth = pdfWidth - 8; // Leave 4mm margin on each side
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // Calculate position (center horizontally, top vertically)
                    const xPosition = (pdfWidth - imgWidth) / 2; // Center horizontally
                    const yPosition = 5; // Reduced top margin to 5mm
                    
                    // Add image to current PDF page
                    pdf.addImage(imgData, 'PNG', xPosition, yPosition, imgWidth, imgHeight);
                    
                    // Process next page
                    processPage(pageIndex + 1);
                }).catch(error => {
                    console.error('Error saving receipt as PDF:', error);
                    alert('เกิดข้อผิดพลาดในการบันทึก PDF');
                });
            };
            
            // Start processing from first page
            processPage(0);
        }

        function closeWithdrawReceipt() {
            document.getElementById('withdraw-receipt-modal').classList.add('hidden');
        }

        function showReceiveReceipt(transaction) {
            const modal = document.getElementById('receive-receipt-modal');
            const content = document.getElementById('receive-receipt-content');
            
            const currentDate = new Date();
            const thaiDate = currentDate.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const thaiTime = currentDate.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Calculate items per page (7 items for first page, 10 items for subsequent pages)
            const firstPageItems = 7;
            const subsequentPageItems = 10;
            
            // Calculate total pages needed
            let totalPages = 1; // At least one page
            let remainingItems = transaction.items.length - firstPageItems;
            if (remainingItems > 0) {
                totalPages += Math.ceil(remainingItems / subsequentPageItems);
            }
            
            let pagesHTML = '';
            
            for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                let startIndex, endIndex, pageItems;
                
                if (pageNum === 1) {
                    // First page: show up to 7 items
                    startIndex = 0;
                    endIndex = Math.min(firstPageItems, transaction.items.length);
                } else {
                    // Subsequent pages: show up to 10 items each
                    startIndex = firstPageItems + (pageNum - 2) * subsequentPageItems;
                    endIndex = Math.min(startIndex + subsequentPageItems, transaction.items.length);
                }
                
                pageItems = transaction.items.slice(startIndex, endIndex);
                const isFirstPage = pageNum === 1;
                const isLastPage = pageNum === totalPages;
                
                pagesHTML += `
                    <div class="receipt-paper" style="${pageNum > 1 ? 'page-break-before: always; margin-top: 20px;' : ''}">
                        <!-- Header -->
                        <div class="receipt-header">
                            <div class="receipt-title">ใบรับวัสดุ</div>
                            <div class="receipt-subtitle">กลุ่มงานระบาดวิทยา</div>
                            <div class="receipt-subtitle">สำนักงานโรคติดต่อทางสาธารณสุข สำนักอนามัย</div>
                            ${totalPages > 1 ? `<div style="font-size: 12px; margin-top: 5px; color: #666;">หน้าที่ ${pageNum} จาก ${totalPages}</div>` : ''}
                        </div>
                        
                        ${isFirstPage ? `
                        <!-- Document Info -->
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>เลขที่:</strong> ${transaction.id}</span>
                                <span><strong>วันที่:</strong> ${thaiDate}</span>
                            </div>
                            <div class="receipt-info-row">
                                <span><strong>เวลา:</strong> ${thaiTime} น.</span>
                                <span></span>
                            </div>
                        </div>
                        
                        <!-- Transaction Info -->
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>แหล่งที่มา:</strong> ${transaction.source}</span>
                                <span></span>
                            </div>
                            <div class="receipt-info-row">
                                <span><strong>ผู้รับ:</strong> ${transaction.receiver}</span>
                                <span></span>
                            </div>
                        </div>
                        ` : `
                        <!-- Continuation Info -->
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>เลขที่:</strong> ${transaction.id}</span>
                                <span><strong>ผู้รับ:</strong> ${transaction.receiver}</span>
                            </div>
                        </div>
                        `}
                        
                        <!-- Items Table -->
                        <div class="receipt-section">
                            <table class="receipt-table">
                                <thead>
                                    <tr>
                                        <th>ลำดับ</th>
                                        <th>รายการวัสดุ</th>
                                        <th>จำนวน</th>
                                        <th>หน่วย</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pageItems.map((item, index) => `
                                        <tr>
                                            <td>${startIndex + index + 1}</td>
                                            <td>${item.name}</td>
                                            <td>${item.quantity}</td>
                                            <td>${item.unit}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        ${isLastPage ? `
                        <!-- Summary -->
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>รวมรายการทั้งหมด:</strong> ${transaction.items.length} รายการ</span>
                                <span></span>
                            </div>
                        </div>
                        ` : `
                        <div class="receipt-section">
                            <div class="receipt-info-row">
                                <span><strong>รายการในหน้านี้:</strong> ${pageItems.length} รายการ</span>
                                <span style="font-weight: 600;">(ต่อหน้าถัดไป)</span>
                            </div>
                        </div>
                        `}
                        
                        <!-- Signatures on every page -->
                        <div class="receipt-signature">
                            <div class="signature-box" style="margin: 0 auto;">
                                <div class="signature-line"></div>
                                <div>ผู้รับ</div>
                                <div style="margin-top: 5px; font-size: 12px;">(${currentUser ? currentUser.name : transaction.receiver})</div>
                            </div>
                        </div>
                        
                        ${isLastPage ? `
                        <div style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">
                            *** กรุณาเก็บใบเสร็จนี้ไว้เป็นหลักฐาน ***<br>
                            เลขที่อ้างอิง: ${transaction.id}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            content.innerHTML = pagesHTML;
            modal.classList.remove('hidden');
        }

        function saveReceiveReceiptAsPDF() {
            const element = document.getElementById('receive-receipt-content');
            
            // Get all pages (elements with receipt-paper class)
            const pages = element.querySelectorAll('.receipt-paper');
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a5');
            const pdfWidth = 148; // A5 width in mm
            const pdfHeight = 210; // A5 height in mm
            
            let isFirstPage = true;
            
            // Process each page
            const processPage = (pageIndex) => {
                if (pageIndex >= pages.length) {
                    // All pages processed, save the PDF
                    const filename = `ใบเสร็จรับวัสดุ_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.pdf`;
                    pdf.save(filename);
                    alert('บันทึกใบเสร็จเป็น PDF สำเร็จ!');
                    return;
                }
                
                const currentPage = pages[pageIndex];
                
                // Configure html2canvas options for current page
                const options = {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: currentPage.scrollWidth,
                    height: currentPage.scrollHeight
                };
                
                html2canvas(currentPage, options).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Add new page if not first page
                    if (!isFirstPage) {
                        pdf.addPage();
                    }
                    isFirstPage = false;
                    
                    // Calculate dimensions to fit A5 page
                    const imgWidth = pdfWidth - 8; // Leave 4mm margin on each side
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // Calculate position (center horizontally, top vertically)
                    const xPosition = (pdfWidth - imgWidth) / 2; // Center horizontally
                    const yPosition = 5; // Reduced top margin to 5mm
                    
                    // Add image to current PDF page
                    pdf.addImage(imgData, 'PNG', xPosition, yPosition, imgWidth, imgHeight);
                    
                    // Process next page
                    processPage(pageIndex + 1);
                }).catch(error => {
                    console.error('Error saving receipt as PDF:', error);
                    alert('เกิดข้อผิดพลาดในการบันทึก PDF');
                });
            };
            
            // Start processing from first page
            processPage(0);
        }

        function closeReceiveReceipt() {
            document.getElementById('receive-receipt-modal').classList.add('hidden');
        }

        // Staff management
        function loadStaffInfo(staffId) {
            const staff = sampleData.staff.find(s => s.id === staffId);
            if (staff) {
                document.getElementById('withdraw-name').value = staff.name;
                document.getElementById('withdraw-position').value = staff.position;
                document.getElementById('withdraw-department').value = staff.department;
            }
        }

        // Barcode scanning functions
        function handleBarcodeInput(event) {
            console.log('handleBarcodeInput called, key:', event.key);
            if (event.key === 'Enter') {
                event.preventDefault();
                const barcode = event.target.value.trim();
                console.log('Enter pressed, barcode:', barcode);
                if (barcode) {
                    // ตรวจสอบว่ามีวัสดุในระบบหรือไม่
                    const item = sampleData.stock.find(s => s.barcode === barcode);
                    console.log('Found item:', item);
                    if (item) {
                        // เพิ่มลงในรายการเบิกทันที
                        console.log('Calling addDirectToWithdrawList with barcode:', barcode);
                        addDirectToWithdrawList(barcode);
                    } else {
                        alert('ไม่พบวัสดุรหัสนี้ในระบบ');
                        event.target.focus();
                        event.target.select();
                    }
                } else {
                    console.log('Barcode is empty');
                }
            }
        }

        function addDirectToWithdrawList(barcode) {
            console.log('addDirectToWithdrawList called with barcode:', barcode);
            const item = sampleData.stock.find(s => s.barcode === barcode);
            const quantity = parseInt(document.getElementById('withdraw-quantity').value) || 1;
            
            console.log('Found item:', item);
            console.log('Quantity:', quantity);
            
            if (!item) {
                alert('ไม่พบวัสดุรหัสนี้ในระบบ');
                return;
            }
            
            // ตรวจสอบว่าวัสดุมี showInRequest = true และ quantity > 0
            if (item.showInRequest === false) {
                alert('วัสดุนี้ไม่อนุญาตให้เบิก');
                return;
            }
            
            if (item.quantity <= 0) {
                alert('วัสดุหมดสต๊อก');
                return;
            }
            
            if (quantity > item.quantity) {
                alert(`จำนวนเกินสต๊อก (คงเหลือ: ${item.quantity} ${item.unit})`);
                return;
            }
            
            console.log('All validations passed, adding to withdraw list');
            
            // ตรวจสอบว่าเคยเพิ่มแล้วหรือไม่
            const existingIndex = withdrawItems.findIndex(i => i.barcode === barcode);
            if (existingIndex >= 0) {
                // อัปเดตจำนวนสำหรับรายการที่มีอยู่แล้ว
                const newQuantity = withdrawItems[existingIndex].quantity + quantity;
                if (newQuantity <= item.quantity) {
                    withdrawItems[existingIndex].quantity = newQuantity;
                    console.log('Updated existing item quantity to:', newQuantity);
                } else {
                    alert(`จำนวนรวมเกินสต๊อก (คงเหลือ: ${item.quantity} ${item.unit})`);
                    return;
                }
            } else {
                // เพิ่มรายการใหม่
                const newItem = {
                    barcode: barcode,
                    name: item.name,
                    quantity: quantity,
                    unit: item.unit,
                    available: item.quantity
                };
                withdrawItems.push(newItem);
                console.log('Added new item to withdrawItems:', newItem);
                console.log('withdrawItems length:', withdrawItems.length);
            }
            
            // อัปเดตการแสดงผล
            console.log('Calling updateWithdrawItems');
            updateWithdrawItems();
            
            // ล้างฟิลด์และโฟกัสกลับไปที่ช่องบาร์โค้ด
            document.getElementById('material-barcode').value = '';
            document.getElementById('withdraw-quantity').value = '1';
            document.getElementById('barcode-info').innerHTML = '';
            document.getElementById('material-barcode').focus();
            
            console.log('เพิ่มวัสดุสำเร็จ:', item.name, 'จำนวน:', quantity);
        }

        function handleBarcodeChange(barcode) {
            const infoDiv = document.getElementById('barcode-info');
            if (barcode.trim()) {
                const item = sampleData.stock.find(s => s.barcode === barcode.trim());
                if (item) {
                    // ตรวจสอบสถานะของวัสดุ
                    if (item.showInRequest === false) {
                        infoDiv.innerHTML = `<span class="text-orange-600">⚠ วัสดุ: ${item.name} (ไม่อนุญาตให้เบิก)</span>`;
                        infoDiv.className = 'mt-2 text-sm text-orange-600';
                    } else if (item.quantity <= 0) {
                        infoDiv.innerHTML = `<span class="text-red-600">✗ วัสดุ: ${item.name} (หมดสต๊อก)</span>`;
                        infoDiv.className = 'mt-2 text-sm text-red-600';
                    } else {
                        const groupText = item.group ? ` (กลุ่ม: ${item.group})` : '';
                        infoDiv.innerHTML = `<span class="text-green-600">✓ พบวัสดุ: ${item.name} (คงเหลือ: ${item.quantity} ${item.unit})${groupText}</span>`;
                        infoDiv.className = 'mt-2 text-sm text-green-600';
                    }
                } else {
                    infoDiv.innerHTML = `<span class="text-red-600">✗ ไม่พบวัสดุรหัส: ${barcode.trim()}</span>`;
                    infoDiv.className = 'mt-2 text-sm text-red-600';
                }
            } else {
                infoDiv.innerHTML = '';
            }
        }

        function updateWithdrawItems() {
            console.log('updateWithdrawItems called, withdrawItems:', withdrawItems);
            const container = document.getElementById('withdraw-items');
            const totalElement = document.getElementById('withdraw-total');
            
            if (!container) {
                console.error('withdraw-items container not found');
                return;
            }
            
            if (withdrawItems.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">ยังไม่มีรายการเบิก</p>';
                if (totalElement) {
                    totalElement.textContent = 'รวม: 0 รายการ';
                }
                return;
            }
            
            // แสดงจำนวนใบเบิกที่จะสร้างตามกลุ่ม
            const groups = [...new Set(withdrawItems.map(item => {
                const stockItem = sampleData.stock.find(s => s.barcode === item.barcode);
                return stockItem ? (stockItem.group || 'ไม่ระบุกลุ่ม') : 'ไม่ระบุกลุ่ม';
            }))];
            const groupCount = groups.length;
            
            let html = '<div class="space-y-3">';
            
            // แสดงข้อมูลจำนวนใบเบิก
            if (groupCount > 1) {
                html += `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <p class="text-blue-800 text-sm font-medium">
                            💡 จะสร้างใบเบิก ${groupCount} ใบ แยกตามกลุ่ม: ${groups.join(', ')}
                        </p>
                    </div>
                `;
            }
            
            withdrawItems.forEach((item, index) => {
                const stockItem = sampleData.stock.find(s => s.barcode === item.barcode);
                const group = stockItem ? (stockItem.group || 'ไม่ระบุกลุ่ม') : 'ไม่ระบุกลุ่ม';
                
                html += `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 flex justify-between items-center">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${item.name}</div>
                            <div class="text-sm text-gray-600">รหัส: ${item.barcode}</div>
                            <div class="text-sm text-gray-600">กลุ่ม: ${group}</div>
                            <div class="text-sm text-gray-500">คงเหลือ: ${item.available} ${item.unit}</div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="text-center">
                                <div class="text-lg font-bold text-primary">${item.quantity}</div>
                                <div class="text-xs text-gray-500">${item.unit}</div>
                            </div>
                            <button onclick="removeFromWithdrawList(${index})" 
                                    class="text-red-600 hover:text-red-800 p-1 rounded">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // อัปเดตจำนวนรวม
            if (totalElement) {
                totalElement.textContent = `รวม: ${withdrawItems.length} รายการ`;
            }
            
            console.log('Updated withdraw items display');
        }

        function removeFromWithdrawList(index) {
            if (index >= 0 && index < withdrawItems.length) {
                const removed = withdrawItems.splice(index, 1)[0];
                console.log('Removed item from withdraw list:', removed);
                updateWithdrawItems();
            }
        }

        function getAvailableStock(barcode) {
            const item = sampleData.stock.find(s => s.barcode === barcode);
            return item ? item.quantity : 0;
        }

        function updateWithdrawQuantity(index, newQuantity) {
            const quantity = parseInt(newQuantity);
            const item = withdrawItems[index];
            const availableStock = getAvailableStock(item.barcode);
            
            if (quantity > 0 && quantity <= availableStock) {
                withdrawItems[index].quantity = quantity;
            } else {
                alert(`จำนวนไม่ถูกต้อง (สามารถเบิกได้สูงสุด ${availableStock} ${item.unit})`);
                updateWithdrawItems(); // Refresh to reset the input
            }
        }

        // Withdraw management
        function addToWithdrawList() {
            const barcode = document.getElementById('material-barcode').value.trim();
            if (barcode) {
                addDirectToWithdrawList(barcode);
            } else {
                alert('กรุณาสแกนหรือพิมพ์รหัสบาร์โค้ด');
                document.getElementById('material-barcode').focus();
            }
        }

        function removeFromWithdraw(index) {
            withdrawItems.splice(index, 1);
            updateWithdrawItems();
        }

        async function processWithdraw() {
            console.log('processWithdraw started');
            
            const name = document.getElementById('withdraw-name').value;
            const position = document.getElementById('withdraw-position').value;
            const department = document.getElementById('withdraw-department').value;
            const purpose = document.getElementById('withdraw-purpose').value;
            
            console.log('Form values:', { name, position, department, purpose });
            console.log('withdrawItems:', withdrawItems);
            
            if (!name || !purpose || withdrawItems.length === 0) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            try {
                console.log('Starting stock update...');
                
                // Update stock in Firebase
                for (const item of withdrawItems) {
                    console.log('Processing item:', item);
                    const stockItem = sampleData.stock.find(s => s.barcode === item.barcode);
                    if (stockItem) {
                        console.log('Found stock item:', stockItem);
                        console.log('Original quantity:', stockItem.quantity, 'Withdraw quantity:', item.quantity);
                        
                        stockItem.quantity -= item.quantity;
                        console.log('New quantity:', stockItem.quantity);
                        
                        await saveToFirebase('stock', item.barcode, stockItem);
                        console.log('Stock updated successfully for:', item.barcode);
                    } else {
                        console.error('Stock item not found for barcode:', item.barcode);
                    }
                }

                console.log('Creating transaction record...');
                
                // Add to history
                const transactionId = 'WD' + Date.now();
                const currentDate = new Date();
                const transaction = {
                    id: transactionId,
                    type: 'withdraw',
                    name: name,
                    position: position,
                    department: department,
                    purpose: purpose,
                    items: [...withdrawItems],
                    date: currentDate.toLocaleDateString('th-TH'),
                    time: currentDate.toLocaleTimeString('th-TH'),
                    timestamp: currentDate.getTime() // เพิ่ม timestamp สำหรับการเรียงลำดับ
                };
                
                console.log('Transaction to save:', transaction);
                
                await saveToFirebase('history', transactionId, transaction);
                console.log('Transaction saved successfully');
                
                // Show receipt - แยกตามกลุ่มวัสดุ
                console.log('Showing receipt...');
                showWithdrawReceiptByGroups(transaction);
                
                // Reset form
                console.log('Resetting form...');
                document.getElementById('withdraw-name').value = '';
                document.getElementById('withdraw-position').value = '';
                document.getElementById('withdraw-department').value = '';
                document.getElementById('withdraw-purpose').value = '';
                document.getElementById('staff-barcode').value = '';
                withdrawItems = [];
                updateWithdrawItems();
                loadStock();
                
                console.log('processWithdraw completed successfully');
                
            } catch (error) {
                console.error('Error processing withdraw:', error);
                console.error('Error stack:', error.stack);
                alert(`เกิดข้อผิดพลาดในการเบิกวัสดุ: ${error.message}\nกรุณาลองใหม่อีกครั้ง`);
            }
        }

        // Receive management
        function handleReceiveBarcodeInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const barcode = event.target.value.trim();
                if (barcode) {
                    addMaterialToReceive(barcode);
                    // Auto-add to list if material found
                    setTimeout(() => {
                        if (document.getElementById('receive-barcode').getAttribute('data-name')) {
                            addToReceiveList();
                        }
                    }, 100);
                }
            }
        }

        function handleReceiveBarcodeChange(barcode) {
            const infoDiv = document.getElementById('receive-barcode-info');
            if (barcode.trim()) {
                const item = sampleData.stock.find(s => s.barcode === barcode.trim());
                if (item) {
                    infoDiv.innerHTML = `<span class="text-green-600">✓ พบวัสดุ: ${item.name} (คงเหลือ: ${item.quantity} ${item.unit})</span>`;
                    infoDiv.className = 'mt-2 text-sm text-green-600';
                } else {
                    infoDiv.innerHTML = `<span class="text-orange-600">⚠ วัสดุใหม่: ${barcode.trim()} (จะเพิ่มเป็นรายการใหม่)</span>`;
                    infoDiv.className = 'mt-2 text-sm text-orange-600';
                }
            } else {
                infoDiv.innerHTML = '';
            }
        }

        function addMaterialToReceive(barcode) {
            const item = sampleData.stock.find(s => s.barcode === barcode);
            if (item) {
                document.getElementById('receive-barcode').setAttribute('data-name', item.name);
                document.getElementById('receive-barcode').setAttribute('data-unit', item.unit);
            }
        }

        function updateReceiveQuantity(index, newQuantity) {
            const quantity = parseInt(newQuantity);
            if (quantity > 0) {
                receiveItems[index].quantity = quantity;
            } else {
                alert('จำนวนต้องมากกว่า 0');
                updateReceiveItems(); // Refresh to reset the input
            }
        }

        function addToReceiveList() {
            const barcode = document.getElementById('receive-barcode').value.trim();
            const quantity = parseInt(document.getElementById('receive-quantity').value) || 1;
            const item = sampleData.stock.find(s => s.barcode === barcode);
            
            if (!barcode) {
                alert('กรุณาสแกนหรือพิมพ์รหัสบาร์โค้ด');
                return;
            }
            
            if (quantity <= 0) {
                alert('จำนวนต้องมากกว่า 0');
                document.getElementById('receive-quantity').focus();
                document.getElementById('receive-quantity').select();
                return;
            }
            
            if (item) {
                // Existing material
                const existingIndex = receiveItems.findIndex(i => i.barcode === barcode);
                if (existingIndex >= 0) {
                    receiveItems[existingIndex].quantity += quantity;
                } else {
                    receiveItems.push({
                        barcode: barcode,
                        name: item.name,
                        quantity: quantity,
                        unit: item.unit
                    });
                }
            } else {
                // New material - prompt for details
                const name = prompt(`ชื่อวัสดุสำหรับรหัส ${barcode}:`);
                const unit = prompt('หน่วย (เช่น ชิ้น, กล่อง, ขวด):');
                const category = prompt('หมวดหมู่:');
                
                if (name && unit && category) {
                    // Add to stock first
                    const newStockItem = {
                        barcode: barcode,
                        category: category,
                        name: name,
                        quantity: 0, // Will be updated when processing receive
                        unit: unit,
                        expiry: null
                    };
                    
                    // Add to local data immediately for UI
                    sampleData.stock.push(newStockItem);
                    
                    // Add to receive list
                    receiveItems.push({
                        barcode: barcode,
                        name: name,
                        quantity: quantity,
                        unit: unit
                    });
                } else {
                    alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                    return;
                }
            }
            
            updateReceiveItems();
            
            // Clear inputs and focus back to barcode field for continuous scanning
            document.getElementById('receive-barcode').value = '';
            document.getElementById('receive-quantity').value = '1';
            document.getElementById('receive-barcode-info').innerHTML = '';
            document.getElementById('receive-barcode').focus();
        }

        function updateReceiveItems() {
            const container = document.getElementById('receive-items');
            if (receiveItems.length === 0) {
                container.innerHTML = '<p class="text-gray-500">ยังไม่มีรายการรับ</p>';
            } else {
                container.innerHTML = receiveItems.map((item, index) => `
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg border-2 border-gray-200 mb-3 hover:border-primary transition-all">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${item.name}</div>
                            <div class="text-sm text-gray-500">รหัส: ${item.barcode}</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-gray-700">จำนวน:</label>
                                <input type="number" value="${item.quantity}" min="1" 
                                       class="w-16 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:border-primary text-center"
                                       onchange="updateReceiveQuantity(${index}, this.value)">
                                <span class="text-sm text-gray-600">${item.unit}</span>
                            </div>
                            <button onclick="removeFromReceive(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-all">ลบ</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function removeFromReceive(index) {
            receiveItems.splice(index, 1);
            updateReceiveItems();
        }

        async function processReceive() {
            const source = document.getElementById('receive-source').value;
            const receiver = currentUser ? currentUser.name : 'ไม่ระบุ'; // ใช้ชื่อจากบัญชีที่เข้าสู่ระบบ
            
            if (!source || receiveItems.length === 0) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            try {
                // Update stock in Firebase
                for (const item of receiveItems) {
                    const stockItem = sampleData.stock.find(s => s.barcode === item.barcode);
                    if (stockItem) {
                        stockItem.quantity += item.quantity;
                        await saveToFirebase('stock', item.barcode, stockItem);
                    }
                }

                // Add to history
                const transactionId = 'RC' + Date.now();
                const currentDate = new Date();
                const transaction = {
                    id: transactionId,
                    type: 'receive',
                    source: source,
                    receiver: receiver,
                    items: [...receiveItems],
                    date: currentDate.toLocaleDateString('th-TH'),
                    time: currentDate.toLocaleTimeString('th-TH'),
                    timestamp: currentDate.getTime() // เพิ่ม timestamp สำหรับการเรียงลำดับ
                };
                
                await saveToFirebase('history', transactionId, transaction);
                
                // Show receipt
                showReceiveReceipt(transaction);
                
                // Reset form
                document.getElementById('receive-source').value = '';
                receiveItems = [];
                updateReceiveItems();
                loadStock();
                
            } catch (error) {
                console.error('Error processing receive:', error);
                alert('เกิดข้อผิดพลาดในการรับวัสดุ กรุณาลองใหม่อีกครั้ง');
            }
        }

        // Load data functions
        function loadRequests() {
            const container = document.getElementById('requests-list');
            const resultsCount = document.getElementById('requests-results-count');
            
            if (sampleData.requests.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="bg-gray-100 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-lg">ไม่มีใบคำร้อง</p>
                        <p class="text-gray-400 text-sm mt-2">ยังไม่มีใบคำร้องขอเบิกในระบบ</p>
                    </div>
                `;
                resultsCount.textContent = 'ไม่มีรายการ';
            } else {
                // Sort requests by timestamp (newest first)
                const sortedRequests = [...sampleData.requests].sort((a, b) => {
                    // ใช้ timestamp ถ้ามี ถ้าไม่มีให้แปลงจาก date string หรือใช้ ID เป็นตัวกำหนด
                    let timestampA, timestampB;
                    
                    if (a.timestamp) {
                        timestampA = a.timestamp;
                    } else if (a.date) {
                        // พยายามแปลง date string เป็น timestamp
                        const dateA = new Date(a.date);
                        timestampA = isNaN(dateA.getTime()) ? parseInt(a.id.replace('REQ', '')) : dateA.getTime();
                    } else {
                        // ใช้ ID เป็นตัวกำหนดลำดับ (ID มีรูปแบบ REQ + timestamp)
                        timestampA = parseInt(a.id.replace('REQ', '')) || 0;
                    }
                    
                    if (b.timestamp) {
                        timestampB = b.timestamp;
                    } else if (b.date) {
                        // พยายามแปลง date string เป็น timestamp
                        const dateB = new Date(b.date);
                        timestampB = isNaN(dateB.getTime()) ? parseInt(b.id.replace('REQ', '')) : dateB.getTime();
                    } else {
                        // ใช้ ID เป็นตัวกำหนดลำดับ (ID มีรูปแบบ REQ + timestamp)
                        timestampB = parseInt(b.id.replace('REQ', '')) || 0;
                    }
                    
                    return timestampB - timestampA; // เรียงจากใหม่ล่าสุดไปเก่าที่สุด
                });

                container.innerHTML = sortedRequests.map(request => {
                    const statusInfo = getRequestStatusInfo(request.status);
                    
                    return `
                        <div class="card p-6 hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="bg-gradient-to-br ${statusInfo.bgColor} p-3 rounded-full mr-4">
                                    <svg class="w-6 h-6 ${statusInfo.iconColor}" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-gray-800">ใบคำร้องขอเบิก</h3>
                                    <p class="text-sm text-gray-500">เลขที่: ${request.id}</p>
                                </div>
                                <div class="text-right">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusInfo.badgeClass}">
                                        ${statusInfo.text}
                                    </span>
                                    <p class="text-xs text-gray-500 mt-1">${request.date || 'ไม่ระบุวันที่'}</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3 mb-6">
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-gray-700">ผู้ขอ: ${request.name}</span>
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-gray-700">หน่วยงาน: ${request.department}</span>
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-gray-700">วัตถุประสงค์: ${request.purpose}</span>
                                </div>
                                
                                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                                    <p class="text-sm font-medium text-gray-700 mb-2">รายการวัสดุ (${request.items.length} รายการ):</p>
                                    <div class="space-y-1">
                                        ${request.items.slice(0, 3).map(item => `
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-600">${item.name}</span>
                                                <span class="text-gray-700 font-medium">${item.quantity} ${item.unit}</span>
                                            </div>
                                        `).join('')}
                                        ${request.items.length > 3 ? `
                                            <div class="text-xs text-gray-500 text-center mt-2">
                                                และอีก ${request.items.length - 3} รายการ
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">เปลี่ยนสถานะ</label>
                                    <select onchange="changeRequestStatus('${request.id}', this.value)" 
                                            class="w-full text-sm bg-white border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                                        <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>รอพิจารณา</option>
                                        <option value="approved" ${request.status === 'approved' ? 'selected' : ''}>อนุมัติ</option>
                                        <option value="rejected" ${request.status === 'rejected' ? 'selected' : ''}>ไม่อนุมัติ</option>
                                    </select>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="showRequestDetail('${request.id}')" 
                                            class="btn btn-secondary flex-1 py-2 text-sm flex items-center justify-center space-x-2">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                                            <path fill-rule="evenodd" d="M3 8a2 2 0 012-2v9a2 2 0 002 2h6a2 2 0 002-2V6a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span>ดูใบคำร้อง</span>
                                    </button>
                                    ${request.status === 'approved' ? `
                                        <button onclick="processApprovedRequest('${request.id}')" 
                                                class="btn bg-blue-600 hover:bg-blue-700 text-white flex-1 py-2 text-sm flex items-center justify-center space-x-2">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                            </svg>
                                            <span>ดำเนินการเบิก</span>
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteRequest('${request.id}')" 
                                            class="btn bg-red-600 hover:bg-red-700 text-white py-2 px-4 text-sm flex items-center justify-center space-x-2">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span>ลบ</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Update results count
                resultsCount.textContent = `แสดงทั้งหมด ${sampleData.requests.length} รายการ`;
            }
        }

        function getRequestStatusInfo(status) {
            switch (status) {
                case 'pending':
                    return {
                        text: 'รออนุมัติ',
                        bgColor: 'from-yellow-100 to-yellow-50',
                        iconColor: 'text-yellow-600',
                        badgeClass: 'bg-yellow-100 text-yellow-800'
                    };
                case 'approved':
                    return {
                        text: 'อนุมัติ',
                        bgColor: 'from-green-100 to-green-50',
                        iconColor: 'text-green-600',
                        badgeClass: 'bg-green-100 text-green-800'
                    };
                case 'rejected':
                    return {
                        text: 'ไม่อนุมัติ',
                        bgColor: 'from-red-100 to-red-50',
                        iconColor: 'text-red-600',
                        badgeClass: 'bg-red-100 text-red-800'
                    };
                default:
                    return {
                        text: 'ไม่ทราบสถานะ',
                        bgColor: 'from-gray-100 to-gray-50',
                        iconColor: 'text-gray-600',
                        badgeClass: 'bg-gray-100 text-gray-800'
                    };
            }
        }

        async function changeRequestStatus(requestId, newStatus) {
            try {
                const request = sampleData.requests.find(r => r.id === requestId);
                if (request) {
                    const oldStatus = request.status;
                    request.status = newStatus;
                    await saveToFirebase('requests', requestId, request);
                    
                    // Show appropriate message
                    let message = '';
                    switch(newStatus) {
                        case 'approved':
                            message = 'อนุมัติใบคำร้องแล้ว';
                            break;
                        case 'rejected':
                            message = 'ไม่อนุมัติใบคำร้อง';
                            break;
                        case 'pending':
                            message = 'เปลี่ยนสถานะเป็นรอพิจารณาแล้ว';
                            break;
                    }
                    
                    // Refresh the display with current filters
                    filterRequests();
                    alert(message);
                }
            } catch (error) {
                console.error('Error changing request status:', error);
                alert('เกิดข้อผิดพลาดในการเปลี่ยนสถานะใบคำร้อง');
            }
        }

        async function processApprovedRequest(requestId) {
            try {
                const request = sampleData.requests.find(r => r.id === requestId);
                if (request && request.status === 'approved') {
                    // Auto-fill withdraw form
                    document.getElementById('withdraw-name').value = request.name;
                    document.getElementById('withdraw-position').value = request.position;
                    document.getElementById('withdraw-department').value = request.department;
                    document.getElementById('withdraw-purpose').value = request.purpose;
                    withdrawItems = [...request.items];
                    updateWithdrawItems();
                    showWithdraw();
                    alert('ข้อมูลใบคำร้องถูกนำเข้าสู่หน้าเบิกวัสดุแล้ว');
                }
            } catch (error) {
                console.error('Error processing approved request:', error);
                alert('เกิดข้อผิดพลาดในการดำเนินการใบคำร้อง');
            }
        }

        async function approveRequest(requestId) {
            try {
                const request = sampleData.requests.find(r => r.id === requestId);
                if (request) {
                    request.status = 'approved';
                    await saveToFirebase('requests', requestId, request);
                    
                    // Auto-fill withdraw form
                    document.getElementById('withdraw-name').value = request.name;
                    document.getElementById('withdraw-position').value = request.position;
                    document.getElementById('withdraw-department').value = request.department;
                    document.getElementById('withdraw-purpose').value = request.purpose;
                    withdrawItems = [...request.items];
                    updateWithdrawItems();
                    showWithdraw();
                    alert('อนุมัติใบคำร้องแล้ว กรุณาดำเนินการเบิกวัสดุ');
                }
            } catch (error) {
                console.error('Error approving request:', error);
                alert('เกิดข้อผิดพลาดในการอนุมัติใบคำร้อง');
            }
        }

        async function rejectRequest(requestId) {
            try {
                const request = sampleData.requests.find(r => r.id === requestId);
                if (request) {
                    request.status = 'rejected';
                    await saveToFirebase('requests', requestId, request);
                    filterRequests();
                    alert('ไม่อนุมัติใบคำร้อง');
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert('เกิดข้อผิดพลาดในการปฏิเสธใบคำร้อง');
            }
        }

        async function deleteRequest(requestId) {
            if (confirm('ต้องการลบใบคำร้องนี้หรือไม่?')) {
                try {
                    await deleteFromFirebase('requests', requestId);
                    filterRequests();
                } catch (error) {
                    console.error('Error deleting request:', error);
                    alert('เกิดข้อผิดพลาดในการลบใบคำร้อง');
                }
            }
        }

        function showRequestDetail(requestId) {
            const request = sampleData.requests.find(r => r.id === requestId);
            if (!request) {
                alert('ไม่พบใบคำร้องนี้');
                return;
            }

            const modal = document.getElementById('request-detail-modal');
            const content = document.getElementById('request-detail-content');
            
            const currentDate = new Date();
            const thaiDate = currentDate.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Calculate items per page based on A5 paper size and content
            // A5 paper: 148mm x 210mm, with 12mm padding = 124mm x 186mm usable area
            // First page: ~70mm for header + requester info, ~20mm for footer = ~96mm for items
            // Other pages: ~30mm for header, ~20mm for footer = ~136mm for items
            // Each table row = ~8mm (including borders and padding)
            const itemsPerPageFirst = 5;   // First page has less space due to requester info
            const itemsPerPageOther = 10;  // Other pages have more space
            
            // Calculate total pages needed
            let totalPages = 1;
            let remainingItems = request.items.length;
            
            if (remainingItems > itemsPerPageFirst) {
                remainingItems -= itemsPerPageFirst;
                totalPages += Math.ceil(remainingItems / itemsPerPageOther);
            }
            
            let pagesHTML = '';
            let currentItemIndex = 0;
            
            for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                const isFirstPage = pageNum === 1;
                const isLastPage = pageNum === totalPages;
                const currentPageItemsLimit = isFirstPage ? itemsPerPageFirst : itemsPerPageOther;
                
                const startIndex = currentItemIndex;
                const endIndex = Math.min(currentItemIndex + currentPageItemsLimit, request.items.length);
                const pageItems = request.items.slice(startIndex, endIndex);
                currentItemIndex = endIndex;
                
                pagesHTML += `
                    <div class="receipt-paper" style="font-family: 'Sarabun', sans-serif; width: 148mm; min-height: 210mm; max-height: 210mm; background: white; margin: 0 auto; padding: 12mm; font-size: 12px; line-height: 1.4; color: #000; ${pageNum > 1 ? 'page-break-before: always; margin-top: 20px;' : ''}">
                        <!-- Header -->
                        <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 6mm; margin-bottom: 6mm;">
                            <div style="font-size: 16px; font-weight: 700; margin-bottom: 2mm;">ใบคำร้องขอเบิกวัสดุ</div>
                            <div style="font-size: 12px; margin-bottom: 1mm;">กลุ่มงานระบาดวิทยา</div>
                            <div style="font-size: 12px;">สำนักงานโรคติดต่อทางสาธารณสุข สำนักอนามัย</div>
                            ${totalPages > 1 ? `<div style="font-size: 10px; margin-top: 2mm; color: #666;">หน้าที่ ${pageNum} จาก ${totalPages}</div>` : ''}
                        </div>
                        
                        ${isFirstPage ? `
                        <!-- Document Info -->
                        <div style="margin-bottom: 5mm;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2mm;">
                                <span><strong>เลขที่:</strong> ${request.id}</span>
                                <span><strong>วันที่:</strong> ${thaiDate}</span>
                            </div>
                        </div>
                        
                        <!-- Requester Info -->
                        <div style="margin-bottom: 8mm;">
                            <div style="font-weight: 600; margin-bottom: 4mm; border-bottom: 1px solid #000; padding-bottom: 2mm;">ข้อมูลผู้ขอเบิก</div>
                            <div style="margin-bottom: 3mm;"><strong>ชื่อ-สกุล:</strong> ${request.name}</div>
                            <div style="margin-bottom: 3mm;"><strong>ตำแหน่ง:</strong> ${request.position}</div>
                            <div style="margin-bottom: 3mm;"><strong>หน่วยงาน:</strong> ${request.department}</div>
                            <div style="margin-bottom: 3mm;"><strong>เบอร์โทรศัพท์:</strong> ${request.phone}</div>
                            <div style="margin-bottom: 3mm;"><strong>วัตถุประสงค์การใช้งาน:</strong> ${request.purpose}</div>
                        </div>
                        ` : `
                        <!-- Continuation Info -->
                        <div style="margin-bottom: 8mm;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3mm;">
                                <span><strong>เลขที่:</strong> ${request.id}</span>
                                <span><strong>ผู้ขอเบิก:</strong> ${request.name}</span>
                            </div>
                        </div>
                        `}
                        
                        <!-- Items Table -->
                        <div style="margin-bottom: 8mm;">
                            <div style="font-weight: 600; margin-bottom: 4mm; border-bottom: 1px solid #000; padding-bottom: 2mm;">รายการที่ขอเบิก ${!isFirstPage ? `(ต่อ)` : ''}</div>
                            <table style="width: 100%; border-collapse: collapse; margin: 4mm 0;">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: 600; width: 10%;">ลำดับ</th>
                                        <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: 600; width: 70%;">รายการวัสดุ</th>
                                        <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: 600; width: 10%;">จำนวน</th>
                                        <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: 600; width: 10%;">หน่วย</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pageItems.map((item, index) => `
                                        <tr>
                                            <td style="border: 1px solid #000; padding: 3mm; text-align: center;">${startIndex + index + 1}</td>
                                            <td style="border: 1px solid #000; padding: 3mm;">${item.name}</td>
                                            <td style="border: 1px solid #000; padding: 3mm; text-align: center;">${item.quantity}</td>
                                            <td style="border: 1px solid #000; padding: 3mm; text-align: center;">${item.unit}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${isLastPage ? `
                            <div style="margin-top: 3mm; font-weight: 600;">
                                <strong>รวมรายการทั้งหมด:</strong> ${request.items.length} รายการ
                            </div>
                            ` : `
                            <div style="margin-top: 3mm; font-weight: 600; text-align: right;">
                                <strong>รายการในหน้านี้:</strong> ${pageItems.length} รายการ (ต่อหน้าถัดไป)
                            </div>
                            `}
                        </div>
                        
                        ${isLastPage ? `
                        <!-- Footer Note -->
                        <div style="margin-top: 5mm; text-align: center; font-size: 10px; border-top: 1px solid #000; padding-top: 2mm;">
                            <strong>หมายเหตุ:</strong> กรุณาเก็บใบคำร้องนี้ไว้เป็นหลักฐาน<br>
                            เลขที่อ้างอิง: ${request.id}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            content.innerHTML = pagesHTML;
            modal.classList.remove('hidden');
        }

        function saveRequestDetailAsPDF() {
            const element = document.getElementById('request-detail-content');
            
            // Get all pages (elements with receipt-paper class)
            const pages = element.querySelectorAll('.receipt-paper');
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a5');
            const pdfWidth = 148; // A5 width in mm
            const pdfHeight = 210; // A5 height in mm
            
            let isFirstPage = true;
            
            // Process each page
            const processPage = (pageIndex) => {
                if (pageIndex >= pages.length) {
                    // All pages processed, save the PDF
                    const filename = `ใบคำร้องขอเบิกวัสดุ_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.pdf`;
                    pdf.save(filename);
                    alert('บันทึกใบคำร้องเป็น PDF สำเร็จ!');
                    return;
                }
                
                const currentPage = pages[pageIndex];
                
                // Configure html2canvas options for current page
                const options = {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: currentPage.scrollWidth,
                    height: currentPage.scrollHeight
                };
                
                html2canvas(currentPage, options).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Add new page if not first page
                    if (!isFirstPage) {
                        pdf.addPage();
                    }
                    isFirstPage = false;
                    
                    // Calculate dimensions to fit A5 page
                    const imgWidth = pdfWidth - 8; // Leave 4mm margin on each side
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // Calculate position (center horizontally, top vertically)
                    const xPosition = (pdfWidth - imgWidth) / 2; // Center horizontally
                    const yPosition = 5; // Reduced top margin to 5mm
                    
                    // Add image to current PDF page
                    pdf.addImage(imgData, 'PNG', xPosition, yPosition, imgWidth, imgHeight);
                    
                    // Process next page
                    processPage(pageIndex + 1);
                }).catch(error => {
                    console.error('Error saving request detail as PDF:', error);
                    alert('เกิดข้อผิดพลาดในการบันทึก PDF');
                });
            };
            
            // Start processing from first page
            processPage(0);
        }

        function closeRequestDetail() {
            document.getElementById('request-detail-modal').classList.add('hidden');
        }

        function loadHistory() {
            const container = document.getElementById('history-list');
            if (sampleData.history.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="bg-gray-100 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-lg">ไม่มีประวัติการทำรายการ</p>
                        <p class="text-gray-400 text-sm mt-2">ยังไม่มีการเบิกหรือรับวัสดุในระบบ</p>
                    </div>
                `;
            } else {
                // Sort history by timestamp (newest first) - อัตโนมัติเรียงจากใหม่ไปเก่า
                const sortedHistory = [...sampleData.history].sort((a, b) => {
                    let timestampA, timestampB;
                    
                    // วิธีการหา timestamp ที่ถูกต้องสำหรับ a
                    if (a.timestamp) {
                        timestampA = a.timestamp;
                    } else if (a.date && a.time) {
                        // แปลง date + time เป็น timestamp (รองรับรูปแบบภาษาไทย)
                        try {
                            let dateStr = a.date;
                            let timeStr = a.time;
                            
                            // ถ้าเป็นรูปแบบไทย ให้แปลงเป็นรูปแบบสากล
                            if (dateStr.includes('/')) {
                                const parts = dateStr.split('/');
                                if (parts.length === 3) {
                                    // รูปแบบ dd/mm/yyyy หรือ mm/dd/yyyy
                                    const day = parts[0];
                                    const month = parts[1];
                                    const year = parts[2];
                                    dateStr = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                }
                            }
                            
                            const dateTime = new Date(`${dateStr} ${timeStr}`);
                            timestampA = dateTime.getTime();
                            
                            // ถ้าไม่สามารถแปลงได้ ให้ใช้ ID
                            if (isNaN(timestampA)) {
                                timestampA = parseInt(a.id.replace(/[A-Z]/g, '')) || 0;
                            }
                        } catch (e) {
                            timestampA = parseInt(a.id.replace(/[A-Z]/g, '')) || 0;
                        }
                    } else {
                        // ใช้ ID เป็นตัวกำหนดลำดับ (ID มีรูปแบบ WD/RC + timestamp)
                        timestampA = parseInt(a.id.replace(/[A-Z]/g, '')) || 0;
                    }
                    
                    // วิธีการหา timestamp ที่ถูกต้องสำหรับ b
                    if (b.timestamp) {
                        timestampB = b.timestamp;
                    } else if (b.date && b.time) {
                        // แปลง date + time เป็น timestamp (รองรับรูปแบบภาษาไทย)
                        try {
                            let dateStr = b.date;
                            let timeStr = b.time;
                            
                            // ถ้าเป็นรูปแบบไทย ให้แปลงเป็นรูปแบบสากล
                            if (dateStr.includes('/')) {
                                const parts = dateStr.split('/');
                                if (parts.length === 3) {
                                    // รูปแบบ dd/mm/yyyy หรือ mm/dd/yyyy
                                    const day = parts[0];
                                    const month = parts[1];
                                    const year = parts[2];
                                    dateStr = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                }
                            }
                            
                            const dateTime = new Date(`${dateStr} ${timeStr}`);
                            timestampB = dateTime.getTime();
                            
                            // ถ้าไม่สามารถแปลงได้ ให้ใช้ ID
                            if (isNaN(timestampB)) {
                                timestampB = parseInt(b.id.replace(/[A-Z]/g, '')) || 0;
                            }
                        } catch (e) {
                            timestampB = parseInt(b.id.replace(/[A-Z]/g, '')) || 0;
                        }
                    } else {
                        // ใช้ ID เป็นตัวกำหนดลำดับ (ID มีรูปแบบ WD/RC + timestamp)
                        timestampB = parseInt(b.id.replace(/[A-Z]/g, '')) || 0;
                    }
                    
                    // เรียงจากใหม่ล่าสุดไปเก่าที่สุด (timestamp มากกว่าจะอยู่ก่อน)
                    return timestampB - timestampA;
                });
                
                container.innerHTML = sortedHistory.map(transaction => {
                    const isWithdraw = transaction.type === 'withdraw';
                    const typeText = isWithdraw ? 'เบิกวัสดุ' : 'รับวัสดุ';
                    const typeColor = isWithdraw ? 'from-red-100 to-red-50' : 'from-green-100 to-green-50';
                    const iconColor = isWithdraw ? 'text-red-600' : 'text-green-600';
                    
                    return `
                        <div class="card p-6 hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="bg-gradient-to-br ${typeColor} p-3 rounded-full mr-4">
                                    ${isWithdraw ? `
                                        <svg class="w-6 h-6 ${iconColor}" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                        </svg>
                                    ` : `
                                        <svg class="w-6 h-6 ${iconColor}" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 11-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    `}
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-gray-800">${typeText}</h3>
                                    <p class="text-sm text-gray-500">รหัส: ${transaction.id}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-medium text-gray-700">${transaction.date}</p>
                                    <p class="text-xs text-gray-500">${transaction.time}</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3 mb-6">
                                ${isWithdraw ? `
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700">ผู้เบิก: ${transaction.name}</span>
                                    </div>
                                    ${transaction.position ? `
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                                                <path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"></path>
                                            </svg>
                                            <span class="text-gray-700">ตำแหน่ง: ${transaction.position}</span>
                                        </div>
                                    ` : ''}
                                    ${transaction.department ? `
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"></path>
                                            </svg>
                                            <span class="text-gray-700">หน่วยงาน: ${transaction.department}</span>
                                        </div>
                                    ` : ''}
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700">วัตถุประสงค์: ${transaction.purpose}</span>
                                    </div>
                                ` : `
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700">แหล่งที่มา: ${transaction.source}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700">ผู้รับ: ${transaction.receiver}</span>
                                    </div>
                                `}
                                
                                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                                    <p class="text-sm font-medium text-gray-700 mb-2">รายการวัสดุ (${transaction.items.length} รายการ):</p>
                                    <div class="space-y-1">
                                        ${transaction.items.slice(0, 3).map(item => `
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-600">${item.name}</span>
                                                <span class="text-gray-700 font-medium">${item.quantity} ${item.unit}</span>
                                            </div>
                                        `).join('')}
                                        ${transaction.items.length > 3 ? `
                                            <div class="text-xs text-gray-500 text-center mt-2">
                                                และอีก ${transaction.items.length - 3} รายการ
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                ${isWithdraw ? `
                                    <button onclick="showWithdrawReceipt({id: '${transaction.id}', type: '${transaction.type}', name: '${transaction.name}', purpose: '${transaction.purpose}', items: ${JSON.stringify(transaction.items).replace(/"/g, '&quot;')}, date: '${transaction.date}', time: '${transaction.time}'})" 
                                            class="btn btn-secondary flex-1 py-2 text-sm flex items-center justify-center space-x-2">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                                            <path fill-rule="evenodd" d="M3 8a2 2 0 012-2v9a2 2 0 002 2h6a2 2 0 002-2V6a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span>ดูใบเสร็จ</span>
                                    </button>
                                ` : `
                                    <button onclick="showReceiveReceipt({id: '${transaction.id}', type: '${transaction.type}', source: '${transaction.source}', receiver: '${transaction.receiver}', items: ${JSON.stringify(transaction.items).replace(/"/g, '&quot;')}, date: '${transaction.date}', time: '${transaction.time}'})" 
                                            class="btn btn-secondary flex-1 py-2 text-sm flex items-center justify-center space-x-2">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                                            <path fill-rule="evenodd" d="M3 8a2 2 0 012-2v9a2 2 0 002 2h6a2 2 0 002-2V6a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span>ดูใบเสร็จ</span>
                                    </button>
                                `}
                                <button onclick="deleteHistory('${transaction.id}')" 
                                        class="btn bg-red-600 hover:bg-red-700 text-white py-2 px-4 text-sm flex items-center justify-center space-x-2">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ลบ</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function filterHistory(searchText = '') {
            const typeFilter = document.getElementById('history-type-filter').value;
            const container = document.getElementById('history-list');
            const resultsCount = document.getElementById('search-results-count');
            
            // Get search terms
            const searchTerms = searchText.toLowerCase().trim().split(/\s+/).filter(term => term.length > 0);
            
            // Filter history based on search and type
            const filteredHistory = sampleData.history.filter(transaction => {
                // Type filter
                if (typeFilter && transaction.type !== typeFilter) {
                    return false;
                }
                
                // Text search (if no search terms, show all)
                if (searchTerms.length === 0) {
                    return true;
                }
                
                // Create searchable text for this transaction
                const searchableText = [
                    transaction.id,
                    transaction.type === 'withdraw' ? transaction.name : transaction.receiver,
                    transaction.type === 'withdraw' ? transaction.purpose : transaction.source,
                    transaction.type === 'withdraw' && transaction.position ? transaction.position : '',
                    transaction.type === 'withdraw' && transaction.department ? transaction.department : '',
                    ...transaction.items.map(item => item.name)
                ].join(' ').toLowerCase();
                
                // Check if all search terms are found
                return searchTerms.every(term => searchableText.includes(term));
            });
            
            // Update results count
            if (searchTerms.length > 0 || typeFilter) {
                resultsCount.textContent = `พบ ${filteredHistory.length} รายการ${typeFilter ? ` (${typeFilter === 'withdraw' ? 'เบิกวัสดุ' : 'รับวัสดุ'})` : ''}`;
            } else {
                resultsCount.textContent = '';
            }
            
            // Display filtered results
            if (filteredHistory.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="bg-gray-100 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-lg">ไม่พบรายการที่ต้องการ</p>
                        <p class="text-gray-400 text-sm mt-2">ลองเปลี่ยนคำค้นหาหรือเงื่อนไขการกรอง</p>
                    </div>
                `;
            } else {
                // Sort filtered history by timestamp (newest first) - เรียงจากใหม่ไปเก่าอัตโนมัติ
                const sortedHistory = [...filteredHistory].sort((a, b) => {
                    let timestampA, timestampB;
                    
                    // ใช้วิธีเดียวกับ loadHistory() สำหรับการเรียงลำดับ
                    if (a.timestamp) {
                        timestampA = a.timestamp;
                    } else if (a.date && a.time) {
                        try {
                            let dateStr = a.date;
                            let timeStr = a.time;
                            
                            if (dateStr.includes('/')) {
                                const parts = dateStr.split('/');
                                if (parts.length === 3) {
                                    const day = parts[0];
                                    const month = parts[1];
                                    const year = parts[2];
                                    dateStr = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                }
                            }
                            
                            const dateTime = new Date(`${dateStr} ${timeStr}`);
                            timestampA = dateTime.getTime();
                            
                            if (isNaN(timestampA)) {
                                timestampA = parseInt(a.id.replace(/[A-Z]/g, '')) || 0;
                            }
                        } catch (e) {
                            timestampA = parseInt(a.id.replace(/[A-Z]/g, '')) || 0;
                        }
                    } else {
                        timestampA = parseInt(a.id.replace(/[A-Z]/g, '')) || 0;
                    }
                    
                    if (b.timestamp) {
                        timestampB = b.timestamp;
                    } else if (b.date && b.time) {
                        try {
                            let dateStr = b.date;
                            let timeStr = b.time;
                            
                            if (dateStr.includes('/')) {
                                const parts = dateStr.split('/');
                                if (parts.length === 3) {
                                    const day = parts[0];
                                    const month = parts[1];
                                    const year = parts[2];
                                    dateStr = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                }
                            }
                            
                            const dateTime = new Date(`${dateStr} ${timeStr}`);
                            timestampB = dateTime.getTime();
                            
                            if (isNaN(timestampB)) {
                                timestampB = parseInt(b.id.replace(/[A-Z]/g, '')) || 0;
                            }
                        } catch (e) {
                            timestampB = parseInt(b.id.replace(/[A-Z]/g, '')) || 0;
                        }
                    } else {
                        timestampB = parseInt(b.id.replace(/[A-Z]/g, '')) || 0;
                    }
                    
                    return timestampB - timestampA; // เรียงจากใหม่ล่าสุดไปเก่าที่สุด
                });
                
                container.innerHTML = sortedHistory.map(transaction => {
                    const isWithdraw = transaction.type === 'withdraw';
                    const typeText = isWithdraw ? 'เบิกวัสดุ' : 'รับวัสดุ';
                    const typeColor = isWithdraw ? 'from-red-100 to-red-50' : 'from-green-100 to-green-50';
                    const iconColor = isWithdraw ? 'text-red-600' : 'text-green-600';
                    
                    return `
                        <div class="card p-6 hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="bg-gradient-to-br ${typeColor} p-3 rounded-full mr-4">
                                    ${isWithdraw ? `
                                        <svg class="w-6 h-6 ${iconColor}" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                        </svg>
                                    ` : `
                                        <svg class="w-6 h-6 ${iconColor}" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 11-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    `}
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-gray-800">${typeText}</h3>
                                    <p class="text-sm text-gray-500">รหัส: ${transaction.id}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-medium text-gray-700">${transaction.date}</p>
                                    <p class="text-xs text-gray-500">${transaction.time}</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3 mb-6">
                                ${isWithdraw ? `
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700">ผู้เบิก: ${transaction.name}</span>
                                    </div>
                                    ${transaction.position ? `
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                                                <path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"></path>
                                            </svg>
                                            <span class="text-gray-700">ตำแหน่ง: ${transaction.position}</span>
                                        </div>
                                    ` : ''}
                                    ${transaction.department ? `
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"></path>
                                            </svg>
                                            <span class="text-gray-700">หน่วยงาน: ${transaction.department}</span>
                                        </div>
                                    ` : ''}
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700">วัตถุประสงค์: ${transaction.purpose}</span>
                                    </div>
                                ` : `
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700">แหล่งที่มา: ${transaction.source}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="text-gray-700">ผู้รับ: ${transaction.receiver}</span>
                                    </div>
                                `}
                                
                                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                                    <p class="text-sm font-medium text-gray-700 mb-2">รายการวัสดุ (${transaction.items.length} รายการ):</p>
                                    <div class="space-y-1">
                                        ${transaction.items.slice(0, 3).map(item => `
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-600">${item.name}</span>
                                                <span class="text-gray-700 font-medium">${item.quantity} ${item.unit}</span>
                                            </div>
                                        `).join('')}
                                        ${transaction.items.length > 3 ? `
                                            <div class="text-xs text-gray-500 text-center mt-2">
                                                และอีก ${transaction.items.length - 3} รายการ
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                ${isWithdraw ? `
                                    <button onclick="showWithdrawReceipt({id: '${transaction.id}', type: '${transaction.type}', name: '${transaction.name}', purpose: '${transaction.purpose}', items: ${JSON.stringify(transaction.items).replace(/"/g, '&quot;')}, date: '${transaction.date}', time: '${transaction.time}'})" 
                                            class="btn btn-secondary flex-1 py-2 text-sm flex items-center justify-center space-x-2">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                                            <path fill-rule="evenodd" d="M3 8a2 2 0 012-2v9a2 2 0 002 2h6a2 2 0 002-2V6a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span>ดูใบเสร็จ</span>
                                    </button>
                                ` : `
                                    <button onclick="showReceiveReceipt({id: '${transaction.id}', type: '${transaction.type}', source: '${transaction.source}', receiver: '${transaction.receiver}', items: ${JSON.stringify(transaction.items).replace(/"/g, '&quot;')}, date: '${transaction.date}', time: '${transaction.time}'})" 
                                            class="btn btn-secondary flex-1 py-2 text-sm flex items-center justify-center space-x-2">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                                            <path fill-rule="evenodd" d="M3 8a2 2 0 012-2v9a2 2 0 002 2h6a2 2 0 002-2V6a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span>ดูใบเสร็จ</span>
                                    </button>
                                `}
                                <button onclick="deleteHistory('${transaction.id}')" 
                                        class="btn bg-red-600 hover:bg-red-700 text-white py-2 px-4 text-sm flex items-center justify-center space-x-2">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ลบ</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function clearHistorySearch() {
            document.getElementById('history-search').value = '';
            document.getElementById('history-type-filter').value = '';
            document.getElementById('search-results-count').textContent = '';
            loadHistory(); // Reload all history
        }

        function filterRequests() {
            console.log('filterRequests called');
            
            const searchTerm = document.getElementById('requests-search').value.toLowerCase();
            const statusFilter = document.getElementById('requests-status-filter').value;
            const container = document.getElementById('requests-list');
            const resultsCount = document.getElementById('requests-results-count');
            
            console.log('Search term:', searchTerm);
            console.log('Status filter:', statusFilter);
            console.log('Total requests:', sampleData.requests.length);
            
            if (!container || !resultsCount) {
                console.error('Required elements not found');
                return;
            }
            
            // Filter requests based on search term and status
            let filteredRequests = sampleData.requests.filter(request => {
                // Text search - ค้นหาในหลายฟิลด์
                const matchesSearch = !searchTerm || (
                    request.id.toLowerCase().includes(searchTerm) ||
                    request.name.toLowerCase().includes(searchTerm) ||
                    request.department.toLowerCase().includes(searchTerm) ||
                    request.purpose.toLowerCase().includes(searchTerm)
                );
                
                // Status filter
                const matchesStatus = !statusFilter || request.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            console.log('Filtered requests:', filteredRequests.length);
            
            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="bg-gray-100 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-lg">ไม่พบใบคำร้องที่ตรงกับเงื่อนไข</p>
                        <p class="text-gray-400 text-sm mt-2">ลองปรับเปลี่ยนคำค้นหาหรือตัวกรองสถานะ</p>
                    </div>
                `;
                resultsCount.textContent = 'ไม่พบรายการ';
            } else {
                // Sort filtered requests by timestamp (newest first)
                const sortedRequests = [...filteredRequests].sort((a, b) => {
                    let timestampA, timestampB;
                    
                    if (a.timestamp) {
                        timestampA = a.timestamp;
                    } else if (a.date) {
                        const dateA = new Date(a.date);
                        timestampA = isNaN(dateA.getTime()) ? parseInt(a.id.replace('REQ', '')) : dateA.getTime();
                    } else {
                        timestampA = parseInt(a.id.replace('REQ', '')) || 0;
                    }
                    
                    if (b.timestamp) {
                        timestampB = b.timestamp;
                    } else if (b.date) {
                        const dateB = new Date(b.date);
                        timestampB = isNaN(dateB.getTime()) ? parseInt(b.id.replace('REQ', '')) : dateB.getTime();
                    } else {
                        timestampB = parseInt(b.id.replace('REQ', '')) || 0;
                    }
                    
                    return timestampB - timestampA; // เรียงจากใหม่ล่าสุดไปเก่าที่สุด
                });

                container.innerHTML = sortedRequests.map(request => {
                    const statusInfo = getRequestStatusInfo(request.status);
                    
                    return `
                        <div class="card p-6 hover:shadow-lg transition-all duration-300">
                            <div class="flex items-center mb-4">
                                <div class="bg-gradient-to-br ${statusInfo.bgColor} p-3 rounded-full mr-4">
                                    <svg class="w-6 h-6 ${statusInfo.iconColor}" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-gray-800">ใบคำร้องขอเบิก</h3>
                                    <p class="text-sm text-gray-500">เลขที่: ${request.id}</p>
                                </div>
                                <div class="text-right">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusInfo.badgeClass}">
                                        ${statusInfo.text}
                                    </span>
                                    <p class="text-xs text-gray-500 mt-1">${request.date || 'ไม่ระบุวันที่'}</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3 mb-6">
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-gray-700">ผู้ขอ: ${request.name}</span>
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-gray-700">หน่วยงาน: ${request.department}</span>
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-gray-700">วัตถุประสงค์: ${request.purpose}</span>
                                </div>
                                
                                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                                    <p class="text-sm font-medium text-gray-700 mb-2">รายการวัสดุ (${request.items.length} รายการ):</p>
                                    <div class="space-y-1">
                                        ${request.items.slice(0, 3).map(item => `
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-600">${item.name}</span>
                                                <span class="text-gray-700 font-medium">${item.quantity} ${item.unit}</span>
                                            </div>
                                        `).join('')}
                                        ${request.items.length > 3 ? `
                                            <div class="text-xs text-gray-500 text-center mt-2">
                                                และอีก ${request.items.length - 3} รายการ
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">เปลี่ยนสถานะ</label>
                                    <select onchange="changeRequestStatus('${request.id}', this.value)" 
                                            class="w-full text-sm bg-white border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                                        <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>รอพิจารณา</option>
                                        <option value="approved" ${request.status === 'approved' ? 'selected' : ''}>อนุมัติ</option>
                                        <option value="rejected" ${request.status === 'rejected' ? 'selected' : ''}>ไม่อนุมัติ</option>
                                    </select>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="showRequestDetail('${request.id}')" 
                                            class="btn btn-secondary flex-1 py-2 text-sm flex items-center justify-center space-x-2">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path>
                                            <path fill-rule="evenodd" d="M3 8a2 2 0 012-2v9a2 2 0 002 2h6a2 2 0 002-2V6a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span>ดูใบคำร้อง</span>
                                    </button>
                                    ${request.status === 'approved' ? `
                                        <button onclick="processApprovedRequest('${request.id}')" 
                                                class="btn bg-blue-600 hover:bg-blue-700 text-white flex-1 py-2 text-sm flex items-center justify-center space-x-2">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                            </svg>
                                            <span>ดำเนินการเบิก</span>
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteRequest('${request.id}')" 
                                            class="btn bg-red-600 hover:bg-red-700 text-white py-2 px-4 text-sm flex items-center justify-center space-x-2">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span>ลบ</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Update results count
                const totalRequests = sampleData.requests.length;
                const filteredCount = filteredRequests.length;
                if (searchTerm || statusFilter) {
                    resultsCount.textContent = `แสดง ${filteredCount} จาก ${totalRequests} รายการ`;
                } else {
                    resultsCount.textContent = `แสดงทั้งหมด ${totalRequests} รายการ`;
                }
            }
        }

        function clearRequestsSearch() {
            document.getElementById('requests-search').value = '';
            document.getElementById('requests-status-filter').value = '';
            filterRequests(); // Reload all requests with no filters
        }

        function loadStock() {
            filterStock(); // ใช้ฟังก์ชันใหม่แทน
            loadStockCategories(); // โหลดหมวดหมู่สำหรับตัวกรอง
            loadStockGroups(); // โหลดกลุ่มสำหรับตัวกรอง
        }

        function loadStockGroups() {
            const groupFilter = document.getElementById('stock-group-filter');
            if (!groupFilter) return;

            // รวบรวมกลุ่มทั้งหมด (รวมทั้งที่เป็นค่าว่าง)
            const groups = [...new Set(sampleData.stock.map(item => item.group || '').filter(group => group !== ''))].sort();
            
            // เก็บตัวเลือกเดิม
            const currentValue = groupFilter.value;
            
            // อัปเดตตัวเลือกในดรอปดาวน์
            groupFilter.innerHTML = '<option value="">ทุกกลุ่ม</option>' + 
                groups.map(group => `<option value="${group}">${group}</option>`).join('');
            
            // คืนค่าตัวเลือกเดิม
            groupFilter.value = currentValue;
        }

        function loadStockCategories() {
            const categoryFilter = document.getElementById('stock-category-filter');
            if (!categoryFilter) return;

            // รวบรวมหมวดหมู่ทั้งหมด
            const categories = [...new Set(sampleData.stock.map(item => item.category))].sort();
            
            // เก็บตัวเลือกเดิม
            const currentValue = categoryFilter.value;
            
            // อัปเดตตัวเลือกในดรอปดาวน์
            categoryFilter.innerHTML = '<option value="">ทุกหมวดหมู่</option>' + 
                categories.map(category => `<option value="${category}">${category}</option>`).join('');
            
            // คืนค่าตัวเลือกเดิม
            categoryFilter.value = currentValue;
        }

        function filterStock() {
            const tbody = document.getElementById('stock-table');
            const searchInput = document.getElementById('stock-search');
            const groupFilter = document.getElementById('stock-group-filter');
            const categoryFilter = document.getElementById('stock-category-filter');
            const statusFilter = document.getElementById('stock-status-filter');
            const resultsDiv = document.getElementById('stock-search-results');
            
            const searchText = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const selectedGroup = groupFilter ? groupFilter.value : '';
            const selectedCategory = categoryFilter ? categoryFilter.value : '';
            const selectedStatus = statusFilter ? statusFilter.value : '';
            
            // กรองข้อมูล
            const filteredStock = sampleData.stock.filter(item => {
                // ตรวจสอบการค้นหาข้อความ
                const searchableText = `${item.barcode} ${item.group || ''} ${item.name} ${item.category}`.toLowerCase();
                const matchesSearch = !searchText || searchableText.includes(searchText);
                
                // ตรวจสอบกลุ่ม
                const matchesGroup = !selectedGroup || (item.group || '') === selectedGroup;
                
                // ตรวจสอบหมวดหมู่
                const matchesCategory = !selectedCategory || item.category === selectedCategory;
                
                // ตรวจสอบสถานะ
                let matchesStatus = true;
                if (selectedStatus) {
                    const currentDate = Date.now();
                    const thirtyDaysFromNow = currentDate + (30 * 24 * 60 * 60 * 1000);
                    const quantity = parseInt(item.quantity);
                    
                    switch (selectedStatus) {
                        case 'normal':
                            matchesStatus = quantity >= 10 && quantity > 0 && (!item.expiry || new Date(item.expiry).getTime() > thirtyDaysFromNow);
                            break;
                        case 'low':
                            matchesStatus = quantity < 10 && quantity > 0;
                            break;
                        case 'out-of-stock':
                            matchesStatus = quantity === 0;
                            break;
                        case 'expiring':
                            matchesStatus = item.expiry && new Date(item.expiry).getTime() <= thirtyDaysFromNow && new Date(item.expiry).getTime() > currentDate;
                            break;
                        case 'expired':
                            matchesStatus = item.expiry && new Date(item.expiry).getTime() <= currentDate;
                            break;
                    }
                }
                
                return matchesSearch && matchesGroup && matchesCategory && matchesStatus;
            });
            
            // แสดงผลการค้นหา
            if (resultsDiv) {
                if (searchText || selectedGroup || selectedCategory || selectedStatus) {
                    const statusText = selectedStatus ? ` (${getStatusText(selectedStatus)})` : '';
                    const groupText = selectedGroup ? ` (กลุ่ม: ${selectedGroup})` : '';
                    const categoryText = selectedCategory ? ` (หมวดหมู่: ${selectedCategory})` : '';
                    resultsDiv.textContent = `พบ ${filteredStock.length} รายการ${groupText}${categoryText}${statusText}`;
                } else {
                    resultsDiv.textContent = '';
                }
            }
            
            // แสดงผลในตาราง
            if (filteredStock.length === 0) {            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="border border-gray-300 px-4 py-8 text-center">
                        <div class="flex flex-col items-center space-y-3">
                            <div class="bg-gray-100 rounded-full w-12 h-12 flex items-center justify-center">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <p class="text-gray-500 font-medium">ไม่พบข้อมูลที่ค้นหา</p>
                            <p class="text-gray-400 text-sm">ลองเปลี่ยนคำค้นหาหรือตัวกรอง</p>
                        </div>
                    </td>
                </tr>
            `;
                return;
            }
            
            tbody.innerHTML = filteredStock.map(item => {
                const currentDate = Date.now();
                const quantity = parseInt(item.quantity);
                const isExpired = item.expiry && new Date(item.expiry).getTime() <= currentDate;
                const isExpiring = item.expiry && new Date(item.expiry).getTime() <= currentDate + (30*24*60*60*1000) && new Date(item.expiry).getTime() > currentDate;
                const isOutOfStock = quantity === 0;
                const isLowStock = quantity < 10 && quantity > 0;
                
                let rowClass = '';
                if (isOutOfStock) {
                    rowClass = 'bg-gray-100';
                } else if (isExpired) {
                    rowClass = 'bg-red-100';
                } else if (isExpiring) {
                    rowClass = 'bg-yellow-50';
                } else if (isLowStock) {
                    rowClass = 'bg-orange-50';
                }
                
                return `
                    <tr class="${rowClass}">
                        <td class="border border-gray-300 px-4 py-2">${item.barcode}</td>
                        <td class="border border-gray-300 px-4 py-2">${item.group || '-'}</td>
                        <td class="border border-gray-300 px-4 py-2">${item.category}</td>
                        <td class="border border-gray-300 px-4 py-2">${item.name}</td>
                        <td class="border border-gray-300 px-4 py-2">${item.quantity}</td>
                        <td class="border border-gray-300 px-4 py-2">${item.unit}</td>
                        <td class="border border-gray-300 px-4 py-2">${item.expiry || '-'}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <label class="flex items-center justify-center cursor-pointer">
                                <input type="checkbox" 
                                       ${item.showInRequest === true ? 'checked' : ''} 
                                       onchange="toggleShowInRequest('${item.barcode}', this.checked, this)"
                                       class="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary border-gray-300">
                                <span class="ml-2 text-sm ${item.showInRequest === true ? 'text-green-600 font-medium' : 'text-gray-500'}">
                                    ${item.showInRequest === true ? 'แสดง' : 'ซ่อน'}
                                </span>
                            </label>
                        </td>
                        <td class="border border-gray-300 px-4 py-2">
                            <button onclick="editStock('${item.barcode}')" class="bg-blue-600 text-white px-2 py-1 rounded text-sm hover:bg-blue-700 mr-1">แก้ไข</button>
                            <button onclick="deleteStock('${item.barcode}')" class="bg-red-600 text-white px-2 py-1 rounded text-sm hover:bg-red-700">ลบ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusText(status) {
            switch (status) {
                case 'normal': return 'ปกติ';
                case 'low': return 'ใกล้หมด';
                case 'out-of-stock': return 'สินค้าหมด';
                case 'expiring': return 'ใกล้หมดอายุ';
                case 'expired': return 'หมดอายุแล้ว';
                default: return '';
            }
        }

        function clearStockSearch() {
            // ล้างช่องค้นหา
            const searchInput = document.getElementById('stock-search');
            if (searchInput) searchInput.value = '';
            
            // ล้างตัวกรอง
            const groupFilter = document.getElementById('stock-group-filter');
            if (groupFilter) groupFilter.value = '';
            
            const categoryFilter = document.getElementById('stock-category-filter');
            if (categoryFilter) categoryFilter.value = '';
            
            const statusFilter = document.getElementById('stock-status-filter');
            if (statusFilter) statusFilter.value = '';
            
            // ล้างผลการค้นหา
            const resultsDiv = document.getElementById('stock-search-results');
            if (resultsDiv) resultsDiv.textContent = '';
            
            // โหลดข้อมูลใหม่
            filterStock();
        }

        async function toggleShowInRequest(barcode, isShow, checkboxElement) {
            try {
                console.log(`toggleShowInRequest called: ${barcode} -> ${isShow}`);
                
                // อัปเดต UI ทันที - หา span element ที่อยู่ถัดจาก checkbox
                if (checkboxElement && checkboxElement.nextElementSibling) {
                    const statusSpan = checkboxElement.nextElementSibling;
                    statusSpan.textContent = isShow ? 'แสดง' : 'ซ่อน';
                    statusSpan.className = `ml-2 text-sm ${isShow ? 'text-green-600 font-medium' : 'text-gray-500'}`;
                    console.log('Updated UI immediately');
                }
                
                // หา item ใน local data
                const item = sampleData.stock.find(s => s.barcode === barcode);
                if (!item) {
                    alert('ไม่พบรายการวัสดุ');
                    return;
                }
                
                console.log(`Found item: ${item.name}, current showInRequest: ${item.showInRequest}`);
                
                // อัปเดต local data
                item.showInRequest = isShow;
                console.log(`Updated local data for ${item.name}: showInRequest = ${item.showInRequest}`);
                
                // สร้าง object สำหรับ Firebase
                const stockData = {};
                sampleData.stock.forEach(stock => {
                    stockData[`item_${stock.barcode}`] = stock;
                });
                
                // อัปเดตใน Firebase (ทำงานใน background)
                firebase.set(firebase.ref(firebase.database, 'stock'), stockData).then(() => {
                    console.log('Updated Firebase successfully');
                    
                    // รีโหลดหน้าวัสดุในคำร้องขอเบิก หากกำลังแสดงอยู่
                    if (typeof loadMaterialCategories === 'function') {
                        console.log('Reloading material categories...');
                        loadMaterialCategories();
                    }
                }).catch(error => {
                    console.error('Error updating Firebase:', error);
                    alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                });
                
                console.log(`อัปเดตสถานะแสดงผล: ${item.name} -> ${isShow ? 'แสดง' : 'ซ่อน'}`);
                
            } catch (error) {
                console.error('Error updating show in request status:', error);
                alert('เกิดข้อผิดพลาดในการอัปเดตสถานะ');
                
                // รีโหลดตารางเพื่อให้แสดงค่าที่ถูกต้อง
                loadStock();
            }
        }

        async function toggleAllShowInRequest(showStatus) {
            try {
                if (sampleData.stock.length === 0) {
                    alert('ไม่มีรายการวัสดุในระบบ');
                    return;
                }
                
                const confirmMessage = showStatus 
                    ? `คุณต้องการให้แสดงรายการวัสดุทั้งหมด (${sampleData.stock.length} รายการ) ในหน้าคำร้องขอเบิกใช่หรือไม่?`
                    : `คุณต้องการซ่อนรายการวัสดุทั้งหมด (${sampleData.stock.length} รายการ) จากหน้าคำร้องขอเบิกใช่หรือไม่?`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                console.log(`toggleAllShowInRequest called: ${showStatus}`);
                
                // อัปเดต UI ทันทีก่อน - หาและอัปเดต checkbox ทั้งหมดในตาราง
                const checkboxes = document.querySelectorAll('input[type="checkbox"][onchange*="toggleShowInRequest"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = showStatus;
                    
                    // อัปเดต span ที่อยู่ถัดจาก checkbox
                    const statusSpan = checkbox.nextElementSibling;
                    if (statusSpan) {
                        statusSpan.textContent = showStatus ? 'แสดง' : 'ซ่อน';
                        statusSpan.className = `ml-2 text-sm ${showStatus ? 'text-green-600 font-medium' : 'text-gray-500'}`;
                    }
                });
                console.log('Updated all UI checkboxes and status texts immediately');
                
                // อัปเดต local data
                sampleData.stock.forEach(item => {
                    item.showInRequest = showStatus;
                });
                
                // สร้าง object สำหรับ Firebase
                const stockData = {};
                sampleData.stock.forEach(stock => {
                    stockData[`item_${stock.barcode}`] = stock;
                });
                
                // อัปเดตใน Firebase ใน background
                firebase.set(firebase.ref(firebase.database, 'stock'), stockData).then(() => {
                    console.log('Updated all items in Firebase');
                    
                    // รีโหลดข้อมูลจาก Firebase ใน background
                    return loadAllFirebaseData();
                }).then(() => {
                    console.log('Reloaded Firebase data');
                }).catch(error => {
                    console.error('Error updating Firebase:', error);
                });
                
                // รีโหลดหน้าวัสดุในคำร้องขอเบิก หากกำลังแสดงอยู่
                if (typeof loadMaterialCategories === 'function') {
                    console.log('Reloading material categories...');
                    loadMaterialCategories();
                }
                
                const statusText = showStatus ? 'แสดง' : 'ซ่อน';
                alert(`อัปเดตการแสดงผลสำเร็จ: ${statusText}รายการวัสดุทั้งหมด (${sampleData.stock.length} รายการ)`);
                
            } catch (error) {
                console.error('Error updating all show in request status:', error);
                alert('เกิดข้อผิดพลาดในการอัปเดตสถานะ');
            }
        }

        function debugShowInRequest() {
            console.log('=== DEBUG: Show In Request Status ===');
            console.log('Total stock items:', sampleData.stock.length);
            
            sampleData.stock.forEach((item, index) => {
                console.log(`${index + 1}. ${item.name} (${item.barcode}): showInRequest = ${item.showInRequest}`);
            });
            
            const trueItems = sampleData.stock.filter(item => item.showInRequest === true);
            const falseItems = sampleData.stock.filter(item => item.showInRequest === false);
            const undefinedItems = sampleData.stock.filter(item => item.showInRequest === undefined);
            
            console.log(`Items with showInRequest === true: ${trueItems.length}`);
            console.log(`Items with showInRequest === false: ${falseItems.length}`);
            console.log(`Items with showInRequest === undefined: ${undefinedItems.length}`);
            
            console.log('========================================');
            
            alert(`Debug Info:\n` +
                  `รายการทั้งหมด: ${sampleData.stock.length}\n` +
                  `แสดงในคำร้อง (true): ${trueItems.length}\n` +
                  `ซ่อนจากคำร้อง (false): ${falseItems.length}\n` +
                  `ไม่มีค่า (undefined): ${undefinedItems.length}\n\n` +
                  `ดูรายละเอียดใน Console (F12)`);
        }

        function loadStaff() {
            const container = document.getElementById('staff-cards');
            if (sampleData.staff.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="bg-gray-100 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-lg">ยังไม่มีข้อมูลเจ้าหน้าที่</p>
                        <p class="text-gray-400 text-sm mt-2">คลิกปุ่ม "เพิ่มเจ้าหน้าที่" เพื่อเริ่มต้น</p>
                    </div>
                `;
            } else {
                container.innerHTML = sampleData.staff.map(staff => `
                    <div class="card p-6 hover:shadow-lg transition-all duration-300">
                        <div class="flex items-center mb-4">
                            <div class="bg-gradient-to-br from-green-100 to-green-50 p-3 rounded-full mr-4">
                                <svg class="w-6 h-6 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-800">${staff.name}</h3>
                                <p class="text-sm text-gray-500">รหัส: ${staff.id}</p>
                            </div>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-gray-700">${staff.position}</span>
                            </div>
                            <div class="flex items-center">
                                <svg class="w-4 h-4 text-gray-400 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-6a1 1 0 00-1-1H9a1 1 0 00-1 1v6a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-gray-700">${staff.department}</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="editStaff('${staff.id}')" class="btn btn-primary flex-1 py-2 text-sm flex items-center justify-center space-x-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                </svg>
                                <span>แก้ไข</span>
                            </button>
                            <button onclick="deleteStaff('${staff.id}')" class="btn bg-red-500 hover:bg-red-600 text-white flex-1 py-2 text-sm flex items-center justify-center space-x-2 transition-all duration-300">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span>ลบ</span>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function loadUsers() {
            const container = document.getElementById('users-cards');
            if (sampleData.users.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="bg-gray-100 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-lg">ยังไม่มีบัญชีผู้ใช้</p>
                        <p class="text-gray-400 text-sm mt-2">คลิกปุ่ม "เพิ่มผู้ใช้" เพื่อเริ่มต้น</p>
                    </div>
                `;
            } else {
                container.innerHTML = sampleData.users.map(user => `
                    <div class="card p-6 hover:shadow-lg transition-all duration-300">
                        <div class="flex items-center mb-4">
                            <div class="bg-gradient-to-br from-green-100 to-green-200 rounded-full p-3 mr-4">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-gray-800">${user.name}</h3>
                                <div class="flex items-center text-sm text-gray-500">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                    </svg>
                                    ID: ${user.id}
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex items-center text-gray-600">
                                <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1721 9z"></path>
                                </svg>
                                <span class="text-sm">
                                    <span class="font-medium">ชื่อผู้ใช้:</span> ${user.username}
                                </span>
                            </div>
                            
                            <div class="flex items-center text-gray-600">
                                <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                                <span class="text-sm">
                                    <span class="font-medium">รหัสผ่าน:</span> 
                                    <span class="text-gray-400">••••••••</span>
                                </span>
                            </div>
                            
                            <div class="flex items-center text-gray-600">
                                <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.414-4.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                <span class="text-sm">
                                    <span class="font-medium">สถานะ:</span> 
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <span class="w-2 h-2 bg-green-400 rounded-full mr-1"></span>
                                        ใช้งานได้
                                    </span>
                                </span>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="editUser(${user.id})" class="btn btn-warning flex-1 text-sm flex items-center justify-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                แก้ไข
                            </button>
                            <button onclick="deleteUser(${user.id})" class="btn btn-danger flex-1 text-sm flex items-center justify-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                ลบ
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // CRUD operations with Firebase
        function showAddStockModal() {
            // Create modal for adding new stock
            const modal = document.createElement('div');
            modal.id = 'add-stock-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold text-primary mb-4">เพิ่มรายการวัสดุใหม่</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">รหัสบาร์โค้ด *</label>
                            <input type="text" id="add-barcode" class="input-field w-full" placeholder="กรอกรหัสบาร์โค้ด" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">กลุ่ม</label>
                            <input type="text" id="add-group" class="input-field w-full" placeholder="กรอกกลุ่มวัสดุ เช่น ยา, อุปกรณ์, เครื่องมือ">
                            <p class="text-xs text-gray-500 mt-1">ระบุกลุ่มสำหรับจัดหมวดหมู่วัสดุ (เว้นว่างได้)</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">หมวดหมู่ *</label>
                            <input type="text" id="add-category" class="input-field w-full" placeholder="กรอกหมวดหมู่วัสดุ เช่น อุปกรณ์การแพทย์, เวชภัณฑ์, เครื่องเขียน" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">ชื่อวัสดุ *</label>
                            <input type="text" id="add-name" class="input-field w-full" placeholder="กรอกชื่อวัสดุ" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">จำนวนเริ่มต้น *</label>
                                <input type="number" id="add-quantity" min="0" value="0" class="input-field w-full" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">หน่วย *</label>
                                <input type="text" id="add-unit" class="input-field w-full" placeholder="กรอกหน่วย เช่น ชิ้น, กล่อง, ขวด, คู่, ด้าม, รีม" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">วันหมดอายุ (ถ้ามี)</label>
                            <input type="date" id="add-expiry" class="input-field w-full">
                            <p class="text-xs text-gray-500 mt-1">เว้นว่างหากไม่มีวันหมดอายุ</p>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveNewStock()" class="btn btn-primary flex-1">เพิ่มรายการ</button>
                        <button onclick="closeAddStockModal()" class="btn btn-secondary flex-1">ยกเลิก</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            

            
            // Add click outside to close modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeAddStockModal();
                }
            });
            
            // Focus on first field
            setTimeout(() => {
                document.getElementById('add-barcode').focus();
            }, 100);
        }

        async function saveNewStock() {
            const barcode = document.getElementById('add-barcode').value.trim();
            const group = document.getElementById('add-group').value.trim();
            const category = document.getElementById('add-category').value.trim();
            const name = document.getElementById('add-name').value.trim();
            const quantity = parseInt(document.getElementById('add-quantity').value) || 0;
            const unit = document.getElementById('add-unit').value.trim();
            const expiry = document.getElementById('add-expiry').value || null;
            
            // Validation
            if (!barcode) {
                alert('กรุณากรอกรหัสบาร์โค้ด');
                document.getElementById('add-barcode').focus();
                return;
            }
            
            if (!category) {
                alert('กรุณากรอกหมวดหมู่');
                document.getElementById('add-category').focus();
                return;
            }
            
            if (!name) {
                alert('กรุณากรอกชื่อวัสดุ');
                document.getElementById('add-name').focus();
                return;
            }
            
            if (!unit) {
                alert('กรุณากรอกหน่วย');
                document.getElementById('add-unit').focus();
                return;
            }
            
            // Check if barcode already exists
            const existingItem = sampleData.stock.find(s => s.barcode === barcode);
            if (existingItem) {
                alert('รหัสบาร์โค้ดนี้มีอยู่แล้วในระบบ กรุณาใช้รหัสอื่น');
                document.getElementById('add-barcode').focus();
                document.getElementById('add-barcode').select();
                return;
            }
            
            try {
                const stockItem = {
                    barcode: barcode,
                    group: group || null, // อนุญาตให้เป็นค่าว่างได้
                    category: category,
                    name: name,
                    quantity: quantity,
                    unit: unit,
                    expiry: expiry,
                    showInRequest: true // ค่าเริ่มต้นให้แสดงในคำร้อง
                };
                
                await saveToFirebase('stock', barcode, stockItem);
                
                closeAddStockModal();
                loadStock();
                loadMaterialCategories();
                
                // Show success message
                alert(`เพิ่มรายการวัสดุ "${name}" สำเร็จ!`);
                
            } catch (error) {
                console.error('Error adding stock:', error);
                alert('เกิดข้อผิดพลาดในการเพิ่มสต๊อก กรุณาลองใหม่อีกครั้ง');
            }
        }

        function closeAddStockModal() {
            const modal = document.getElementById('add-stock-modal');
            if (modal) {
                modal.remove();
            }
        }

        function showImportStockModal() {
            // Create modal for importing stock from Excel
            const modal = document.createElement('div');
            modal.id = 'import-stock-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
                    <h3 class="text-xl font-bold text-primary mb-4">นำเข้าข้อมูลสต๊อกจากไฟล์ Excel</h3>
                    
                    <!-- รูปแบบไฟล์ Excel ที่ต้องการ -->
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                        <h4 class="font-semibold text-blue-800 mb-2">รูปแบบไฟล์ Excel ที่ต้องการ:</h4>
                        <div class="text-sm text-blue-700">
                            <p class="mb-2">ไฟล์ Excel ควรมีคอลัมน์ดังนี้ (แถวแรกเป็นหัวตาราง):</p>
                            <div class="bg-white p-3 rounded border">
                                <table class="w-full text-xs">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="p-1 border">รหัสบาร์โค้ด</th>
                                            <th class="p-1 border">กลุ่ม</th>
                                            <th class="p-1 border">หมวดหมู่</th>
                                            <th class="p-1 border">ชื่อวัสดุ</th>
                                            <th class="p-1 border">จำนวน</th>
                                            <th class="p-1 border">หน่วย</th>
                                            <th class="p-1 border">วันหมดอายุ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="p-1 border text-center">123456789</td>
                                            <td class="p-1 border text-center">สำนักงาน</td>
                                            <td class="p-1 border text-center">เครื่องเขียน</td>
                                            <td class="p-1 border text-center">ปากกา</td>
                                            <td class="p-1 border text-center">100</td>
                                            <td class="p-1 border text-center">ด้าม</td>
                                            <td class="p-1 border text-center">2025-12-31</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p class="mt-2 text-xs"><strong>หมายเหตุ:</strong> วันหมดอายุใส่ในรูปแบบ YYYY-MM-DD หรือเว้นว่างหากไม่มี กลุ่มสามารถเว้นว่างได้</p>
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button onclick="downloadImportTemplate()" class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700 flex items-center space-x-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                                <span>ไฟล์ตัวอย่าง Excel</span>
                            </button>
                            <button onclick="downloadImportTemplateCSV()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 flex items-center space-x-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                                <span>ไฟล์ตัวอย่าง CSV</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">เลือกไฟล์ Excel</label>
                            <input type="file" id="excel-file-input" accept=".xlsx,.xls" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">รองรับไฟล์นามสกุล .xlsx และ .xls เท่านั้น</p>
                        </div>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700">
                                        <strong>คำเตือน:</strong> การนำเข้าข้อมูลจะเพิ่มรายการใหม่เข้าสู่ระบบ หากมีรหัสบาร์โค้ดซ้ำจะข้ามรายการนั้น
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- แสดงตัวอย่างข้อมูลที่จะนำเข้า -->
                        <div id="import-preview" class="hidden">
                            <h4 class="font-semibold text-gray-800 mb-2">ตัวอย่างข้อมูลที่จะนำเข้า:</h4>
                            <div class="max-h-40 overflow-y-auto border rounded-lg">
                                <table id="preview-table" class="w-full text-sm">
                                    <!-- จะแสดงข้อมูลตัวอย่างที่นี่ -->
                                </table>
                            </div>
                            <p id="import-count" class="text-sm text-gray-600 mt-2"></p>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button id="import-btn" onclick="importStockFromExcel()" class="btn btn-primary flex-1" disabled>นำเข้าข้อมูล</button>
                        <button onclick="closeImportStockModal()" class="btn btn-secondary flex-1">ยกเลิก</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listener for file input
            const fileInput = document.getElementById('excel-file-input');
            fileInput.addEventListener('change', handleExcelFileSelect);
            
            // Add click outside to close modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeImportStockModal();
                }
            });
        }

        function closeImportStockModal() {
            const modal = document.getElementById('import-stock-modal');
            if (modal) {
                modal.remove();
            }
        }

        let importData = [];

        function handleExcelFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) {
                        alert('ไฟล์ Excel ต้องมีข้อมูลอย่างน้อย 2 แถว (หัวตารางและข้อมูล)');
                        return;
                    }

                    // แปลงข้อมูลให้อยู่ในรูปแบบที่ต้องการ
                    const headers = jsonData[0];
                    importData = [];

                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row[0]) continue; // ข้ามแถวที่ไม่มีรหัสบาร์โค้ด

                        const item = {
                            barcode: String(row[0] || '').trim(),
                            group: String(row[1] || '').trim(), // เพิ่มคอลัมน์กลุ่ม
                            category: String(row[2] || '').trim(),
                            name: String(row[3] || '').trim(),
                            quantity: parseInt(row[4]) || 0,
                            unit: String(row[5] || '').trim(),
                            expiry: row[6] ? formatExcelDate(row[6]) : null,
                            showInRequest: true
                        };

                        // ตรวจสอบข้อมูลที่จำเป็น
                        if (item.barcode && item.category && item.name && item.unit) {
                            importData.push(item);
                        }
                    }

                    if (importData.length === 0) {
                        alert('ไม่พบข้อมูลที่สามารถนำเข้าได้ กรุณาตรวจสอบรูปแบบไฟล์');
                        return;
                    }

                    // แสดงตัวอย่างข้อมูล
                    showImportPreview();

                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    alert('เกิดข้อผิดพลาดในการอ่านไฟล์ Excel กรุณาตรวจสอบรูปแบบไฟล์');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function formatExcelDate(excelDate) {
            if (!excelDate) return null;
            
            // ถ้าเป็น string แล้วอยู่ในรูปแบบ YYYY-MM-DD อยู่แล้ว
            if (typeof excelDate === 'string' && excelDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return excelDate;
            }
            
            // ถ้าเป็นตัวเลข Excel date
            if (typeof excelDate === 'number') {
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            
            // ถ้าเป็น Date object
            if (excelDate instanceof Date) {
                return excelDate.toISOString().split('T')[0];
            }
            
            return null;
        }

        function showImportPreview() {
            const previewDiv = document.getElementById('import-preview');
            const previewTable = document.getElementById('preview-table');
            const importCount = document.getElementById('import-count');
            const importBtn = document.getElementById('import-btn');

            // แสดงตัวอย่าง 5 รายการแรก
            const previewItems = importData.slice(0, 5);
            
            let tableHTML = `
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 border text-left">รหัสบาร์โค้ด</th>
                        <th class="p-2 border text-left">กลุ่ม</th>
                        <th class="p-2 border text-left">หมวดหมู่</th>
                        <th class="p-2 border text-left">ชื่อวัสดุ</th>
                        <th class="p-2 border text-left">จำนวน</th>
                        <th class="p-2 border text-left">หน่วย</th>
                        <th class="p-2 border text-left">วันหมดอายุ</th>
                    </tr>
                </thead>
                <tbody>
            `;

            previewItems.forEach(item => {
                tableHTML += `
                    <tr>
                        <td class="p-2 border">${item.barcode}</td>
                        <td class="p-2 border">${item.group || '-'}</td>
                        <td class="p-2 border">${item.category}</td>
                        <td class="p-2 border">${item.name}</td>
                        <td class="p-2 border">${item.quantity}</td>
                        <td class="p-2 border">${item.unit}</td>
                        <td class="p-2 border">${item.expiry || '-'}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody>';
            previewTable.innerHTML = tableHTML;

            importCount.textContent = `พบข้อมูลที่จะนำเข้า ${importData.length} รายการ${importData.length > 5 ? ' (แสดงตัวอย่าง 5 รายการแรก)' : ''}`;
            
            previewDiv.classList.remove('hidden');
            importBtn.disabled = false;
        }

        async function importStockFromExcel() {
            if (importData.length === 0) {
                alert('ไม่มีข้อมูลที่จะนำเข้า');
                return;
            }

            const importBtn = document.getElementById('import-btn');
            importBtn.disabled = true;
            importBtn.textContent = 'กำลังนำเข้า...';

            let successCount = 0;
            let skipCount = 0;
            let errorCount = 0;

            try {
                for (const item of importData) {
                    try {
                        // ตรวจสอบว่ามีรหัสบาร์โค้ดซ้ำหรือไม่
                        const existingItem = sampleData.stock.find(s => s.barcode === item.barcode);
                        if (existingItem) {
                            skipCount++;
                            continue;
                        }

                        await saveToFirebase('stock', item.barcode, item);
                        successCount++;

                    } catch (error) {
                        console.error('Error importing item:', item, error);
                        errorCount++;
                    }
                }

                // แสดงผลลัพธ์
                let message = `การนำเข้าข้อมูลเสร็จสิ้น!\n`;
                message += `- นำเข้าสำเร็จ: ${successCount} รายการ\n`;
                if (skipCount > 0) message += `- ข้ามรายการที่ซ้ำ: ${skipCount} รายการ\n`;
                if (errorCount > 0) message += `- เกิดข้อผิดพลาด: ${errorCount} รายการ\n`;

                alert(message);

                // รีเฟรชข้อมูล
                await loadStock();
                loadMaterialCategories();
                
                closeImportStockModal();

            } catch (error) {
                console.error('Error during import:', error);
                alert('เกิดข้อผิดพลาดในการนำเข้าข้อมูล กรุณาลองใหม่อีกครั้ง');
            }

            importBtn.disabled = false;
            importBtn.textContent = 'นำเข้าข้อมูล';
        }

        async function editStock(barcode) {
            const item = sampleData.stock.find(s => s.barcode === barcode);
            if (item) {
                // Create a modal for editing
                const modal = document.createElement('div');
                modal.id = 'edit-stock-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold text-primary mb-4">แก้ไขรายการวัสดุ</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">รหัสบาร์โค้ด</label>
                                <input type="text" id="edit-barcode" value="${item.barcode}" class="input-field w-full" placeholder="กรอกรหัสบาร์โค้ด">
                                <p class="text-xs text-gray-500 mt-1">หากเปลี่ยนรหัสบาร์โค้ด ระบบจะสร้างรายการใหม่และลบรายการเดิม</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">กลุ่ม</label>
                                <input type="text" id="edit-group" value="${item.group || ''}" class="input-field w-full" placeholder="กรอกกลุ่มวัสดุ">
                                <p class="text-xs text-gray-500 mt-1">ระบุกลุ่มสำหรับจัดหมวดหมู่วัสดุ (เว้นว่างได้)</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">หมวดหมู่</label>
                                <input type="text" id="edit-category" value="${item.category}" class="input-field w-full">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">ชื่อวัสดุ</label>
                                <input type="text" id="edit-name" value="${item.name}" class="input-field w-full">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-2">จำนวน</label>
                                    <input type="number" id="edit-quantity" value="${item.quantity}" min="0" class="input-field w-full">
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-2">หน่วย</label>
                                    <input type="text" id="edit-unit" value="${item.unit}" class="input-field w-full">
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">วันหมดอายุ</label>
                                <input type="date" id="edit-expiry" value="${item.expiry || ''}" class="input-field w-full">
                                <p class="text-xs text-gray-500 mt-1">เว้นว่างหากไม่มีวันหมดอายุ</p>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="saveStockEdit('${barcode}')" class="btn btn-primary flex-1">บันทึก</button>
                            <button onclick="closeEditModal()" class="btn btn-secondary flex-1">ยกเลิก</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add click outside to close modal
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeEditModal();
                    }
                });
                
                // Focus on first editable field
                setTimeout(() => {
                    document.getElementById('edit-category').focus();
                }, 100);
            }
        }

        async function saveStockEdit(originalBarcode) {
            const newBarcode = document.getElementById('edit-barcode').value.trim();
            const group = document.getElementById('edit-group').value.trim();
            const category = document.getElementById('edit-category').value.trim();
            const name = document.getElementById('edit-name').value.trim();
            const quantity = parseInt(document.getElementById('edit-quantity').value) || 0;
            const unit = document.getElementById('edit-unit').value.trim();
            const expiry = document.getElementById('edit-expiry').value || null;
            
            if (!newBarcode || !category || !name || !unit) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }
            
            // Check if new barcode already exists (only if barcode changed)
            if (newBarcode !== originalBarcode) {
                const existingItem = sampleData.stock.find(s => s.barcode === newBarcode);
                if (existingItem) {
                    alert('รหัสบาร์โค้ดนี้มีอยู่แล้วในระบบ กรุณาใช้รหัสอื่น');
                    return;
                }
            }
            
            try {
                const updatedItem = {
                    barcode: newBarcode,
                    group: group || null, // อนุญาตให้เป็นค่าว่างได้
                    category: category,
                    name: name,
                    quantity: quantity,
                    unit: unit,
                    expiry: expiry
                };
                
                // If barcode changed, delete old item and create new one
                if (newBarcode !== originalBarcode) {
                    await deleteFromFirebase('stock', originalBarcode);
                    await saveToFirebase('stock', newBarcode, updatedItem);
                    alert('แก้ไขรายการวัสดุสำเร็จ (รหัสบาร์โค้ดใหม่: ' + newBarcode + ')');
                } else {
                    // Same barcode, just update
                    await saveToFirebase('stock', originalBarcode, updatedItem);
                    alert('แก้ไขรายการวัสดุสำเร็จ');
                }
                
                closeEditModal();
                loadStock();
                loadMaterialCategories(); // Refresh categories in case category changed
                
            } catch (error) {
                console.error('Error saving stock edit:', error);
                alert('เกิดข้อผิดพลาดในการบันทึกการแก้ไข');
            }
        }

        function closeEditModal() {
            // Try to find modal by ID first
            const modalById = document.getElementById('edit-stock-modal');
            if (modalById) {
                modalById.remove();
                return;
            }
            
            // Fallback: find all modals and remove them
            const modals = document.querySelectorAll('.fixed.inset-0.bg-black.bg-opacity-50');
            modals.forEach(modal => {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            });
        }

        async function deleteStock(barcode) {
            if (confirm('ต้องการลบรายการนี้หรือไม่?')) {
                try {
                    // หาชื่อรายการก่อนลบเพื่อแสดงข้อความ
                    const item = sampleData.stock.find(s => s.barcode === barcode);
                    const itemName = item ? item.name : 'รายการ';
                    
                    await deleteFromFirebase('stock', barcode);
                    
                    // แสดงข้อความสำเร็จ
                    alert(`ลบ "${itemName}" สำเร็จ!`);
                    
                    // รีโหลดการแสดงผลหลังจากที่ข้อมูลถูกอัปเดตแล้วใน deleteFromFirebase
                    filterStock();
                    loadStockCategories();
                    loadMaterialCategories(); // อัปเดตหน้าขอเบิกด้วย
                    
                } catch (error) {
                    console.error('Error deleting stock:', error);
                    alert('เกิดข้อผิดพลาดในการลบสต๊อก กรุณาลองใหม่อีกครั้ง');
                }
            }
        }

        function showAddStaff() {
            // Create modal for adding new staff
            const modal = document.createElement('div');
            modal.id = 'add-staff-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                    <div class="flex items-center mb-6">
                        <div class="bg-blue-100 rounded-full p-3 mr-4">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-primary">เพิ่มเจ้าหน้าที่ใหม่</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                                รหัสเจ้าหน้าที่ *
                            </label>
                            <input type="text" id="add-staff-id" class="input-field w-full" placeholder="กรอกรหัสเจ้าหน้าที่" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                ชื่อ-สกุล *
                            </label>
                            <input type="text" id="add-staff-name" class="input-field w-full" placeholder="กรอกชื่อ-สกุล" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0H8m8 0v2a2 2 0 01-2 2H10a2 2 0 01-2-2V6"></path>
                                </svg>
                                ตำแหน่ง *
                            </label>
                            <input type="text" id="add-staff-position" class="input-field w-full" placeholder="กรอกตำแหน่ง" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                                หน่วยงาน *
                            </label>
                            <input type="text" id="add-staff-department" class="input-field w-full" placeholder="กรอกหน่วยงาน" required>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveNewStaff()" class="btn btn-primary flex-1 flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            เพิ่มเจ้าหน้าที่
                        </button>
                        <button onclick="closeAddStaffModal()" class="btn btn-secondary flex-1 flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            ยกเลิก
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add click outside to close modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeAddStaffModal();
                }
            });
            
            // Add ESC key to close modal
            document.addEventListener('keydown', function handleEsc(e) {
                if (e.key === 'Escape') {
                    closeAddStaffModal();
                    document.removeEventListener('keydown', handleEsc);
                }
            });
            
            // Focus on first field
            setTimeout(() => {
                document.getElementById('add-staff-id').focus();
            }, 100);
        }

        async function saveNewStaff() {
            const id = document.getElementById('add-staff-id').value.trim();
            const name = document.getElementById('add-staff-name').value.trim();
            const position = document.getElementById('add-staff-position').value.trim();
            const department = document.getElementById('add-staff-department').value.trim();
            
            // Validation
            if (!id) {
                alert('กรุณากรอกรหัสเจ้าหน้าที่');
                document.getElementById('add-staff-id').focus();
                return;
            }
            
            if (!name) {
                alert('กรุณากรอกชื่อ-สกุล');
                document.getElementById('add-staff-name').focus();
                return;
            }
            
            if (!position) {
                alert('กรุณากรอกตำแหน่ง');
                document.getElementById('add-staff-position').focus();
                return;
            }
            
            if (!department) {
                alert('กรุณากรอกหน่วยงาน');
                document.getElementById('add-staff-department').focus();
                return;
            }
            
            // Check if ID already exists
            const existingStaff = sampleData.staff.find(s => s.id === id);
            if (existingStaff) {
                alert('รหัสเจ้าหน้าที่นี้มีอยู่แล้วในระบบ กรุณาใช้รหัสอื่น');
                document.getElementById('add-staff-id').focus();
                document.getElementById('add-staff-id').select();
                return;
            }
            
            try {
                const staffMember = { id, name, position, department };
                await saveToFirebase('staff', id, staffMember);
                
                closeAddStaffModal();
                loadStaff();
                
                // Show success message
                alert(`เพิ่มเจ้าหน้าที่ "${name}" สำเร็จ!`);
                
            } catch (error) {
                console.error('Error adding staff:', error);
                alert('เกิดข้อผิดพลาดในการเพิ่มเจ้าหน้าที่ กรุณาลองใหม่อีกครั้ง');
            }
        }

        function closeAddStaffModal() {
            const modal = document.getElementById('add-staff-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function editStaff(id) {
            const staff = sampleData.staff.find(s => s.id === id);
            if (staff) {
                // Create modal for editing staff
                const modal = document.createElement('div');
                modal.id = 'edit-staff-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                        <div class="flex items-center mb-6">
                            <div class="bg-yellow-100 rounded-full p-3 mr-4">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-primary">แก้ไขข้อมูลเจ้าหน้าที่</h3>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                    </svg>
                                    รหัสเจ้าหน้าที่
                                </label>
                                <input type="text" id="edit-staff-id" class="input-field w-full bg-gray-100" value="${staff.id}" readonly>
                                <p class="text-xs text-gray-500 mt-1">รหัสเจ้าหน้าที่ไม่สามารถแก้ไขได้</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    ชื่อ-สกุล *
                                </label>
                                <input type="text" id="edit-staff-name" class="input-field w-full" value="${staff.name}" required>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0H8m8 0v2a2 2 0 01-2 2H10a2 2 0 01-2-2V6"></path>
                                    </svg>
                                    ตำแหน่ง *
                                </label>
                                <input type="text" id="edit-staff-position" class="input-field w-full" value="${staff.position}" required>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                    หน่วยงาน *
                                </label>
                                <input type="text" id="edit-staff-department" class="input-field w-full" value="${staff.department}" required>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button onclick="saveStaffEdit('${id}')" class="btn btn-primary flex-1 flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                บันทึกการแก้ไข
                            </button>
                            <button onclick="closeEditStaffModal()" class="btn btn-secondary flex-1 flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                ยกเลิก
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add click outside to close modal
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeEditStaffModal();
                    }
                });
                
                // Add ESC key to close modal
                document.addEventListener('keydown', function handleEsc(e) {
                    if (e.key === 'Escape') {
                        closeEditStaffModal();
                        document.removeEventListener('keydown', handleEsc);
                    }
                });
                
                // Focus on first editable field
                setTimeout(() => {
                    document.getElementById('edit-staff-name').focus();
                    document.getElementById('edit-staff-name').select();
                }, 100);
            }
        }

        async function saveStaffEdit(id) {
            const name = document.getElementById('edit-staff-name').value.trim();
            const position = document.getElementById('edit-staff-position').value.trim();
            const department = document.getElementById('edit-staff-department').value.trim();
            
            // Validation
            if (!name) {
                alert('กรุณากรอกชื่อ-สกุล');
                document.getElementById('edit-staff-name').focus();
                return;
            }
            
            if (!position) {
                alert('กรุณากรอกตำแหน่ง');
                document.getElementById('edit-staff-position').focus();
                return;
            }
            
            if (!department) {
                alert('กรุณากรอกหน่วยงาน');
                document.getElementById('edit-staff-department').focus();
                return;
            }
            
            try {
                const staffMember = { id, name, position, department };
                await saveToFirebase('staff', id, staffMember);
                
                closeEditStaffModal();
                loadStaff();
                
                // Show success message
                alert(`แก้ไขข้อมูลเจ้าหน้าที่ "${name}" สำเร็จ!`);
                
            } catch (error) {
                console.error('Error editing staff:', error);
                alert('เกิดข้อผิดพลาดในการแก้ไขข้อมูลเจ้าหน้าที่ กรุณาลองใหม่อีกครั้ง');
            }
        }

        function closeEditStaffModal() {
            const modal = document.getElementById('edit-staff-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function deleteStaff(id) {
            if (confirm('ต้องการลบเจ้าหน้าที่นี้หรือไม่?')) {
                try {
                    await deleteFromFirebase('staff', id);
                    loadStaff();
                } catch (error) {
                    console.error('Error deleting staff:', error);
                    alert('เกิดข้อผิดพลาดในการลบเจ้าหน้าที่');
                }
            }
        }

        function showAddUser() {
            // Create modal for adding new user
            const modal = document.createElement('div');
            modal.id = 'add-user-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                    <div class="flex items-center mb-6">
                        <div class="bg-green-100 rounded-full p-3 mr-4">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-primary">เพิ่มบัญชีผู้ใช้ใหม่</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                ชื่อ-สกุล *
                            </label>
                            <input type="text" id="add-user-name" class="input-field w-full" placeholder="กรอกชื่อ-สกุล" required>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                </svg>
                                ชื่อผู้ใช้ (Username) *
                            </label>
                            <input type="text" id="add-user-username" class="input-field w-full" placeholder="กรอกชื่อผู้ใช้" required>
                            <p class="text-xs text-gray-500 mt-1">ใช้สำหรับเข้าสู่ระบบ</p>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                                รหัสผ่าน *
                            </label>
                            <div class="relative">
                                <input type="password" id="add-user-password" class="input-field w-full pr-10" placeholder="กรอกรหัสผ่าน" required>
                                <button type="button" onclick="togglePasswordVisibility('add-user-password', 'add-password-toggle')" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                    <svg id="add-password-toggle" class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">ควรมีความยาวอย่างน้อย 6 ตัวอักษร</p>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                ยืนยันรหัสผ่าน *
                            </label>
                            <div class="relative">
                                <input type="password" id="add-user-confirm-password" class="input-field w-full pr-10" placeholder="กรอกรหัสผ่านอีกครั้ง" required>
                                <button type="button" onclick="togglePasswordVisibility('add-user-confirm-password', 'add-confirm-password-toggle')" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                    <svg id="add-confirm-password-toggle" class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveNewUser()" class="btn btn-primary flex-1 flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                            </svg>
                            เพิ่มผู้ใช้
                        </button>
                        <button onclick="closeAddUserModal()" class="btn btn-secondary flex-1 flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            ยกเลิก
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add click outside to close modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeAddUserModal();
                }
            });
            
            // Add ESC key to close modal
            document.addEventListener('keydown', function handleEsc(e) {
                if (e.key === 'Escape') {
                    closeAddUserModal();
                    document.removeEventListener('keydown', handleEsc);
                }
            });
            
            // Focus on first field
            setTimeout(() => {
                document.getElementById('add-user-name').focus();
            }, 100);
        }

        function togglePasswordVisibility(inputId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const toggleIcon = document.getElementById(iconId);
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                `;
            } else {
                passwordInput.type = 'password';
                toggleIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                `;
            }
        }

        async function saveNewUser() {
            const name = document.getElementById('add-user-name').value.trim();
            const username = document.getElementById('add-user-username').value.trim();
            const password = document.getElementById('add-user-password').value;
            const confirmPassword = document.getElementById('add-user-confirm-password').value;
            
            // Validation
            if (!name) {
                alert('กรุณากรอกชื่อ-สกุล');
                document.getElementById('add-user-name').focus();
                return;
            }
            
            if (!username) {
                alert('กรุณากรอกชื่อผู้ใช้');
                document.getElementById('add-user-username').focus();
                return;
            }
            
            // Check username format
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                alert('ชื่อผู้ใช้ควรประกอบด้วย ตัวอักษร ตัวเลข หรือเครื่องหมาย _ เท่านั้น');
                document.getElementById('add-user-username').focus();
                document.getElementById('add-user-username').select();
                return;
            }
            
            if (!password) {
                alert('กรุณากรอกรหัสผ่าน');
                document.getElementById('add-user-password').focus();
                return;
            }
            
            if (password.length < 6) {
                alert('รหัสผ่านควรมีความยาวอย่างน้อย 6 ตัวอักษร');
                document.getElementById('add-user-password').focus();
                document.getElementById('add-user-password').select();
                return;
            }
            
            if (password !== confirmPassword) {
                alert('รหัสผ่านไม่ตรงกัน กรุณาตรวจสอบอีกครั้ง');
                document.getElementById('add-user-confirm-password').focus();
                document.getElementById('add-user-confirm-password').select();
                return;
            }
            
            // Check if username already exists
            const existingUser = sampleData.users.find(u => u.username === username);
            if (existingUser) {
                alert('ชื่อผู้ใช้นี้มีอยู่แล้วในระบบ กรุณาใช้ชื่อผู้ใช้อื่น');
                document.getElementById('add-user-username').focus();
                document.getElementById('add-user-username').select();
                return;
            }
            
            try {
                const userId = 'user' + Date.now();
                const id = Math.max(...sampleData.users.map(u => u.id), 0) + 1;
                const user = { id, name, username, password };
                await saveToFirebase('users', userId, user);
                
                closeAddUserModal();
                loadUsers();
                
                // Show success message
                alert(`เพิ่มบัญชีผู้ใช้ "${name}" สำเร็จ!`);
                
            } catch (error) {
                console.error('Error adding user:', error);
                alert('เกิดข้อผิดพลาดในการเพิ่มผู้ใช้ กรุณาลองใหม่อีกครั้ง');
            }
        }

        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function editUser(id) {
            const user = firebaseData.users.find(u => u.id === parseInt(id));
            if (user) {
                // Create modal for editing user
                const modal = document.createElement('div');
                modal.id = 'edit-user-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                        <div class="flex items-center mb-6">
                            <div class="bg-orange-100 rounded-full p-3 mr-4">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-primary">แก้ไขบัญชีผู้ใช้</h3>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    ชื่อ-สกุล *
                                </label>
                                <input type="text" id="edit-user-name" class="input-field w-full" value="${user.name}" required>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                    </svg>
                                    ชื่อผู้ใช้ (Username)
                                </label>
                                <input type="text" id="edit-user-username" class="input-field w-full bg-gray-100" value="${user.username}" readonly>
                                <p class="text-xs text-gray-500 mt-1">ชื่อผู้ใช้ไม่สามารถแก้ไขได้</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                    </svg>
                                    รหัสผ่านใหม่ *
                                </label>
                                <div class="relative">
                                    <input type="password" id="edit-user-password" class="input-field w-full pr-10" placeholder="กรอกรหัสผ่านใหม่" required>
                                    <button type="button" onclick="togglePasswordVisibility('edit-user-password', 'edit-password-toggle')" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                        <svg id="edit-password-toggle" class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">ความยาวอย่างน้อย 6 ตัวอักษร</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    ยืนยันรหัสผ่านใหม่ *
                                </label>
                                <div class="relative">
                                    <input type="password" id="edit-user-confirm-password" class="input-field w-full pr-10" placeholder="กรอกรหัสผ่านอีกครั้ง" required>
                                    <button type="button" onclick="togglePasswordVisibility('edit-user-confirm-password', 'edit-confirm-password-toggle')" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                        <svg id="edit-confirm-password-toggle" class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-4">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-medium">หมายเหตุ:</p>
                                        <p>• ชื่อผู้ใช้ไม่สามารถเปลี่ยนแปลงได้</p>
                                        <p>• รหัสผ่านใหม่จะใช้แทนรหัสผ่านเดิม</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button onclick="saveUserEdit('${id}')" class="btn btn-primary flex-1 flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                บันทึกการแก้ไข
                            </button>
                            <button onclick="closeEditUserModal()" class="btn btn-secondary flex-1 flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                ยกเลิก
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add click outside to close modal
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeEditUserModal();
                    }
                });
                
                // Add ESC key to close modal
                document.addEventListener('keydown', function handleEsc(e) {
                    if (e.key === 'Escape') {
                        closeEditUserModal();
                        document.removeEventListener('keydown', handleEsc);
                    }
                });
                
                // Focus on first editable field
                setTimeout(() => {
                    document.getElementById('edit-user-name').focus();
                    document.getElementById('edit-user-name').select();
                }, 100);
            }
        }

        async function saveUserEdit(id) {
            const name = document.getElementById('edit-user-name').value.trim();
            const password = document.getElementById('edit-user-password').value;
            const confirmPassword = document.getElementById('edit-user-confirm-password').value;
            
            // Validation
            if (!name) {
                alert('กรุณากรอกชื่อ-สกุล');
                document.getElementById('edit-user-name').focus();
                return;
            }
            
            if (!password) {
                alert('กรุณากรอกรหัสผ่านใหม่');
                document.getElementById('edit-user-password').focus();
                return;
            }
            
            if (password.length < 6) {
                alert('รหัสผ่านควรมีความยาวอย่างน้อย 6 ตัวอักษร');
                document.getElementById('edit-user-password').focus();
                document.getElementById('edit-user-password').select();
                return;
            }
            
            if (password !== confirmPassword) {
                alert('รหัสผ่านไม่ตรงกัน กรุณาตรวจสอบอีกครั้ง');
                document.getElementById('edit-user-confirm-password').focus();
                document.getElementById('edit-user-confirm-password').select();
                return;
            }
            
            try {
                // Find user in local data
                const user = firebaseData.users.find(u => u.id === parseInt(id));
                if (user) {
                    // Update user data
                    user.name = name;
                    user.password = password;
                    
                    // Get all users from Firebase to find the correct key
                    const usersSnapshot = await firebase.get(firebase.ref(firebase.database, 'users'));
                    const usersData = usersSnapshot.exists() ? usersSnapshot.val() : {};
                    
                    // Find the Firebase key for this user
                    let userKey = null;
                    for (const [key, userData] of Object.entries(usersData)) {
                        if (userData.id === parseInt(id)) {
                            userKey = key;
                            break;
                        }
                    }
                    
                    // If user key not found, create a new one
                    if (!userKey) {
                        userKey = 'user_' + id;
                    }
                    
                    // Save to Firebase
                    await saveToFirebase('users', userKey, user);
                    
                    closeEditUserModal();
                    loadUsers();
                    
                    // Show success message
                    alert(`แก้ไขบัญชีผู้ใช้ "${name}" สำเร็จ!`);
                } else {
                    alert('ไม่พบข้อมูลผู้ใช้');
                }
            } catch (error) {
                console.error('Error editing user:', error);
                alert('เกิดข้อผิดพลาดในการแก้ไขผู้ใช้ กรุณาลองใหม่อีกครั้ง');
            }
        }

        function closeEditUserModal() {
            const modal = document.getElementById('edit-user-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function deleteUser(id) {
            if (confirm('ต้องการลบผู้ใช้นี้หรือไม่?')) {
                try {
                    const usersSnapshot = await firebase.get(firebase.ref(firebase.database, 'users'));
                    const usersData = usersSnapshot.exists() ? usersSnapshot.val() : {};
                    
                    // Find the Firebase key for this user
                    let userKey = null;
                    for (const [key, userData] of Object.entries(usersData)) {
                        if (userData.id === parseInt(id)) {
                            userKey = key;
                            break;
                        }
                    }
                    
                    if (userKey) {
                        await deleteFromFirebase('users', userKey);
                        loadUsers();
                        alert('ลบผู้ใช้สำเร็จ!');
                    } else {
                        alert('ไม่พบข้อมูลผู้ใช้ที่ต้องการลบ');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('เกิดข้อผิดพลาดในการลบผู้ใช้');
                }
            }
        }

        async function deleteHistory(transactionId) {
            if (confirm('ต้องการลบประวัติรายการนี้หรือไม่?\n\n⚠️ หมายเหตุ: การลบประวัติจะไม่ส่งผลต่อจำนวนสต๊อกปัจจุบัน')) {
                try {
                    await deleteFromFirebase('history', transactionId);
                    loadHistory();
                    alert('ลบประวัติรายการสำเร็จ');
                } catch (error) {
                    console.error('Error deleting history:', error);
                    alert('เกิดข้อผิดพลาดในการลบประวัติรายการ');
                }
            }
        }

        // Export functions
        function exportReceipt(transactionId) {
            const transaction = sampleData.history.find(t => t.id === transactionId);
            if (transaction) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.text('ใบเสร็จ', 20, 20);
                doc.text(`เลขที่: ${transaction.id}`, 20, 30);
                doc.text(`วันที่: ${transaction.date} ${transaction.time}`, 20, 40);
                
                let y = 60;
                transaction.items.forEach(item => {
                    doc.text(`${item.name} - ${item.quantity} ${item.unit}`, 20, y);
                    y += 10;
                });
                
                doc.save(`receipt-${transaction.id}.pdf`);
            }
        }

        function exportAllHistory() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text('ประวัติการทำรายการทั้งหมด', 20, 20);
            
            let y = 40;
            sampleData.history.forEach(transaction => {
                doc.text(`${transaction.id} - ${transaction.date}`, 20, y);
                y += 10;
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
            });
            
            doc.save('all-history.pdf');
        }

        function exportStockToExcel() {
            try {
                // อ่านค่าตัวกรองปัจจุบันจาก UI
                const searchInput = document.getElementById('stock-search');
                const groupFilter = document.getElementById('stock-group-filter');
                const categoryFilter = document.getElementById('stock-category-filter');
                const statusFilter = document.getElementById('stock-status-filter');
                
                const searchText = searchInput ? searchInput.value.toLowerCase().trim() : '';
                const selectedGroup = groupFilter ? groupFilter.value : '';
                const selectedCategory = categoryFilter ? categoryFilter.value : '';
                const selectedStatus = statusFilter ? statusFilter.value : '';
                
                // กรองข้อมูลตามตัวกรองที่ตั้งค่าไว้ (ใช้ logic เดียวกับ filterStock)
                const filteredStock = sampleData.stock.filter(item => {
                    // ตรวจสอบการค้นหาข้อความ
                    const searchableText = `${item.barcode} ${item.group || ''} ${item.name} ${item.category}`.toLowerCase();
                    const matchesSearch = !searchText || searchableText.includes(searchText);
                    
                    // ตรวจสอบกลุ่ม
                    const matchesGroup = !selectedGroup || (item.group || '') === selectedGroup;
                    
                    // ตรวจสอบหมวดหมู่
                    const matchesCategory = !selectedCategory || item.category === selectedCategory;
                    
                    // ตรวจสอบสถานะ
                    let matchesStatus = true;
                    if (selectedStatus) {
                        const currentDate = Date.now();
                        const thirtyDaysFromNow = currentDate + (30 * 24 * 60 * 60 * 1000);
                        const quantity = parseInt(item.quantity);
                        
                        switch (selectedStatus) {
                            case 'normal':
                                matchesStatus = quantity >= 10 && quantity > 0 && (!item.expiry || new Date(item.expiry).getTime() > thirtyDaysFromNow);
                                break;
                            case 'low':
                                matchesStatus = quantity < 10 && quantity > 0;
                                break;
                            case 'out-of-stock':
                                matchesStatus = quantity === 0;
                                break;
                            case 'expiring':
                                matchesStatus = item.expiry && new Date(item.expiry).getTime() <= thirtyDaysFromNow && new Date(item.expiry).getTime() > currentDate;
                                break;
                            case 'expired':
                                matchesStatus = item.expiry && new Date(item.expiry).getTime() <= currentDate;
                                break;
                        }
                    }
                    
                    return matchesSearch && matchesGroup && matchesCategory && matchesStatus;
                });
                
                // ตรวจสอบว่ามีข้อมูลที่จะส่งออกหรือไม่
                if (filteredStock.length === 0) {
                    alert('ไม่มีข้อมูลที่จะส่งออกตามตัวกรองที่ตั้งค่าไว้');
                    return;
                }

                // เตรียมข้อมูลสำหรับ Excel โดยใช้ข้อมูลที่กรองแล้ว
                const stockData = filteredStock.map(item => {
                    // คำนวณสถานะ
                    const currentDate = Date.now();
                    const thirtyDaysFromNow = currentDate + (30 * 24 * 60 * 60 * 1000);
                    const quantity = parseInt(item.quantity);
                    let status = 'ปกติ';
                    
                    if (quantity === 0) {
                        status = 'สินค้าหมด';
                    } else if (quantity < 10) {
                        status = 'ใกล้หมด';
                    } else if (item.expiry && new Date(item.expiry).getTime() <= currentDate) {
                        status = 'หมดอายุแล้ว';
                    } else if (item.expiry && new Date(item.expiry).getTime() <= thirtyDaysFromNow) {
                        status = 'ใกล้หมดอายุ';
                    }
                    
                    return {
                        'รหัสบาร์โค้ด': item.barcode,
                        'กลุ่ม': item.group || '-',
                        'หมวดหมู่': item.category,
                        'รายการวัสดุ': item.name,
                        'จำนวนคงเหลือ': item.quantity,
                        'หน่วย': item.unit,
                        'วันหมดอายุ': item.expiry || '-',
                        'สถานะ': status
                    };
                });

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(stockData);

                // Set column widths
                const colWidths = [
                    { wch: 15 }, // รหัสบาร์โค้ด
                    { wch: 15 }, // กลุ่ม
                    { wch: 20 }, // หมวดหมู่
                    { wch: 30 }, // รายการวัสดุ
                    { wch: 15 }, // จำนวนคงเหลือ
                    { wch: 10 }, // หน่วย
                    { wch: 15 }, // วันหมดอายุ
                    { wch: 15 }  // สถานะ
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'สต๊อกวัสดุ');

                // สร้างชื่อไฟล์ที่สะท้อนตัวกรองที่ใช้
                const currentDate = new Date().toLocaleDateString('th-TH').replace(/\//g, '-');
                let filenameParts = ['สต๊อกวัสดุ'];
                
                // เพิ่มตัวกรองในชื่อไฟล์
                if (searchText) {
                    filenameParts.push(`ค้นหา-${searchText}`);
                }
                if (selectedGroup) {
                    filenameParts.push(`กลุ่ม-${selectedGroup}`);
                }
                if (selectedCategory) {
                    filenameParts.push(`หมวดหมู่-${selectedCategory}`);
                }
                if (selectedStatus) {
                    const statusNames = {
                        'normal': 'ปกติ',
                        'low': 'ใกล้หมด',
                        'out-of-stock': 'สินค้าหมด',
                        'expiring': 'ใกล้หมดอายุ',
                        'expired': 'หมดอายุแล้ว'
                    };
                    filenameParts.push(`สถานะ-${statusNames[selectedStatus]}`);
                }
                
                filenameParts.push(currentDate);
                const filename = filenameParts.join('_') + '.xlsx';

                // Save file
                XLSX.writeFile(wb, filename);
                
                // สร้างข้อความแจ้งเตือนที่ระบุจำนวนรายการที่ส่งออก
                let message = `ส่งออกไฟล์ Excel สำเร็จ!\nจำนวนรายการที่ส่งออก: ${filteredStock.length} รายการ`;
                
                if (searchText || selectedGroup || selectedCategory || selectedStatus) {
                    message += '\n\nตัวกรองที่ใช้:';
                    if (searchText) message += `\n- ค้นหา: "${searchText}"`;
                    if (selectedGroup) message += `\n- กลุ่ม: ${selectedGroup}`;
                    if (selectedCategory) message += `\n- หมวดหมู่: ${selectedCategory}`;
                    if (selectedStatus) {
                        const statusNames = {
                            'normal': 'ปกติ',
                            'low': 'ใกล้หมด',
                            'out-of-stock': 'สินค้าหมด',
                            'expiring': 'ใกล้หมดอายุ',
                            'expired': 'หมดอายุแล้ว'
                        };
                        message += `\n- สถานะ: ${statusNames[selectedStatus]}`;
                    }
                } else {
                    message += '\n(ส่งออกข้อมูลทั้งหมด)';
                }
                
                alert(message);
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('เกิดข้อผิดพลาดในการส่งออกไฟล์ Excel');
            }
        }

        function exportHistoryToExcel() {
            try {
                // Sort history by date and time (newest first)
                const sortedHistory = [...sampleData.history].sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateB - dateA; // Newest first
                });
                
                // Prepare data for Excel - expand each transaction item into separate rows
                const historyData = [];
                
                sortedHistory.forEach(transaction => {
                    transaction.items.forEach(item => {
                        const rowData = {
                            'เลขที่รายการ': transaction.id,
                            'ประเภท': transaction.type === 'withdraw' ? 'เบิกวัสดุ' : 'รับวัสดุ',
                            'วันที่': transaction.date,
                            'เวลา': transaction.time
                        };

                        // Add specific fields based on transaction type
                        if (transaction.type === 'withdraw') {
                            rowData['ผู้เบิก'] = transaction.name;
                            rowData['วัตถุประสงค์'] = transaction.purpose;
                            rowData['แหล่งที่มา'] = '-';
                            rowData['ผู้รับ'] = '-';
                        } else {
                            rowData['ผู้เบิก'] = '-';
                            rowData['วัตถุประสงค์'] = '-';
                            rowData['แหล่งที่มา'] = transaction.source;
                            rowData['ผู้รับ'] = transaction.receiver;
                        }

                        // Add individual item details in separate columns
                        rowData['รายการวัสดุ'] = item.name;
                        rowData['จำนวน'] = item.quantity;
                        rowData['หน่วย'] = item.unit;

                        historyData.push(rowData);
                    });
                });

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(historyData);

                // Set column widths
                const colWidths = [
                    { wch: 15 }, // เลขที่รายการ
                    { wch: 12 }, // ประเภท
                    { wch: 12 }, // วันที่
                    { wch: 10 }, // เวลา
                    { wch: 25 }, // ผู้เบิก
                    { wch: 30 }, // วัตถุประสงค์
                    { wch: 20 }, // แหล่งที่มา
                    { wch: 20 }, // ผู้รับ
                    { wch: 30 }, // รายการวัสดุ
                    { wch: 10 }, // จำนวน
                    { wch: 10 }  // หน่วย
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'ประวัติการทำรายการ');

                // Generate filename with current date
                const currentDate = new Date().toLocaleDateString('th-TH').replace(/\//g, '-');
                const filename = `ประวัติการทำรายการ_${currentDate}.xlsx`;

                // Save file
                XLSX.writeFile(wb, filename);
                
                alert('ส่งออกไฟล์ Excel สำเร็จ!');
                
            } catch (error) {
                console.error('Error exporting history to Excel:', error);
                alert('เกิดข้อผิดพลาดในการส่งออกไฟล์ Excel');
            }
        }

        function exportRequestsToExcel() {
            try {
                // Sort requests by date (newest first)
                const sortedRequests = [...sampleData.requests].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateB - dateA; // Newest first
                });
                
                // Prepare data for Excel - expand each request item into separate rows
                const requestsData = [];
                
                sortedRequests.forEach(request => {
                    request.items.forEach(item => {
                        const statusText = request.status === 'pending' ? 'รอพิจารณา' : 
                                          request.status === 'approved' ? 'อนุมัติ' : 'ไม่อนุมัติ';
                        
                        const rowData = {
                            'เลขที่ใบคำร้อง': request.id,
                            'วันที่': request.date,
                            'ชื่อ-สกุล': request.name,
                            'ตำแหน่ง': request.position,
                            'หน่วยงาน': request.department,
                            'เบอร์โทรศัพท์': request.phone,
                            'วัตถุประสงค์': request.purpose,
                            'สถานะ': statusText,
                            'รายการวัสดุ': item.name,
                            'จำนวน': item.quantity,
                            'หน่วย': item.unit
                        };

                        requestsData.push(rowData);
                    });
                });

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(requestsData);

                // Set column widths
                const colWidths = [
                    { wch: 15 }, // เลขที่ใบคำร้อง
                    { wch: 12 }, // วันที่
                    { wch: 25 }, // ชื่อ-สกุล
                    { wch: 20 }, // ตำแหน่ง
                    { wch: 25 }, // หน่วยงาน
                    { wch: 15 }, // เบอร์โทรศัพท์
                    { wch: 30 }, // วัตถุประสงค์
                    { wch: 12 }, // สถานะ
                    { wch: 30 }, // รายการวัสดุ
                    { wch: 10 }, // จำนวน
                    { wch: 10 }  // หน่วย
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'ใบคำร้องขอเบิก');

                // Generate filename with current date
                const currentDate = new Date().toLocaleDateString('th-TH').replace(/\//g, '-');
                const filename = `ใบคำร้องขอเบิก_${currentDate}.xlsx`;

                // Save file
                XLSX.writeFile(wb, filename);
                
                alert('ส่งออกไฟล์ Excel สำเร็จ!');
                
            } catch (error) {
                console.error('Error exporting requests to Excel:', error);
                alert('เกิดข้อผิดพลาดในการส่งออกไฟล์ Excel');
            }
        }

        function exportStaffToExcel() {
            try {
                // Prepare data for Excel
                const staffData = sampleData.staff.map(staff => ({
                    'รหัสเจ้าหน้าที่': staff.id,
                    'ชื่อ-สกุล': staff.name,
                    'ตำแหน่ง': staff.position,
                    'หน่วยงาน': staff.department
                }));

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(staffData);

                // Set column widths
                const colWidths = [
                    { wch: 15 }, // รหัสเจ้าหน้าที่
                    { wch: 30 }, // ชื่อ-สกุล
                    { wch: 25 }, // ตำแหน่ง
                    { wch: 30 }  // หน่วยงาน
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'ข้อมูลเจ้าหน้าที่');

                // Generate filename with current date
                const currentDate = new Date().toLocaleDateString('th-TH').replace(/\//g, '-');
                const filename = `ข้อมูลเจ้าหน้าที่_${currentDate}.xlsx`;

                // Save file
                XLSX.writeFile(wb, filename);
                
                alert('ส่งออกไฟล์ Excel สำเร็จ!');
                
            } catch (error) {
                console.error('Error exporting staff to Excel:', error);
                alert('เกิดข้อผิดพลาดในการส่งออกไฟล์ Excel');
            }
        }

        async function showAddNewMaterial() {
            const barcode = prompt('รหัสบาร์โค้ดใหม่:');
            const category = prompt('หมวดหมู่:');
            const name = prompt('ชื่อวัสดุ:');
            const unit = prompt('หน่วย:');
            const quantity = prompt('จำนวนที่รับ:');
            
            if (barcode && category && name && unit && quantity) {
                try {
                    const stockItem = {
                        barcode: barcode,
                        category: category,
                        name: name,
                        quantity: parseInt(quantity),
                        unit: unit,
                        expiry: null
                    };
                    
                    await saveToFirebase('stock', barcode, stockItem);
                    
                    receiveItems.push({
                        barcode: barcode,
                        name: name,
                        quantity: parseInt(quantity),
                        unit: unit
                    });
                    
                    updateReceiveItems();
                    loadMaterialCategories();
                    alert('เพิ่มรายการวัสดุใหม่สำเร็จ');
                } catch (error) {
                    console.error('Error adding new material:', error);
                    alert('เกิดข้อผิดพลาดในการเพิ่มวัสดุใหม่');
                }
            }
        }

        // ระบบ Real-time monitoring สำหรับใบคำร้อง
        let requestsLastCheckTime = Date.now();
        let requestsMonitoringInterval = null;

        function startRequestsMonitoring() {
            // หยุดการ monitoring เดิมก่อน
            if (requestsMonitoringInterval) {
                clearInterval(requestsMonitoringInterval);
            }
            
            // เริ่มตรวจสอบทุก 3 วินาที
            requestsMonitoringInterval = setInterval(async () => {
                // ตรวจสอบเฉพาะเมื่อผู้ใช้อยู่ในหน้าจัดการใบคำร้อง
                const requestsPage = document.getElementById('requests-page');
                if (requestsPage && !requestsPage.classList.contains('hidden')) {
                    try {
                        // ตรวจสอบว่ามีข้อมูลใหม่หรือไม่จาก Firebase
                        const requestsSnapshot = await firebase.get(firebase.ref(firebase.database, 'requests'));
                        const firebaseRequests = requestsSnapshot.val() || {};
                        
                        // แปลงข้อมูลจาก Firebase เป็น array
                        const firebaseRequestsArray = Object.values(firebaseRequests);
                        
                        // ตรวจสอบว่ามีรายการใหม่หรือไม่
                        const newRequests = firebaseRequestsArray.filter(request => {
                            const requestTime = request.timestamp || parseInt(request.id.replace('REQ', '')) || 0;
                            return requestTime > requestsLastCheckTime;
                        });
                        
                        // ถ้ามีรายการใหม่ ให้อัปเดตข้อมูลและแสดงผล
                        if (newRequests.length > 0) {
                            // อัปเดตข้อมูลใน sampleData
                            sampleData.requests = firebaseRequestsArray;
                            
                            // รีโหลดการแสดงผลด้วย filter ปัจจุบัน
                            filterRequests();
                            
                            // แสดงการแจ้งเตือนแบบเรียบง่าย
                            showNewRequestNotification(newRequests.length);
                            
                            // อัปเดตเวลาตรวจสอบล่าสุด
                            requestsLastCheckTime = Date.now();
                        }
                    } catch (error) {
                        console.log('Error monitoring requests:', error);
                        // ไม่แสดง error ให้ผู้ใช้เห็นเพื่อไม่ให้รบกวน
                    }
                }
            }, 3000); // ตรวจสอบทุก 3 วินาที
        }

        function stopRequestsMonitoring() {
            if (requestsMonitoringInterval) {
                clearInterval(requestsMonitoringInterval);
                requestsMonitoringInterval = null;
            }
        }

        function showNewRequestNotification(count) {
            // สร้างการแจ้งเตือนแบบเรียบง่าย
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>มีใบคำร้องใหม่ ${count} รายการ</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // อัปเดตข้อมูลในแดชบอร์ดถ้าผู้ใช้อยู่ในหน้าแดชบอร์ด
            const dashboardPage = document.getElementById('admin-dashboard');
            if (dashboardPage && !dashboardPage.classList.contains('hidden')) {
                updateDashboardStats();
                loadRecentRequests();
            }
            
            // ซ่อนการแจ้งเตือนหลังจาก 3 วินาที
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }
            }, 3000);
        }

        // Dashboard monitoring และการโหลดข้อมูลสถิติ
        let dashboardMonitoringInterval = null;

        function loadDashboardData() {
            // โหลดสถิติต่างๆ
            updateDashboardStats();
            
            // โหลดใบคำร้องล่าสุด
            loadRecentRequests();
            
            // โหลดสถิติรายสัปดาห์
            updateWeeklyStats();
            
            // โหลดวัสดุยอดนิยม
            updatePopularItems();
            
            // โหลดรายการวัสดุใกล้หมดอายุและหมดอายุแล้ว
            updateExpiryItemsLists();
        }

        function updateDashboardStats() {
            // นับใบคำร้องที่รอพิจารณา (สถานะ 'รออนุมัติ' หรือ 'pending')
            const pendingRequests = sampleData.requests.filter(req => 
                req.status === 'รออนุมัติ' || req.status === 'pending'
            ).length;
            document.getElementById('pending-requests-count').textContent = pendingRequests;
            
            // อัปเดต badge ที่ปุ่มใบคำร้อง
            const requestsBadge = document.getElementById('requests-badge');
            if (pendingRequests > 0) {
                requestsBadge.textContent = pendingRequests;
                requestsBadge.classList.remove('hidden');
            } else {
                requestsBadge.classList.add('hidden');
            }
            
            // นับรายการในสต๊อก
            const totalItems = sampleData.stock.length;
            document.getElementById('total-items-count').textContent = totalItems;
            
            // นับสินค้าใกล้หมด (น้อยกว่า 10 ชิ้นแต่ไม่เป็น 0)
            const lowStockItems = sampleData.stock.filter(item => item.quantity < 10 && item.quantity > 0).length;
            document.getElementById('low-stock-count').textContent = lowStockItems;
            
            // นับสินค้าหมด (quantity = 0)
            const outOfStockItems = sampleData.stock.filter(item => item.quantity === 0).length;
            if (document.getElementById('out-of-stock-count')) {
                document.getElementById('out-of-stock-count').textContent = outOfStockItems;
            }
            
            // นับวัสดุใกล้หมดอายุและหมดอายุแล้ว
            const currentDate = Date.now();
            const thirtyDaysFromNow = currentDate + (30 * 24 * 60 * 60 * 1000);
            
            // วัสดุใกล้หมดอายุ (ใน 30 วันข้างหน้า)
            const expiringSoonItems = sampleData.stock.filter(item => {
                if (!item.expiry) return false;
                const expiryDate = new Date(item.expiry).getTime();
                return expiryDate <= thirtyDaysFromNow && expiryDate > currentDate;
            }).length;
            document.getElementById('expiring-soon-count').textContent = expiringSoonItems;
            
            // วัสดุหมดอายุแล้ว
            const expiredItems = sampleData.stock.filter(item => {
                if (!item.expiry) return false;
                const expiryDate = new Date(item.expiry).getTime();
                return expiryDate <= currentDate;
            }).length;
            document.getElementById('expired-items-count').textContent = expiredItems;
            
            // นับผู้ใช้งานทั้งหมด
            const totalUsers = sampleData.users.length + sampleData.staff.length;
            document.getElementById('total-users-count').textContent = totalUsers;
        }

        function updateExpiryItemsLists() {
            updateExpiringSoonItems();
            updateExpiredItems();
        }

        function updateExpiringSoonItems() {
            const container = document.getElementById('expiring-soon-items');
            if (!container) return;

            const currentDate = Date.now();
            const thirtyDaysFromNow = currentDate + (30 * 24 * 60 * 60 * 1000);

            // หาวัสดุใกล้หมดอายุ (ใน 30 วันข้างหน้า)
            const expiringSoonItems = sampleData.stock.filter(item => {
                if (!item.expiry) return false;
                const expiryDate = new Date(item.expiry).getTime();
                return expiryDate <= thirtyDaysFromNow && expiryDate > currentDate;
            }).sort((a, b) => {
                // เรียงตามวันหมดอายุ (ใกล้หมดอายุมากสุดก่อน)
                return new Date(a.expiry).getTime() - new Date(b.expiry).getTime();
            });

            if (expiringSoonItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-sm">ไม่มีวัสดุใกล้หมดอายุ</p>
                        <p class="text-xs text-gray-400 mt-1">วัสดุทั้งหมดยังใช้งานได้ดี</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = expiringSoonItems.map(item => {
                const expiryDate = new Date(item.expiry);
                const daysUntilExpiry = Math.ceil((expiryDate.getTime() - currentDate) / (1000 * 60 * 60 * 24));
                
                // กำหนดสีตามจำนวนวันที่เหลือ
                let statusColor = 'bg-yellow-100 text-yellow-800';
                let statusText = `${daysUntilExpiry} วัน`;
                let urgencyIcon = 'text-yellow-500';
                
                if (daysUntilExpiry <= 7) {
                    statusColor = 'bg-orange-100 text-orange-800';
                    urgencyIcon = 'text-orange-500';
                } else if (daysUntilExpiry <= 14) {
                    statusColor = 'bg-yellow-100 text-yellow-800';
                    urgencyIcon = 'text-yellow-500';
                }
                
                if (daysUntilExpiry === 1) {
                    statusText = 'พรุ่งนี้';
                }

                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0">
                                <svg class="w-5 h-5 ${urgencyIcon}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="min-w-0 flex-1">
                                <p class="text-sm font-medium text-gray-900 truncate">${item.name}</p>
                                <div class="flex items-center space-x-2 mt-1">
                                    <p class="text-xs text-gray-500">${item.category}</p>
                                    <span class="text-gray-300">•</span>
                                    <p class="text-xs text-gray-500">คงเหลือ ${item.quantity} ${item.unit}</p>
                                    <span class="text-gray-300">•</span>
                                    <p class="text-xs text-gray-500">${item.barcode}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-1">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                                ${statusText}
                            </span>
                            <p class="text-xs text-gray-400">${expiryDate.toLocaleDateString('th-TH')}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateExpiredItems() {
            const container = document.getElementById('expired-items');
            if (!container) return;

            const currentDate = Date.now();

            // หาวัสดุหมดอายุแล้ว
            const expiredItems = sampleData.stock.filter(item => {
                if (!item.expiry) return false;
                const expiryDate = new Date(item.expiry).getTime();
                return expiryDate <= currentDate;
            }).sort((a, b) => {
                // เรียงตามวันหมดอายุ (หมดอายุล่าสุดก่อน)
                return new Date(b.expiry).getTime() - new Date(a.expiry).getTime();
            });

            if (expiredItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-sm">ไม่มีวัสดุหมดอายุ</p>
                        <p class="text-xs text-gray-400 mt-1">ไม่มีรายการที่ต้องจัดการ</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = expiredItems.map(item => {
                const expiryDate = new Date(item.expiry);
                const daysExpired = Math.ceil((currentDate - expiryDate.getTime()) / (1000 * 60 * 60 * 24));
                
                let statusText = `หมดอายุแล้ว ${daysExpired} วัน`;
                if (daysExpired === 0) {
                    statusText = 'หมดอายุวันนี้';
                } else if (daysExpired === 1) {
                    statusText = 'หมดอายุเมื่อวาน';
                }

                return `
                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-100">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0">
                                <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="min-w-0 flex-1">
                                <p class="text-sm font-medium text-gray-900 truncate">${item.name}</p>
                                <div class="flex items-center space-x-2 mt-1">
                                    <p class="text-xs text-gray-500">${item.category}</p>
                                    <span class="text-gray-300">•</span>
                                    <p class="text-xs text-gray-500">คงเหลือ ${item.quantity} ${item.unit}</p>
                                    <span class="text-gray-300">•</span>
                                    <p class="text-xs text-gray-500">${item.barcode}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-1">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                ${statusText}
                            </span>
                            <p class="text-xs text-gray-400">${expiryDate.toLocaleDateString('th-TH')}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadRecentRequests() {
            const recentRequestsContainer = document.getElementById('recent-requests');
            
            // เรียงใบคำร้องจากใหม่ไปเก่า
            const sortedRequests = [...sampleData.requests].sort((a, b) => {
                const timeA = a.timestamp || parseInt(a.id.replace('REQ', '')) || 0;
                const timeB = b.timestamp || parseInt(b.id.replace('REQ', '')) || 0;
                return timeB - timeA;
            });
            
            // แสดงเฉพาะ 3 รายการล่าสุด
            const recentRequests = sortedRequests.slice(0, 3);
            
            if (recentRequests.length === 0) {
                recentRequestsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">ไม่มีใบคำร้องล่าสุด</p>';
                return;
            }
            
            recentRequestsContainer.innerHTML = recentRequests.map(request => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${request.id}</p>
                            <p class="text-sm text-gray-500">${request.requesterName || request.name}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            (request.status === 'รออนุมัติ' || request.status === 'pending') ? 'bg-yellow-100 text-yellow-800' :
                            (request.status === 'อนุมัติ' || request.status === 'approved') ? 'bg-green-100 text-green-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${request.status === 'pending' ? 'รอพิจารณา' : request.status}
                        </span>
                        <p class="text-xs text-gray-400 mt-1">${request.date}</p>
                    </div>
                </div>
            `).join('');
        }

        function updateWeeklyStats() {
            const now = new Date();
            const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const startDate = new Date(oneWeekAgo);
            
            // สร้างข้อความช่วงวันที่
            const formatDate = (date) => {
                return date.toLocaleDateString('th-TH', {
                    day: 'numeric',
                    month: 'short'
                }).replace('ม.ค.', 'ม.ค.').replace('ก.พ.', 'ก.พ.').replace('มี.ค.', 'มี.ค.')
                  .replace('เม.ย.', 'เม.ย.').replace('พ.ค.', 'พ.ค.').replace('มิ.ย.', 'มิ.ย.')
                  .replace('ก.ค.', 'ก.ค.').replace('ส.ค.', 'ส.ค.').replace('ก.ย.', 'ก.ย.')
                  .replace('ต.ค.', 'ต.ค.').replace('พ.ย.', 'พ.ย.').replace('ธ.ค.', 'ธ.ค.');
            };
            
            const periodText = `7 วันที่ผ่านมา (${formatDate(startDate)} - ${formatDate(now)})`;
            const weeklyStatsPeriod = document.getElementById('weekly-stats-period');
            if (weeklyStatsPeriod) {
                weeklyStatsPeriod.textContent = periodText;
            }
            
            // กรองประวัติ 7 วันล่าสุด
            const weeklyHistory = sampleData.history.filter(item => {
                const itemTime = item.timestamp || parseInt(item.date) || 0;
                return itemTime > oneWeekAgo;
            });
            
            // นับรายการตามประเภท
            const withdrawCount = weeklyHistory.filter(item => item.type === 'เบิก').length;
            const receiveCount = weeklyHistory.filter(item => item.type === 'รับ').length;
            
            // กรองใบคำร้อง 7 วันล่าสุด
            const weeklyRequests = sampleData.requests.filter(request => {
                const requestTime = request.timestamp || parseInt(request.id.replace('REQ', '')) || 0;
                return requestTime > oneWeekAgo;
            });
            const requestsCount = weeklyRequests.length;
            
            // คำนวณเปอร์เซ็นต์ (สูงสุด 50 รายการ = 100%)
            const maxItems = 50;
            const withdrawPercent = Math.min((withdrawCount / maxItems) * 100, 100);
            const receivePercent = Math.min((receiveCount / maxItems) * 100, 100);
            const requestsPercent = Math.min((requestsCount / maxItems) * 100, 100);
            
            // อัปเดตการแสดงผล
            const withdrawProgress = document.getElementById('withdraw-progress');
            const receiveProgress = document.getElementById('receive-progress');
            const requestsProgress = document.getElementById('requests-progress');
            
            if (withdrawProgress) {
                withdrawProgress.style.width = withdrawPercent + '%';
                document.getElementById('withdraw-count').textContent = withdrawCount;
            }
            
            if (receiveProgress) {
                receiveProgress.style.width = receivePercent + '%';
                document.getElementById('receive-count').textContent = receiveCount;
            }
            
            if (requestsProgress) {
                requestsProgress.style.width = requestsPercent + '%';
                document.getElementById('requests-week-count').textContent = requestsCount;
            }
        }

        function updatePopularItems() {
            const now = new Date();
            const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const startDate = new Date(oneWeekAgo);
            
            // สร้างข้อความช่วงวันที่สำหรับวัสดุยอดนิยม
            const formatDate = (date) => {
                return date.toLocaleDateString('th-TH', {
                    day: 'numeric',
                    month: 'short'
                }).replace('ม.ค.', 'ม.ค.').replace('ก.พ.', 'ก.พ.').replace('มี.ค.', 'มี.ค.')
                  .replace('เม.ย.', 'เม.ย.').replace('พ.ค.', 'พ.ค.').replace('มิ.ย.', 'มิ.ย.')
                  .replace('ก.ค.', 'ก.ค.').replace('ส.ค.', 'ส.ค.').replace('ก.ย.', 'ก.ย.')
                  .replace('ต.ค.', 'ต.ค.').replace('พ.ย.', 'พ.ย.').replace('ธ.ค.', 'ธ.ค.');
            };
            
            const periodText = `7 วันที่ผ่านมา (${formatDate(startDate)} - ${formatDate(now)})`;
            const popularMaterialsPeriod = document.getElementById('popular-materials-period');
            if (popularMaterialsPeriod) {
                popularMaterialsPeriod.textContent = periodText;
            }
            
            // รวบรวมข้อมูลวัสดุที่มีการขอเบิกใน 7 วันล่าสุด
            const itemRequests = {};
            
            // กรองใบคำร้องใน 7 วันล่าสุด
            const recentRequests = sampleData.requests.filter(request => {
                const requestTime = request.timestamp || parseInt(request.id.replace('REQ', '')) || 0;
                return requestTime > oneWeekAgo;
            });
            
            recentRequests.forEach(request => {
                if (request.items && Array.isArray(request.items)) {
                    request.items.forEach(item => {
                        const itemName = item.name || item.item || 'ไม่ระบุ';
                        itemRequests[itemName] = (itemRequests[itemName] || 0) + (item.quantity || 1);
                    });
                }
            });
            
            // เรียงลำดับตามความนิยม
            const sortedItems = Object.entries(itemRequests)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5); // แสดงเฉพาะ 5 อันดับแรก
            
            const popularItemsContainer = document.getElementById('popular-items');
            if (!popularItemsContainer) return;
            
            if (sortedItems.length === 0) {
                popularItemsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">ไม่มีข้อมูลใน 7 วันที่ผ่านมา</p>';
                return;
            }
            
            const maxCount = sortedItems[0][1]; // จำนวนสูงสุด
            
            popularItemsContainer.innerHTML = sortedItems.map(([itemName, count], index) => {
                const percentage = (count / maxCount) * 100;
                const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500'];
                const color = colors[index % colors.length];
                
                return `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0 w-6 h-6 ${color} text-white rounded-full flex items-center justify-center text-xs font-bold">
                            ${index + 1}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium text-gray-900 truncate">${itemName}</span>
                                <span class="text-xs text-gray-500">${count} ครั้ง</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5">
                                <div class="${color} h-1.5 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function startDashboardMonitoring() {
            // หยุดการ monitoring เดิมก่อน
            if (dashboardMonitoringInterval) {
                clearInterval(dashboardMonitoringInterval);
            }
            
            // เริ่มตรวจสอบทุก 5 วินาที
            dashboardMonitoringInterval = setInterval(async () => {
                // ตรวจสอบเฉพาะเมื่อผู้ใช้อยู่ในหน้าแดชบอร์ด
                const dashboardPage = document.getElementById('admin-dashboard');
                if (dashboardPage && !dashboardPage.classList.contains('hidden')) {
                    try {
                        // ตรวจสอบข้อมูลใหม่จาก Firebase
                        const [requestsSnapshot, stockSnapshot, usersSnapshot, staffSnapshot] = await Promise.all([
                            firebase.get(firebase.ref(firebase.database, 'requests')),
                            firebase.get(firebase.ref(firebase.database, 'stock')),
                            firebase.get(firebase.ref(firebase.database, 'users')),
                            firebase.get(firebase.ref(firebase.database, 'staff'))
                        ]);
                        
                        // อัปเดตข้อมูลใน sampleData
                        const firebaseRequests = requestsSnapshot.val() || {};
                        const firebaseStock = stockSnapshot.val() || {};
                        const firebaseUsers = usersSnapshot.val() || {};
                        const firebaseStaff = staffSnapshot.val() || {};
                        
                        sampleData.requests = Object.values(firebaseRequests);
                        sampleData.stock = Object.values(firebaseStock);
                        sampleData.users = Object.values(firebaseUsers);
                        sampleData.staff = Object.values(firebaseStaff);
                        
                        // อัปเดตการแสดงผล
                        updateDashboardStats();
                        loadRecentRequests();
                        updateWeeklyStats();
                        updatePopularItems();
                        updateExpiryItemsLists();
                        
                    } catch (error) {
                        console.log('Error monitoring dashboard:', error);
                        // ไม่แสดง error ให้ผู้ใช้เห็นเพื่อไม่ให้รบกวน
                    }
                }
            }, 5000); // ตรวจสอบทุก 5 วินาที
        }

        function stopDashboardMonitoring() {
            if (dashboardMonitoringInterval) {
                clearInterval(dashboardMonitoringInterval);
                dashboardMonitoringInterval = null;
            }
        }

        // Initialize the app - will be called after Firebase is ready
        function initializeApp() {
            // ตรวจสอบว่าผู้ใช้ล็อกอินอยู่หรือไม่
            if (currentUser) {
                updateUserInfo();
            }
            
            console.log('App initialized');
        }

        // เรียกใช้เมื่อโหลดหน้าเสร็จ
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'95a85fb3c07e2db8',t:'MTc1MTczNDM1Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
